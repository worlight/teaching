<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸ä½æ•¸å­¸ç·´ç¿’ç°¿</title>
    
    <!-- å¼•å…¥ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">

    <style>
        /* --- è®Šæ•¸è¨­å®š --- */
        :root {
            --user-font-size: 26px;
            --line-color: #a4b0be; /* çµ±ä¸€ç·šæ¢é¡è‰² */
        }

        /* --- åŸºç¤è¨­å®š --- */
        body {
            background-color: #f0f2f5;
            font-family: "Lora", "KaiTi", "BiauKai", "DFKai-SB", serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overscroll-behavior: none;
            overflow: auto; 
        }

        /* --- é›™åº•ç·šæ¨£å¼ --- */
        .dbl-ul {
            text-decoration: underline double;
            text-underline-offset: 3px; 
            text-decoration-thickness: 1px;
        }
        
        /* --- å–®åº•ç·šæ¨£å¼ --- */
        .sgl-ul {
            text-decoration: underline;
            text-underline-offset: 3px; 
            text-decoration-thickness: 1px;
        }
        
        /* æ–¹æ ¼å°ˆç”¨æ¨£å¼ */
        .dbl-ul-cell {
            text-decoration: underline double;
            text-underline-offset: 3px;
            text-decoration-thickness: 1px;
        }
        
        .sgl-ul-cell {
            text-decoration: underline;
            text-underline-offset: 3px;
            text-decoration-thickness: 1px;
        }

        /* --- æ•´è¡Œç²—åº•ç·šæ¨£å¼ (New) --- */
        .line-row.row-thick-border {
            border-bottom: 3px solid #000 !important; /* å¼·åˆ¶è¦†è“‹åŸæœ¬çš„æ·ºè‰²ç·š */
        }

        /* --- åˆ†æ•¸æ¨£å¼ --- */
        .fraction-group {
            display: inline-flex;
            align-items: center;
            vertical-align: middle;
            margin: 0 4px;
            user-select: none;
        }
        .frac-integer {
            min-width: 15px;
            text-align: center;
            margin-right: 2px;
            outline: none;
            cursor: text;
        }
        .frac-integer:empty::after {
            content: "";
            display: inline-block;
        }
        .frac-part {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            vertical-align: middle;
        }
        .frac-num {
            border-bottom: 2px solid currentColor;
            padding: 0 2px;
            text-align: center;
            min-width: 15px;
            outline: none;
            line-height: 1.1;
            width: 100%;
            cursor: text;
        }
        .frac-den {
            padding: 0 2px;
            text-align: center;
            min-width: 15px;
            outline: none;
            line-height: 1.1;
            width: 100%;
            cursor: text;
        }
        .frac-integer:focus, .frac-num:focus, .frac-den:focus {
            background-color: rgba(255, 235, 59, 0.3);
        }

        /* --- å¿«æ·éµèªªæ˜ Modal æ¨£å¼ --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            position: relative;
            text-align: left;
        }
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        .close-modal:hover { color: black; }
        .shortcut-list {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
        .shortcut-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .key-badge {
            background: #eee;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-weight: bold;
            border: 1px solid #ccc;
            font-size: 0.9em;
            color: #333;
        }

        /* --- æ§åˆ¶é¢æ¿ --- */
        .controls {
            margin-bottom: 20px;
            text-align: center;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap; 
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 100;
            max-width: 95vw;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px;
            border-radius: 5px;
            background: #f8f9fa;
            flex-wrap: wrap; 
            justify-content: center;
        }

        button, select {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap; 
        }
        
        select {
            background-color: #fff;
            color: #333;
            border: 1px solid #ddd;
            padding-right: 25px; 
        }

        button:hover { opacity: 0.9; transform: translateY(-1px); }

        button.active {
            background-color: #1a73e8;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            font-weight: bold;
        }
        
        /* ç¬¦è™ŸæŒ‰éˆ•è¢«é¸å–çš„æ¨£å¼ */
        button.symbol-btn.active-tool {
            background-color: #d1c4e9;
            color: #4a148c;
            border-color: #7b1fa2;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        button.tool-btn {
            background-color: white;
            color: #555;
            border: 1px solid #ddd;
        }
        button.tool-btn.active {
            background-color: #e8f0fe;
            color: #1967d2;
            border-color: #1967d2;
        }
        button.symbol-btn {
            padding: 5px 10px;
            font-family: "Times New Roman", serif; 
            font-size: 18px;
            min-width: 36px;
            justify-content: center;
            background-color: #fff;
            border: 1px solid #ccc;
            color: #333;
        }
        button.symbol-btn:hover {
            background-color: #e1bee7;
            border-color: #9c27b0;
            color: #4a148c;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }
        .color-dot:hover { transform: scale(1.2); }
        .color-dot.active { border-color: #333; box-shadow: 0 0 0 2px white, 0 0 0 4px #ccc; }

        #save-status {
            font-size: 12px;
            color: #28a745;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.5s;
            font-weight: bold;
            white-space: nowrap;
        }

        /* --- ç¸®æ”¾å®¹å™¨ --- */
        #zoom-wrapper {
            transition: transform 0.1s ease-out;
            transform-origin: top center;
        }

        /* --- ç­†è¨˜æœ¬å®¹å™¨ --- */
        .notebook-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap; 
            align-content: flex-start;
        }

        /* --- å–®é ç´™å¼µ --- */
        .page {
            background-color: white;
            width: 210mm;
            height: 297mm;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            padding: 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-bottom: 20px; 
        }

        /* --- ç¹ªåœ–å±¤ (Canvas) --- */
        .drawing-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            touch-action: none;
            cursor: crosshair;
        }
        
        /* --- æš«å­˜ç¹ªåœ–å±¤ --- */
        .temp-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 25; 
            pointer-events: none; 
        }

        .page.typing-mode .drawing-layer {
            pointer-events: none;
            cursor: default;
        }

        /* --- ç´…è‰²å‚ç›´ç·š --- */
        .red-margin-line {
            position: absolute;
            left: 30mm;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: #ff6b6b;
            z-index: 10; 
            pointer-events: none; 
        }

        /* --- é ‚éƒ¨ç•™ç™½ (Header) --- */
        .page-header {
            height: 12%;
            width: 100%;
            border-bottom: 1px solid var(--line-color);
            position: relative;
            padding: 0;
            display: flex;
            align-items: stretch;
            z-index: 5;
        }
        .header-left, .header-right {
            display: grid;
            align-content: end;
            padding-bottom: 2mm;
            box-sizing: border-box;
            outline: none;
            font-size: 20px;
            color: #333;
        }
        .header-left {
            width: 30mm;
            justify-content: end;
            padding-right: 2mm;
        }
        .header-right {
            flex: 1;
            justify-content: start;
            padding-left: 2mm;
        }

        /* --- ä¸­é–“å…§å®¹å€ --- */
        .page-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            z-index: 5;
        }

        /* --- æ¯ä¸€è¡Œ (Flex å®¹å™¨) --- */
        .line-row {
            flex: 1;
            border-bottom: 1px solid var(--line-color);
            position: relative;
            display: flex; 
            align-items: stretch;
            font-size: var(--user-font-size);
            color: #333;
            line-height: 1.2;
        }

        /* --- é€šç”¨å–®å…ƒæ ¼æ¨£å¼ --- */
        .line-cell {
            outline: none;
            display: flex;
            align-items: center; 
            box-sizing: border-box;
        }
        .line-cell:focus, .header-left:focus, .header-right:focus {
            background-color: rgba(66, 133, 244, 0.05);
        }
        
        /* --- èˆŠç‰ˆå–®è¡Œæ¨£å¼ (é«˜å¹´ç´š) --- */
        .line-row.line-type .line-left {
            width: 30mm; 
            justify-content: flex-end;
            text-align: right;
            padding-right: 2mm; 
            color: #555;
            font-size: 0.9em; 
        }
        .line-row.line-type .line-right {
            flex: 1; 
            padding-left: 2mm; 
            padding-right: 10mm;
        }

        /* --- ç©ºç™½é æ¨£å¼ (ç´”ç™½) --- */
        .page.blank-page .page-header,
        .page.blank-page .red-margin-line {
            display: none !important; 
        }
        
        /* ç©ºç™½é çš„å…§å®¹å€ */
        .blank-sheet {
            width: 100%;
            height: 100%;
            padding: 2cm; 
            box-sizing: border-box;
            outline: none;
            white-space: pre-wrap; 
            overflow: hidden;
            font-size: var(--user-font-size);
            line-height: 1.5;
            color: #333;
            cursor: text;
        }
        .blank-sheet:focus {
            background-color: rgba(66, 133, 244, 0.01);
        }

        /* --- æ–¹æ ¼æ¨£å¼ (ä½å¹´ç´š & å…¨æ–¹æ ¼) --- */
        .grid-row .line-left-grid,
        .grid-row .line-right-main,
        .grid-row .line-right-grid {
            border-right: 1px solid var(--line-color);
        }

        .line-left-grid {
            width: 10mm; 
            justify-content: center;
            color: #555;
        }
        .line-left-grid:nth-of-type(3) {
            border-right: none;
        }

        .line-right-main {
            flex: 1;
            padding-left: 2mm;
            padding-right: 2mm;
        }

        .line-right-grid-group {
            display: flex;
        }

        .line-right-grid {
            width: 10mm; 
            justify-content: center;
        }
        .line-right-grid:last-child {
            border-right: none;
        }
        
        /* --- å…¨æ–¹æ ¼æ¨£å¼ (Full Grid) --- */
        .line-right-full-grid-container {
            display: flex;
            flex: 1;
            overflow: hidden; 
        }
        .line-full-grid-cell {
            width: 10mm;
            min-width: 10mm;
            justify-content: center;
            border-right: 1px solid var(--line-color);
        }
        .line-full-grid-cell:last-child {
            border-right: none; 
        }

        .page-footer {
            height: 10%;
            width: 100%;
            position: relative;
        }

        .footer-text {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 20px;
        }

        @media print {
            body { background: white; padding: 0; display: block; overflow: visible; }
            .controls { display: none; }
            #zoom-wrapper { transform: none !important; width: auto !important; height: auto !important; margin: 0 !important; }
            .notebook-container { gap: 0; display: block; }
            .page { 
                box-shadow: none; 
                page-break-after: always; 
                margin: 0 auto; 
                margin-bottom: 0;
                float: none;
            }
            canvas { display: block; }
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div class="controls">
        <!-- æ¨¡å¼åˆ‡æ› -->
        <div class="control-group">
            <button id="btn-type" class="active" onclick="setMode('type')">âŒ¨ï¸ æ‰“å­—</button>
            <button id="btn-draw" onclick="setMode('draw')">âœï¸ æ‰‹å¯«</button>
            <button onclick="toggleMathSymbols()" style="background-color: #673ab7; color: white;" title="é¡¯ç¤º/éš±è—æ•¸å­¸ç¬¦è™Ÿ">ğŸ”¢ æ•¸å­¸ç¬¦è™Ÿ</button>
        </div>

        <!-- æ•¸å­¸ç¬¦è™Ÿå·¥å…·åˆ— -->
        <div class="control-group" id="math-tools" style="display: none; width: 100%; background: #f3e5f5; border: 1px solid #e1bee7; margin-top: 5px;">
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol('+')">+</button>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol('-')">-</button>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol('Ã—')">Ã—</button>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol('Ã·')">Ã·</button>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol('=')">=</button>
            <div style="width: 1px; height: 15px; background: #999; margin: 0 5px;"></div>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol('>')">&gt;</button>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol('<')">&lt;</button>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol('â‰¥')">â‰¥</button>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol('â‰¤')">â‰¤</button>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol('â‰ ')">â‰ </button>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol('â‰ˆ')">â‰ˆ</button>
            <div style="width: 1px; height: 15px; background: #999; margin: 0 5px;"></div>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol('(')">(</button>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol(')')">)</button>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol('.')">.</button>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol('%')">%</button>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertSymbol('Â²')" title="å¹³æ–¹">xÂ²</button>
            <!-- åˆ†æ•¸æŒ‰éˆ• -->
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertFraction(false)" title="åˆ†æ•¸ (åˆ†å­/åˆ†æ¯)">x/y</button>
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="insertFraction(true)" title="å¸¶åˆ†æ•¸ (æ•´æ•¸ åˆ†å­/åˆ†æ¯)">1 x/y</button>
            <!-- å–®åº•ç·šç¬¦è™Ÿ -->
            <button class="tool-btn symbol-btn" id="btn-sgl-ul" onmousedown="event.preventDefault()" onclick="insertSingleUnderline()" title="å–®åº•ç·š (é–‹é—œæ¨¡å¼)">
                <span style="text-decoration: underline;">U</span>
            </button>
            <!-- é›™åº•ç·šç¬¦è™Ÿ -->
            <button class="tool-btn symbol-btn" id="btn-dbl-ul" onmousedown="event.preventDefault()" onclick="insertDoubleUnderline()" title="é›™åº•ç·š (é–‹é—œæ¨¡å¼)">
                <span style="text-decoration: underline double;">U</span>
            </button>
            <!-- æ•´è¡Œç²—ç·šç¬¦è™Ÿ (New) -->
            <button class="tool-btn symbol-btn" id="btn-row-line" onmousedown="event.preventDefault()" onclick="toggleRowLine()" title="æ•´è¡Œç²—ç·š (Alt + L)">
                <div style="width: 100%; height: 8px; border-bottom: 3px solid black;"></div>
            </button>
            <!-- å¿«æ·éµèªªæ˜æŒ‰éˆ• -->
            <button class="tool-btn symbol-btn" onmousedown="event.preventDefault()" onclick="showShortcutHelp()" title="å¿«æ·éµèªªæ˜" style="background-color: #e3f2fd; color: #1565c0; font-size: 14px;">âŒ¨ï¸ èªªæ˜</button>
        </div>

        <!-- ç¹ªåœ–å·¥å…· -->
        <div class="control-group" id="draw-tools" style="display: none;">
            <div class="color-dot active" style="background: black;" onclick="setPenColor('black', this)"></div>
            <div class="color-dot" style="background: #ea4335;" onclick="setPenColor('#ea4335', this)"></div>
            <div class="color-dot" style="background: #1a73e8;" onclick="setPenColor('#1a73e8', this)"></div>
            
            <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
            
            <button class="tool-btn active" id="tool-pen" onclick="setTool('pen')" title="ä¸€èˆ¬ç­†åˆ·">ç­†åˆ·</button>
            <button class="tool-btn" id="tool-eraser" onclick="setTool('eraser')" title="æ©¡çš®æ“¦">æ©¡çš®æ“¦</button>
            
            <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
            
            <!-- åœ–å½¢æ’å…¥æŒ‰éˆ• -->
            <button class="tool-btn" id="tool-rect" onclick="setTool('rect')" title="æ’å…¥çŸ©å½¢ (æ‹–æ›³ç¹ªè£½)">â¬œ</button>
            <button class="tool-btn" id="tool-circle" onclick="setTool('circle')" title="æ’å…¥åœ“å½¢ (æ‹–æ›³ç¹ªè£½)">âšª</button>
            <button class="tool-btn" id="tool-triangle" onclick="setTool('triangle')" title="æ’å…¥ä¸‰è§’å½¢ (æ‹–æ›³ç¹ªè£½)">â–³</button>

            <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
            <label style="font-size: 14px;">ç²—ç´°:</label>
            <input type="range" min="1" max="10" value="2" style="width: 60px;" oninput="updateLineWidth(this.value)" title="èª¿æ•´ç­†ç•«ç²—ç´°">

            <!-- Undo/Redo -->
            <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
            <button class="tool-btn" onclick="undo()" title="å¾©åŸ (Ctrl+Z)">â†©ï¸ å¾©åŸ</button>
            <button class="tool-btn" onclick="redo()" title="é‡åš (Ctrl+Y)">â†ªï¸ é‡åš</button>

            <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
            <button class="tool-btn" onclick="clearCanvas()" style="color: #ea4335;">æ¸…ç©ºç­†è·¡</button>
        </div>
        
        <!-- å­—é«”èˆ‡ç¸®æ”¾ -->
        <div class="control-group" id="type-tools">
            <label style="font-size: 14px;">å­—é«”:</label>
            <input type="range" min="12" max="40" value="26" oninput="updateFontSize(this.value)">
        </div>

        <div class="control-group" style="border-left: 1px solid #ddd; padding-left: 5px;">
            <label style="font-size: 14px;">ğŸ” ç¸®æ”¾: <span id="zoom-val">100%</span></label>
            <input type="range" min="0.5" max="1.5" step="0.1" value="1" oninput="setZoom(this.value)">
        </div>

        <!-- æ ¼å¼é¸æ“‡ -->
        <div class="control-group">
            <div style="display: flex; align-items: center; background: #e8f0fe; border-radius: 5px; padding: 0 5px;">
                <label for="notebook-type" style="font-size: 14px; color: #1a73e8; margin-right: 5px;">æ ¼å¼:</label>
                <select id="notebook-type" onchange="updateNotebookType(this.value)" style="background: transparent; border: none; color: #1a73e8; font-weight: bold; padding: 8px 0; cursor: pointer;">
                    <option value="line">é«˜å¹´ç´š (å–®è¡Œ)</option>
                    <option value="grid">ä½å¹´ç´š (æ–¹æ ¼)</option>
                    <option value="full-grid">å…¨æ–¹æ ¼ (Full Grid)</option>
                    <option value="blank">ç´”ç©ºç™½ (Blank)</option>
                </select>
            </div>
            <button onclick="addNewPage()" style="background-color: #34a853;">â• åŠ é </button>
        </div>

        <!-- æª”æ¡ˆæ“ä½œèˆ‡è¨­å®š -->
        <div class="control-group">
            <button onclick="toggleFullScreen()" id="btn-fullscreen" style="background-color: #5f6368;">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="white" style="vertical-align: middle;"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg> å…¨è¢å¹•
            </button>
            <button onclick="window.print()" style="background-color: #5f6368;">ğŸ–¨ï¸ PDF</button>
            <button onclick="resetNotebook()" style="background-color: #ea4335;">ğŸ”„ é‡ç½®</button>
            <button onclick="clearAllText()" style="background-color: #fbbc04; color: #333;">ğŸ—‘ï¸ æ–‡å­—</button>
        </div>

        <!-- å„²å­˜æ§åˆ¶ -->
        <div class="control-group">
            <button onclick="manualSave()" style="background-color: #1a73e8;" title="ç«‹å³å„²å­˜">ğŸ’¾ å„²å­˜</button>
            <div style="display: flex; align-items: center; background: #fff; border: 1px solid #ddd; border-radius: 5px; padding: 5px 10px; margin-left: 5px;">
                <input type="checkbox" id="auto-save-check" onchange="toggleAutoSave(this.checked)">
                <label for="auto-save-check" style="margin-left: 5px; font-size: 14px; cursor: pointer; color: #555;">è‡ªå‹•å„²å­˜</label>
            </div>
            <span id="save-status"></span>
        </div>
    </div>

    <div id="zoom-wrapper">
        <div class="notebook-container" id="notebook-container">
            <!-- å…§å®¹æœƒç”± JS è‡ªå‹•ç”Ÿæˆæˆ–è¼‰å…¥ -->
        </div>
    </div>

    <!-- å¿«æ·éµèªªæ˜ Modal -->
    <div id="shortcut-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeShortcutHelp()">&times;</span>
            <h3 style="margin-top: 0; color: #1a73e8; border-bottom: 2px solid #e8f0fe; padding-bottom: 10px;">âŒ¨ï¸ æ•¸å­¸ç¬¦è™Ÿå¿«æ·éµ</h3>
            <ul class="shortcut-list">
                <li><span>ä¹˜è™Ÿ (Ã—)</span> <span><span class="key-badge">Alt</span> + <span class="key-badge">x</span></span></li>
                <li><span>é™¤è™Ÿ (Ã·)</span> <span><span class="key-badge">Alt</span> + <span class="key-badge">/</span></span></li>
                <li><span>åˆ†æ•¸ (x/y)</span> <span><span class="key-badge">Alt</span> + <span class="key-badge">f</span></span></li>
                <li><span>å¸¶åˆ†æ•¸ (1 x/y)</span> <span><span class="key-badge">Alt</span> + <span class="key-badge">Shift</span> + <span class="key-badge">F</span></span></li>
                <li><span>å¤§æ–¼ç­‰æ–¼ (â‰¥)</span> <span><span class="key-badge">Alt</span> + <span class="key-badge">&gt;</span></span></li>
                <li><span>å°æ–¼ç­‰æ–¼ (â‰¤)</span> <span><span class="key-badge">Alt</span> + <span class="key-badge">&lt;</span></span></li>
                <li><span>å¹³æ–¹ (Â²)</span> <span><span class="key-badge">Alt</span> + <span class="key-badge">2</span></span></li>
                <li><span>ç´„ç­‰æ–¼ (â‰ˆ)</span> <span><span class="key-badge">Alt</span> + <span class="key-badge">`</span> (é “è™Ÿéµ)</span></li>
                <li><span>æ•´è¡Œç²—ç·š</span> <span><span class="key-badge">Alt</span> + <span class="key-badge">L</span></span></li>
            </ul>
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="closeShortcutHelp()" style="background-color: #4285f4; color: white; padding: 8px 25px; border-radius: 20px;">çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

    <script>
        // === å…¨åŸŸè®Šæ•¸ ===
        let currentMode = 'type'; 
        let currentTool = 'pen'; 
        let currentColor = 'black';
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let lineWidth = 2;
        let currentZoom = 1;
        let activeCanvasId = null; 
        let defaultPageType = 'line'; 
        let isAutoSaveEnabled = false; 
        let lastFocusedInput = null; 
        let shapeStartX = 0;
        let shapeStartY = 0;

        const undoStacks = {};
        const redoStacks = {};
        const MAX_HISTORY = 20;

        let saveTimeout;
        const STORAGE_KEY = 'digital_notebook_data_v6';

        // === 1. åˆå§‹åŒ– ===
        window.onload = function() {
            if (!loadData()) {
                addNewPage(defaultPageType, false);
                addNewPage(defaultPageType, false);
            } else {
                document.getElementById('notebook-type').value = defaultPageType;
            }
            document.addEventListener('keydown', handleShortcuts);
            document.addEventListener('keydown', handleMathHotkeys);
            
            // ç›£è½ Focus èˆ‡ Selection Change æ›´æ–°æŒ‰éˆ•
            document.addEventListener('focusin', (e) => {
                const t = e.target;
                if (t.getAttribute('contenteditable') === 'true' || t.tagName === 'BUTTON') {
                    if (t.getAttribute('contenteditable') === 'true') {
                        lastFocusedInput = t;
                        updateButtonStates();
                    }
                }
            });
            
            document.addEventListener('mouseup', updateButtonStates);
            document.addEventListener('keyup', updateButtonStates);
            
            window.onclick = function(event) {
                const modal = document.getElementById('shortcut-modal');
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        };
        
        // === æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ ===
        function updateButtonStates() {
            const btnDbl = document.getElementById('btn-dbl-ul');
            const btnSgl = document.getElementById('btn-sgl-ul');
            const btnRowLine = document.getElementById('btn-row-line');
            if (!btnDbl || !btnSgl || !btnRowLine) return;
            
            btnDbl.classList.remove('active-tool');
            btnSgl.classList.remove('active-tool');
            btnRowLine.classList.remove('active-tool');

            if (!lastFocusedInput) return;
            
            // æ•´è¡Œç²—ç·šæª¢æŸ¥
            const row = lastFocusedInput.closest('.line-row');
            if (row && row.classList.contains('row-thick-border')) {
                btnRowLine.classList.add('active-tool');
            }

            // æ–¹æ ¼æ¨¡å¼æª¢æŸ¥
            if (isGridCell(lastFocusedInput)) {
                if (lastFocusedInput.classList.contains('dbl-ul-cell')) {
                    btnDbl.classList.add('active-tool');
                } else if (lastFocusedInput.classList.contains('sgl-ul-cell')) {
                    btnSgl.classList.add('active-tool');
                }
                return;
            }

            // ä¸€èˆ¬æ–‡å­—æ¨¡å¼æª¢æŸ¥
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                let node = sel.anchorNode;
                while(node && node !== lastFocusedInput && node !== document.body) {
                    if (node.nodeType === 1) {
                        if (node.classList.contains('dbl-ul')) {
                            btnDbl.classList.add('active-tool');
                            break;
                        } else if (node.classList.contains('sgl-ul')) {
                            btnSgl.classList.add('active-tool');
                            break;
                        }
                    }
                    node = node.parentNode;
                }
            }
        }

        // ... (Math Tools functions) ...
        function handleMathHotkeys(e) {
            if (!lastFocusedInput || !e.altKey) return;
            let symbol = '';
            if (e.key === 'x' || e.key === 'X') symbol = 'Ã—';
            else if (e.key === '/') symbol = 'Ã·';
            else if (!e.shiftKey && e.key === 'f') {
                e.preventDefault(); insertFraction(false); return;
            }
            else if (e.shiftKey && (e.key === 'F' || e.key === 'f')) {
                e.preventDefault(); insertFraction(true); return;
            }
            else if (e.key === '>') symbol = 'â‰¥';
            else if (e.key === '<') symbol = 'â‰¤';
            else if (e.key === '2') symbol = 'Â²';
            else if (e.key === '`') symbol = 'â‰ˆ';
            else if (e.key === 'l' || e.key === 'L') { // æ•´è¡Œç²—ç·š Hotkey
                e.preventDefault(); toggleRowLine(); return;
            }

            if (symbol) {
                e.preventDefault();
                insertSymbol(symbol);
            }
        }

        function toggleMathSymbols() {
            const mathTools = document.getElementById('math-tools');
            mathTools.style.display = mathTools.style.display === 'none' ? 'flex' : 'none';
        }
        
        function showShortcutHelp() {
            document.getElementById('shortcut-modal').style.display = 'flex';
        }
        function closeShortcutHelp() {
            document.getElementById('shortcut-modal').style.display = 'none';
        }

        function insertSymbol(symbol) {
            if (!lastFocusedInput) { alert("è«‹å…ˆé»é¸è¦è¼¸å…¥çš„æ ¼å­"); return; }
            lastFocusedInput.focus();
            document.execCommand('insertText', false, symbol);
            triggerAutoSave();
            
            if (isGridCell(lastFocusedInput)) {
                setTimeout(() => {
                    if (lastFocusedInput.innerText.trim().length > 0) {
                        moveToNextCell(lastFocusedInput);
                    }
                }, 10);
            }
        }
        
        // === æ•´è¡Œç²—ç·šåŠŸèƒ½ (New) ===
        function toggleRowLine() {
            if (!lastFocusedInput) { alert("è«‹å…ˆé»é¸è¦ç•«ç·šçš„è¡Œ"); return; }
            const row = lastFocusedInput.closest('.line-row');
            if (row) {
                row.classList.toggle('row-thick-border');
                updateButtonStates();
                triggerAutoSave();
            }
        }

        // === æ’å…¥/ç§»é™¤ å–®åº•ç·šåŠŸèƒ½ ===
        function insertSingleUnderline() {
            if (!lastFocusedInput) { alert("è«‹å…ˆé»é¸è¦è¼¸å…¥çš„æ ¼å­"); return; }
            lastFocusedInput.focus();
            const sel = window.getSelection();
            if (!sel.rangeCount) return;

            if (isGridCell(lastFocusedInput)) {
                lastFocusedInput.classList.remove('dbl-ul-cell'); 
                lastFocusedInput.classList.toggle('sgl-ul-cell');
                updateButtonStates();
                triggerAutoSave();
                return;
            }
            
            applyUnderlineLogic(sel, 'sgl-ul');
        }

        // === æ’å…¥/ç§»é™¤ é›™åº•ç·šåŠŸèƒ½ ===
        function insertDoubleUnderline() {
            if (!lastFocusedInput) { alert("è«‹å…ˆé»é¸è¦è¼¸å…¥çš„æ ¼å­"); return; }
            lastFocusedInput.focus();
            const sel = window.getSelection();
            if (!sel.rangeCount) return;

            if (isGridCell(lastFocusedInput)) {
                lastFocusedInput.classList.remove('sgl-ul-cell'); 
                lastFocusedInput.classList.toggle('dbl-ul-cell');
                updateButtonStates();
                triggerAutoSave();
                return;
            }
            
            applyUnderlineLogic(sel, 'dbl-ul');
        }

        // === å…±ç”¨åº•ç·šé‚è¼¯ ===
        function applyUnderlineLogic(sel, className) {
            const otherClass = className === 'sgl-ul' ? 'dbl-ul' : 'sgl-ul';
            let node = sel.anchorNode;
            let existingSpan = null;

            while(node && node !== lastFocusedInput) {
                if (node.nodeType === 1 && (node.classList.contains(className) || node.classList.contains(otherClass))) {
                    existingSpan = node;
                    break;
                }
                node = node.parentNode;
            }

            if (existingSpan) {
                if (existingSpan.classList.contains(className)) {
                    const range = sel.getRangeAt(0);
                    if (range.collapsed && isCursorAtEnd(range, existingSpan)) {
                        moveCursorOut(existingSpan, range);
                    } else {
                        unwrapSpan(existingSpan);
                    }
                } else {
                    existingSpan.classList.remove(otherClass);
                    existingSpan.classList.add(className);
                }
            } else {
                wrapSelectionWithClass(className, sel);
            }
            triggerAutoSave();
            updateButtonStates();
        }

        function isCursorAtEnd(range, span) {
            if (range.endContainer === span) {
                return range.endOffset === span.childNodes.length;
            }
            if (range.endContainer.parentNode === span) {
                return range.endOffset === range.endContainer.textContent.length && range.endContainer === span.lastChild;
            }
            return false;
        }

        function moveCursorOut(span, range) {
            const zws = document.createTextNode("\u200B");
            if (span.nextSibling) {
                span.parentNode.insertBefore(zws, span.nextSibling);
            } else {
                span.parentNode.appendChild(zws);
            }
            range.setStart(zws, 1);
            range.setEnd(zws, 1);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }

        function unwrapSpan(span) {
            const parent = span.parentNode;
            while (span.firstChild) {
                parent.insertBefore(span.firstChild, span);
            }
            parent.removeChild(span);
        }

        function wrapSelectionWithClass(className, sel) {
            const range = sel.getRangeAt(0);
            const span = document.createElement("span");
            span.className = className;
            
            if (range.collapsed) {
                const text = document.createTextNode("\u200B");
                span.appendChild(text);
                range.insertNode(span);
                range.setStart(text, 1);
                range.setEnd(text, 1);
            } else {
                span.appendChild(range.extractContents());
                range.insertNode(span);
            }
            sel.removeAllRanges();
            sel.addRange(range);
        }


        // === æ’å…¥åˆ†æ•¸åŠŸèƒ½ ===
        function insertFraction(isMixed) {
            if (!lastFocusedInput) { alert("è«‹å…ˆé»é¸è¦è¼¸å…¥çš„æ ¼å­"); return; }
            lastFocusedInput.focus();
            const container = document.createElement("span");
            container.className = "fraction-group";
            container.contentEditable = "false"; 
            
            let integerPart = null;
            if (isMixed) {
                integerPart = document.createElement("span");
                integerPart.className = "frac-integer";
                integerPart.contentEditable = "true";
            }
            
            const fracPart = document.createElement("span");
            fracPart.className = "frac-part";
            
            const numerator = document.createElement("span");
            numerator.className = "frac-num";
            numerator.contentEditable = "true";
            
            const denominator = document.createElement("span");
            denominator.className = "frac-den";
            denominator.contentEditable = "true";
            
            fracPart.appendChild(numerator);
            fracPart.appendChild(denominator);
            if (integerPart) container.appendChild(integerPart);
            container.appendChild(fracPart);
            
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                const range = sel.getRangeAt(0);
                range.deleteContents();
                range.insertNode(container);
                const space = document.createTextNode("\u00A0");
                range.setStartAfter(container);
                range.insertNode(space);
                const newRange = document.createRange();
                if (integerPart) {
                    newRange.selectNodeContents(integerPart);
                } else {
                    newRange.selectNodeContents(numerator);
                }
                newRange.collapse(false);
                sel.removeAllRanges();
                sel.addRange(newRange);
            }
            triggerAutoSave();
        }

        function isGridCell(el) {
            return el.classList.contains('line-left-grid') || 
                   el.classList.contains('line-right-grid') || 
                   el.classList.contains('line-full-grid-cell');
        }

        // ... (Rest of the code: generateLinesHTML, updateNotebookType, addNewPage, initSingleCanvas, Drawing, Undo/Redo, etc. remain same) ...
        function generateLinesHTML(type) {
            if (type === 'blank') {
                return '<div class="blank-sheet" contenteditable="true"></div>';
            }
            let html = '';
            for (let i = 0; i < 23; i++) {
                if (type === 'line') {
                    html += `
                    <div class="line-row line-type">
                        <div class="line-cell line-left" contenteditable="true"></div>
                        <div class="line-cell line-right" contenteditable="true"></div>
                    </div>`;
                } else if (type === 'grid') {
                    html += `
                    <div class="line-row grid-row">
                        <div class="line-cell line-left-grid" contenteditable="true"></div>
                        <div class="line-cell line-left-grid" contenteditable="true"></div>
                        <div class="line-cell line-left-grid" contenteditable="true"></div>
                        <div class="line-cell line-right-main" contenteditable="true"></div>
                        <div class="line-right-grid-group">
                            ${'<div class="line-cell line-right-grid" contenteditable="true"></div>'.repeat(6)}
                        </div>
                    </div>`;
                } else if (type === 'full-grid') {
                    html += `
                    <div class="line-row grid-row">
                        <div class="line-cell line-left-grid" contenteditable="true"></div>
                        <div class="line-cell line-left-grid" contenteditable="true"></div>
                        <div class="line-cell line-left-grid" contenteditable="true"></div>
                        <div class="line-right-full-grid-container">
                            ${'<div class="line-cell line-full-grid-cell" contenteditable="true"></div>'.repeat(17)}
                        </div>
                    </div>`;
                }
            }
            return html;
        }

        function updateNotebookType(type) {
            defaultPageType = type;
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                const oldType = page.getAttribute('data-page-type');
                if (oldType === type) return;
                let allText = "";
                if (oldType === 'blank') {
                    const sheet = page.querySelector('.blank-sheet');
                    if (sheet) allText = sheet.innerText;
                } else {
                    const oldRows = page.querySelectorAll('.line-row');
                    const lines = [];
                    oldRows.forEach(row => {
                        let rowText = row.innerText.replace(/\n/g, " "); 
                        lines.push(rowText); 
                    });
                    allText = lines.join('\n');
                }
                page.setAttribute('data-page-type', type);
                const redLine = page.querySelector('.red-margin-line');
                const header = page.querySelector('.page-header');
                if (type === 'blank') {
                    page.classList.add('blank-page');
                    if(redLine) redLine.style.display = 'none';
                    if(header) header.style.borderBottom = 'none';
                } else {
                    page.classList.remove('blank-page');
                    if(redLine) redLine.style.display = 'block';
                    if(header) header.style.borderBottom = '1px solid var(--line-color)';
                }
                const contentDiv = page.querySelector('.page-content');
                contentDiv.innerHTML = generateLinesHTML(type);
                if (type === 'blank') {
                    const sheet = contentDiv.querySelector('.blank-sheet');
                    if(sheet) sheet.innerText = allText;
                } else {
                    const lines = allText.split('\n');
                    const newRows = contentDiv.querySelectorAll('.line-row');
                    newRows.forEach((row, idx) => {
                        if (idx < lines.length) {
                            const firstInput = row.querySelector('[contenteditable="true"]');
                            if (firstInput) firstInput.innerText = lines[idx];
                        }
                    });
                }
            });
            triggerAutoSave(); 
        }

        function addNewPage(type, restoreMode = false) {
            const pageType = type || defaultPageType;
            const container = document.getElementById('notebook-container');
            const currentPages = document.querySelectorAll('.page').length;
            const newPageNum = currentPages + 1;
            const canvasId = `canvas-${newPageNum}`;
            const tempCanvasId = `temp-canvas-${newPageNum}`; 
            const linesId = `lines-${newPageNum}`;
            const pageId = `page-${newPageNum}`;

            const pageDiv = document.createElement('div');
            pageDiv.className = `page ${currentMode === 'type' ? 'typing-mode' : ''}`;
            if (pageType === 'blank') pageDiv.classList.add('blank-page');
            pageDiv.id = pageId;
            pageDiv.setAttribute('data-page-num', newPageNum);
            pageDiv.setAttribute('data-page-type', pageType);
            
            const redLineDisplay = pageType === 'blank' ? 'none' : 'block';
            const headerBorder = pageType === 'blank' ? 'none' : '1px solid var(--line-color)';

            pageDiv.innerHTML = `
                <canvas id="${canvasId}" class="drawing-layer"></canvas>
                <canvas id="${tempCanvasId}" class="temp-layer"></canvas>
                <div class="red-margin-line" style="display: ${redLineDisplay}"></div>
                <div class="page-header" style="border-bottom: ${headerBorder}">
                    <div class="header-left" contenteditable="true"></div>
                    <div class="header-right" contenteditable="true"></div>
                </div>
                <div class="page-content" id="${linesId}">
                    ${generateLinesHTML(pageType)}
                </div>
                <div class="page-footer"><div class="footer-text">- ${newPageNum} -</div></div>
            `;

            container.appendChild(pageDiv);
            undoStacks[canvasId] = [];
            redoStacks[canvasId] = [];
            const newCanvas = document.getElementById(canvasId);
            const newTempCanvas = document.getElementById(tempCanvasId);
            initSingleCanvas(newCanvas, newTempCanvas);
            setZoom(currentZoom);
            if (!restoreMode) {
                pageDiv.scrollIntoView({ behavior: 'smooth' });
                triggerAutoSave();
            }
        }

        function initSingleCanvas(canvas, tempCanvas) {
            if(canvas.getAttribute('data-init') === 'true') return;
            const parent = canvas.parentElement;
            const rect = parent.getBoundingClientRect();
            const scale = Math.min(window.devicePixelRatio || 2, 2); 
            
            canvas.width = rect.width * scale;
            canvas.height = rect.height * scale;
            const ctx = canvas.getContext('2d');
            ctx.scale(scale, scale);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            if(tempCanvas) {
                tempCanvas.width = rect.width * scale;
                tempCanvas.height = rect.height * scale;
                const tCtx = tempCanvas.getContext('2d');
                tCtx.scale(scale, scale);
                tCtx.lineCap = 'round';
                tCtx.lineJoin = 'round';
            }

            addDrawingEvents(canvas, tempCanvas); 
            canvas.setAttribute('data-init', 'true');
        }

        function saveState(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            if (!undoStacks[canvasId]) undoStacks[canvasId] = [];
            undoStacks[canvasId].push(imageData);
            if (undoStacks[canvasId].length > MAX_HISTORY) undoStacks[canvasId].shift(); 
            redoStacks[canvasId] = [];
        }

        function undo() {
            const targetId = activeCanvasId || 'canvas-1';
            const stack = undoStacks[targetId];
            const redoStack = redoStacks[targetId];
            if (stack && stack.length > 0) {
                const canvas = document.getElementById(targetId);
                const ctx = canvas.getContext('2d');
                const currentData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                redoStack.push(currentData);
                const previousData = stack.pop();
                ctx.putImageData(previousData, 0, 0);
                triggerAutoSave();
            }
        }

        function redo() {
            const targetId = activeCanvasId || 'canvas-1';
            const stack = undoStacks[targetId];
            const redoStack = redoStacks[targetId];
            if (redoStack && redoStack.length > 0) {
                const canvas = document.getElementById(targetId);
                const ctx = canvas.getContext('2d');
                const currentData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                stack.push(currentData);
                const nextData = redoStack.pop();
                ctx.putImageData(nextData, 0, 0);
                triggerAutoSave();
            }
        }

        // Updated Drawing Events for Shapes & Pen
        function addDrawingEvents(canvas, tempCanvas) {
            const ctx = canvas.getContext('2d');
            const tCtx = tempCanvas ? tempCanvas.getContext('2d') : null;
            const canvasId = canvas.id;
            
            const startDraw = (e) => {
                if (currentMode !== 'draw') return;
                activeCanvasId = canvasId;
                
                const { x, y } = getPos(e, canvas);
                [lastX, lastY] = [x, y];
                [shapeStartX, shapeStartY] = [x, y];
                isDrawing = true;

                // Save state before drawing
                saveState(canvasId);
                
                if (currentTool === 'pen' || currentTool === 'eraser') {
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                }
            };
            
            const draw = (e) => {
                if (!isDrawing || currentMode !== 'draw') return;
                if(e.type.includes('touch')) e.preventDefault(); 
                
                const { x, y } = getPos(e, canvas);
                
                // Normal Drawing
                if (currentTool === 'pen' || currentTool === 'eraser') {
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    if (currentTool === 'eraser') {
                        ctx.globalCompositeOperation = 'destination-out';
                        ctx.lineWidth = 20; 
                    } else {
                        ctx.globalCompositeOperation = 'source-over';
                        ctx.strokeStyle = currentColor;
                        ctx.lineWidth = lineWidth; 
                    }
                    ctx.stroke();
                    [lastX, lastY] = [x, y];
                }
                // Shape Drawing (on temp layer)
                else if (['rect', 'circle', 'triangle'].includes(currentTool) && tCtx) {
                    // Clear temp layer
                    tCtx.save();
                    tCtx.setTransform(1, 0, 0, 1, 0, 0);
                    tCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                    tCtx.restore();

                    tCtx.beginPath();
                    tCtx.strokeStyle = currentColor;
                    tCtx.lineWidth = lineWidth;
                    
                    const width = x - shapeStartX;
                    const height = y - shapeStartY;

                    if (currentTool === 'rect') {
                        tCtx.rect(shapeStartX, shapeStartY, width, height);
                    } else if (currentTool === 'circle') {
                        tCtx.beginPath();
                        tCtx.ellipse(shapeStartX + width/2, shapeStartY + height/2, Math.abs(width)/2, Math.abs(height)/2, 0, 0, 2 * Math.PI);
                    } else if (currentTool === 'triangle') {
                        tCtx.beginPath();
                        tCtx.moveTo(shapeStartX + width/2, shapeStartY); 
                        tCtx.lineTo(shapeStartX, shapeStartY + height); 
                        tCtx.lineTo(shapeStartX + width, shapeStartY + height); 
                        tCtx.closePath();
                    }
                    tCtx.stroke();
                }
            };
            
            const stopDraw = (e) => {
                if (!isDrawing) return;
                isDrawing = false;

                // Commit shape to main canvas
                if (['rect', 'circle', 'triangle'].includes(currentTool) && tCtx) {
                    const { x, y } = getPos(e, canvas);
                    
                    // Clear temp
                    tCtx.save();
                    tCtx.setTransform(1, 0, 0, 1, 0, 0);
                    tCtx.clearRect(0, 0, tempCanvas.width, tempCanvas.height);
                    tCtx.restore();

                    // Draw on Main
                    ctx.beginPath();
                    ctx.strokeStyle = currentColor;
                    ctx.lineWidth = lineWidth;
                    ctx.globalCompositeOperation = 'source-over';

                    const width = x - shapeStartX;
                    const height = y - shapeStartY;

                    if (currentTool === 'rect') {
                        ctx.rect(shapeStartX, shapeStartY, width, height);
                    } else if (currentTool === 'circle') {
                        ctx.beginPath();
                        ctx.ellipse(shapeStartX + width/2, shapeStartY + height/2, Math.abs(width)/2, Math.abs(height)/2, 0, 0, 2 * Math.PI);
                    } else if (currentTool === 'triangle') {
                        ctx.beginPath();
                        ctx.moveTo(shapeStartX + width/2, shapeStartY);
                        ctx.lineTo(shapeStartX, shapeStartY + height);
                        ctx.lineTo(shapeStartX + width, shapeStartY + height);
                        ctx.closePath();
                    }
                    ctx.stroke();
                }
                triggerAutoSave(); 
            };

            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseout', stopDraw);
            canvas.addEventListener('touchstart', startDraw, {passive: false});
            canvas.addEventListener('touchmove', draw, {passive: false});
            canvas.addEventListener('touchend', stopDraw);
        }

        function getPos(e, canvas) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            if (e.changedTouches && e.changedTouches.length > 0) {
                clientX = e.changedTouches[0].clientX;
                clientY = e.changedTouches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            return { 
                x: (clientX - rect.left) / currentZoom, 
                y: (clientY - rect.top) / currentZoom 
            };
        }

        function handleShortcuts(e) {
            if (currentMode === 'draw' && (e.ctrlKey || e.metaKey)) {
                if (e.key === 'z') { e.preventDefault(); undo(); } 
                else if (e.key === 'y') { e.preventDefault(); redo(); }
            }
        }

        function toggleAutoSave(checked) {
            isAutoSaveEnabled = checked;
            const status = document.getElementById('save-status');
            if (checked) {
                status.style.opacity = '1';
                status.innerText = 'è‡ªå‹•å„²å­˜å·²é–‹å•Ÿ';
                status.style.color = '#28a745';
                triggerAutoSave(); 
                setTimeout(() => { status.style.opacity = '0'; }, 2000);
            } else {
                status.style.opacity = '1';
                status.innerText = 'è‡ªå‹•å„²å­˜å·²é—œé–‰';
                status.style.color = '#ea4335';
                setTimeout(() => { status.style.opacity = '0'; }, 2000);
            }
        }
        function triggerAutoSave() {
            if (!isAutoSaveEnabled) return;
            const status = document.getElementById('save-status');
            status.style.opacity = '0.5';
            status.innerText = 'è‡ªå‹•å„²å­˜ä¸­...';
            status.style.color = '#28a745';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => { performSave(true); }, 1000); 
        }
        function manualSave() { performSave(false); }
        function performSave(isAuto) {
            const pagesData = [];
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                const pageId = page.id;
                const type = page.getAttribute('data-page-type') || 'line';
                const headerHTML = page.querySelector('.page-header') ? page.querySelector('.page-header').innerHTML : '';
                const contentHTML = page.querySelector('.page-content').innerHTML; 
                const canvas = page.querySelector('.drawing-layer');
                const canvasData = canvas.toDataURL();
                pagesData.push({ id: pageId, type: type, header: headerHTML, content: contentHTML, drawing: canvasData });
            });
            const data = {
                version: 7, 
                notebookType: defaultPageType, 
                zoom: currentZoom,
                fontSize: getComputedStyle(document.documentElement).getPropertyValue('--user-font-size'),
                pages: pagesData
            };
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                const status = document.getElementById('save-status');
                status.style.opacity = '1';
                status.style.color = '#28a745';
                status.innerText = isAuto ? 'ğŸ’¾ å·²è‡ªå‹•å„²å­˜' : 'ğŸ’¾ å·²æ‰‹å‹•å„²å­˜';
                setTimeout(() => { status.style.opacity = '0'; }, 2000);
            } catch (e) {
                console.error('Storage full', e);
                alert('âš ï¸ è­¦å‘Šï¼šå„²å­˜ç©ºé–“å·²æ»¿ï¼Œç„¡æ³•å„²å­˜ã€‚');
            }
        }
        function loadData() {
            const json = localStorage.getItem(STORAGE_KEY);
            if (!json) return false;
            try {
                const data = JSON.parse(json);
                if (data.zoom) setZoom(data.zoom);
                if (data.fontSize) document.documentElement.style.setProperty('--user-font-size', data.fontSize);
                if (data.notebookType) defaultPageType = data.notebookType; 
                data.pages.forEach(pageData => {
                    addNewPage(pageData.type, true); 
                    const pages = document.querySelectorAll('.page');
                    const currentPage = pages[pages.length - 1];
                    if (currentPage.querySelector('.page-header')) {
                        currentPage.querySelector('.page-header').innerHTML = pageData.header;
                    }
                    currentPage.querySelector('.page-content').innerHTML = pageData.content;
                    const canvas = currentPage.querySelector('.drawing-layer');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.onload = function() {
                        ctx.save();
                        ctx.setTransform(1, 0, 0, 1, 0, 0);
                        ctx.drawImage(img, 0, 0);
                        ctx.restore();
                        saveState(canvas.id); 
                    };
                    img.src = pageData.drawing;
                });
                return true;
            } catch (e) {
                console.error('Load failed', e);
                return false;
            }
        }
        function resetNotebook() {
            if (confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒåˆªé™¤æ‰€æœ‰çš„é é¢ã€æ–‡å­—å’Œç­†è·¡ï¼Œä¸¦ä¸”é‡æ–°é–‹å§‹ã€‚\n\nç¢ºå®šè¦é‡ç½®å—ï¼Ÿ")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
        function setZoom(val) {
            val = parseFloat(val);
            currentZoom = val;
            const zoomDisplay = document.getElementById('zoom-val');
            if (zoomDisplay) zoomDisplay.innerText = Math.round(val * 100) + '%';
            const wrapper = document.getElementById('zoom-wrapper');
            const container = document.getElementById('notebook-container');
            if (wrapper) wrapper.style.transform = `scale(${val})`;
            if (container && wrapper) {
                const originalHeight = container.offsetHeight; 
                const originalWidth = container.offsetWidth;
                wrapper.style.marginBottom = (originalHeight * (val - 1)) + 'px';
                const scaledWidth = originalWidth * val;
                if (scaledWidth > window.innerWidth) {
                    document.body.style.minWidth = scaledWidth + 'px';
                } else {
                    document.body.style.minWidth = 'auto';
                }
            }
        }
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-type').classList.toggle('active', mode === 'type');
            document.getElementById('btn-draw').classList.toggle('active', mode === 'draw');
            
            const drawTools = document.getElementById('draw-tools');
            const typeTools = document.getElementById('type-tools');
            const mathToolsBtn = document.querySelector('button[onclick="toggleMathSymbols()"]');
            
            if (mode === 'draw') {
                drawTools.style.display = 'flex';
                typeTools.style.display = 'none';
                if(mathToolsBtn) mathToolsBtn.style.display = 'none'; 
                document.getElementById('math-tools').style.display = 'none';
            } else {
                drawTools.style.display = 'none';
                typeTools.style.display = 'flex';
                if(mathToolsBtn) mathToolsBtn.style.display = 'inline-block';
            }
            
            const allPages = document.querySelectorAll('.page');
            allPages.forEach(page => {
                if (mode === 'type') page.classList.add('typing-mode');
                else page.classList.remove('typing-mode');
            });
        }
        function setPenColor(color, btn) {
            currentColor = color;
            document.querySelectorAll('.color-dot').forEach(dot => dot.classList.remove('active'));
            btn.classList.add('active');
        }
        function setTool(tool) {
            currentTool = tool;
            document.getElementById('tool-pen').classList.toggle('active', tool === 'pen');
            document.getElementById('tool-eraser').classList.toggle('active', tool === 'eraser');
            document.getElementById('tool-rect').classList.toggle('active', tool === 'rect');
            document.getElementById('tool-circle').classList.toggle('active', tool === 'circle');
            document.getElementById('tool-triangle').classList.toggle('active', tool === 'triangle');
        }
        function clearCanvas() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ‰‹å¯«ç­†è·¡å—ï¼Ÿ")) {
                const allCanvases = document.querySelectorAll('.drawing-layer');
                allCanvases.forEach(canvas => {
                    const ctx = canvas.getContext('2d');
                    ctx.save();
                    ctx.setTransform(1, 0, 0, 1, 0, 0); 
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.restore();
                    saveState(canvas.id);
                });
                triggerAutoSave();
            }
        }
        function clearAllText() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¼¸å…¥æ–‡å­—å—ï¼Ÿ")) {
                document.querySelectorAll('.line-cell, .header-left, .header-right, .blank-sheet').forEach(div => {
                    div.innerText = '';
                    div.classList.remove('dbl-ul-cell');
                    div.classList.remove('sgl-ul-cell');
                });
                triggerAutoSave();
            }
        }
        function updateFontSize(val) {
            document.documentElement.style.setProperty('--user-font-size', val + 'px');
            triggerAutoSave();
        }
        function updateLineWidth(val) { lineWidth = parseInt(val); }

        document.addEventListener('compositionstart', (e) => {
            if (isGridCell(e.target)) e.target.isComposing = true;
        });
        document.addEventListener('compositionend', (e) => {
            const target = e.target;
            if (isGridCell(target)) {
                target.isComposing = false;
                checkAndLimitText(target);
                if (target.innerText.trim().length > 0) moveToNextCell(target);
            }
        });
        document.addEventListener('input', (e) => {
            const target = e.target;
            if (isGridCell(target)) {
                if (!target.isComposing) {
                    checkAndLimitText(target);
                    if (target.innerText.trim().length > 0) moveToNextCell(target);
                }
                triggerAutoSave();
            } else if (target.classList.contains('line-left') || 
                       target.classList.contains('line-right') || 
                       target.classList.contains('line-right-main') || 
                       target.classList.contains('header-left') || 
                       target.classList.contains('header-right') ||
                       target.classList.contains('blank-sheet')) {
                triggerAutoSave();
            }
        });
        function checkAndLimitText(element) {
            let text = element.innerText;
            text = text.replace(/[\n\r]/g, '');
            if (text.length > 1) {
                element.innerText = text.substring(0, 1);
                const range = document.createRange();
                const sel = window.getSelection();
                if (element.childNodes.length > 0) {
                    range.selectNodeContents(element);
                    range.collapse(false);
                    sel.removeAllRanges();
                    sel.addRange(range);
                }
            } else if (element.innerText !== text) element.innerText = text;
        }
        function moveToNextCell(target) {
            const currentRow = target.closest('.line-row');
            let cells = [];
            if (target.classList.contains('line-left-grid')) cells = Array.from(currentRow.querySelectorAll('.line-left-grid'));
            else if (target.classList.contains('line-right-grid')) cells = Array.from(currentRow.querySelectorAll('.line-right-grid'));
            else if (target.classList.contains('line-full-grid-cell')) cells = Array.from(currentRow.querySelectorAll('.line-full-grid-cell'));
            else return;
            const idx = cells.indexOf(target);
            if (idx < cells.length - 1) cells[idx + 1].focus();
            else {
                const nextRow = currentRow.nextElementSibling;
                if (nextRow && nextRow.classList.contains('line-row')) {
                    const selector = target.classList.contains('line-left-grid') ? '.line-left-grid' : 
                                     target.classList.contains('line-right-grid') ? '.line-right-grid' : '.line-full-grid-cell';
                    const nextCells = nextRow.querySelectorAll(selector);
                    if (nextCells.length > 0) nextCells[0].focus();
                } else {
                    const page = currentRow.closest('.page');
                    const nextPage = page.nextElementSibling;
                    if (nextPage && nextPage.classList.contains('page')) {
                        const selector = target.classList.contains('line-left-grid') ? '.line-left-grid' : 
                                     target.classList.contains('line-right-grid') ? '.line-right-grid' : '.line-full-grid-cell';
                        const firstInput = nextPage.querySelector(selector);
                        if (firstInput) firstInput.focus();
                    }
                }
            }
        }
        document.addEventListener('keydown', function(e) {
            const target = e.target;
            const isLineCell = target.classList.contains('line-cell');
            const isHeader = target.classList.contains('header-left') || target.classList.contains('header-right');
            if (!isLineCell && !isHeader) return;
            if (e.key === ' ' && isGridCell(target)) {
                e.preventDefault();
                moveToNextCell(target);
                return;
            }
            if (e.key === 'Enter') {
                e.preventDefault();
                if (isHeader) {
                     const page = target.closest('.page');
                     const firstCell = page.querySelector('.line-cell');
                     if (firstCell) firstCell.focus();
                     return;
                }
                const currentRow = target.closest('.line-row');
                const nextRow = currentRow.nextElementSibling;
                if (nextRow && nextRow.classList.contains('line-row')) {
                    const allCellsInRow = Array.from(currentRow.querySelectorAll('.line-cell'));
                    const cellIndex = allCellsInRow.indexOf(target);
                    const allCellsInNextRow = Array.from(nextRow.querySelectorAll('.line-cell'));
                    const targetCell = allCellsInNextRow[cellIndex] || allCellsInNextRow[allCellsInNextRow.length - 1];
                    if (targetCell) targetCell.focus();
                }
                return;
            }
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                e.preventDefault();
                if (isHeader) {
                    if (e.key === 'ArrowDown') {
                        const page = target.closest('.page');
                        const firstCell = page.querySelector('.line-cell');
                        if (firstCell) firstCell.focus();
                    }
                    return;
                }
                const currentRow = target.closest('.line-row');
                const allCellsInRow = Array.from(currentRow.querySelectorAll('.line-cell'));
                const cellIndex = allCellsInRow.indexOf(target);
                let targetRow;
                if (e.key === 'ArrowUp') {
                    targetRow = currentRow.previousElementSibling;
                    if (!targetRow || !targetRow.classList.contains('line-row')) {
                        const page = target.closest('.page');
                        if (target.getBoundingClientRect().left < page.getBoundingClientRect().left + page.offsetWidth / 2) {
                             page.querySelector('.header-left').focus();
                        } else {
                             page.querySelector('.header-right').focus();
                        }
                        return;
                    }
                } else { 
                     targetRow = currentRow.nextElementSibling;
                }
                if (targetRow && targetRow.classList.contains('line-row')) {
                    const allCellsInTargetRow = Array.from(targetRow.querySelectorAll('.line-cell'));
                    const targetCell = allCellsInTargetRow[cellIndex] || allCellsInTargetRow[allCellsInTargetRow.length - 1];
                    if (targetCell) targetCell.focus();
                }
                return;
            }
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                const sel = window.getSelection();
                if (!sel.rangeCount || sel.type !== 'Caret') return;
                const len = target.innerText.length;
                const start = (sel.anchorOffset === 0);
                const end = (sel.anchorOffset === len);
                if (isHeader) {
                    if (target.classList.contains('header-right') && e.key === 'ArrowLeft' && start) {
                        e.preventDefault(); target.parentElement.querySelector('.header-left').focus();
                    }
                    if (target.classList.contains('header-left') && e.key === 'ArrowRight' && end) {
                        e.preventDefault(); target.parentElement.querySelector('.header-right').focus();
                    }
                    return;
                }
                const currentRow = target.closest('.line-row');
                const allCellsInRow = Array.from(currentRow.querySelectorAll('.line-cell'));
                const cellIndex = allCellsInRow.indexOf(target);
                if (e.key === 'ArrowLeft' && start) {
                    if (cellIndex > 0) {
                        e.preventDefault();
                        allCellsInRow[cellIndex - 1].focus();
                    }
                }
                if (e.key === 'ArrowRight' && end) {
                    if (cellIndex < allCellsInRow.length - 1) {
                        e.preventDefault();
                        allCellsInRow[cellIndex + 1].focus();
                    }
                }
            }
        });
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => console.log(err));
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }
    </script>

</body>
</html>
