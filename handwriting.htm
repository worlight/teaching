<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸ä½ç­†è¨˜æœ¬ - æ‰‹å¯«å¼·åŒ–ç‰ˆ</title>
    <style>
        /* --- è®Šæ•¸è¨­å®š --- */
        :root {
            --user-font-size: 26px; /* é è¨­å­—é«”å¤§å° */
        }

        /* --- åŸºç¤è¨­å®š --- */
        body {
            background-color: #f0f2f5;
            font-family: "KaiTi", "BiauKai", "DFKai-SB", serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overscroll-behavior: none;
            overflow: auto; 
        }

        /* --- æ§åˆ¶é¢æ¿ --- */
        .controls {
            margin-bottom: 20px;
            text-align: center;
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
            border-radius: 5px;
            background: #f8f9fa;
        }

        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        button:hover { opacity: 0.9; transform: translateY(-1px); }

        button.active {
            background-color: #1a73e8;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            font-weight: bold;
        }

        button.tool-btn {
            background-color: white;
            color: #555;
            border: 1px solid #ddd;
        }
        
        button.tool-btn.active {
            background-color: #e8f0fe;
            color: #1967d2;
            border-color: #1967d2;
        }

        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }
        .color-dot:hover { transform: scale(1.2); }
        .color-dot.active { border-color: #333; box-shadow: 0 0 0 2px white, 0 0 0 4px #ccc; }


        /* --- ç¸®æ”¾å®¹å™¨ --- */
        #zoom-wrapper {
            transition: transform 0.1s ease-out;
            transform-origin: top center;
        }

        /* --- ç­†è¨˜æœ¬å®¹å™¨ --- */
        .notebook-container {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        /* --- å–®é ç´™å¼µ --- */
        .page {
            background-color: white;
            width: 210mm;
            height: 297mm;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            padding: 0;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- ç¹ªåœ–å±¤ (Canvas) --- */
        .drawing-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            touch-action: none;
            cursor: crosshair;
        }

        .page.typing-mode .drawing-layer {
            pointer-events: none;
            cursor: default;
        }

        /* --- ç´…è‰²å‚ç›´ç·š --- */
        .red-margin-line {
            position: absolute;
            left: 30mm;
            top: 0;
            bottom: 0;
            width: 1px;
            background-color: #ff6b6b;
            z-index: 10;
            pointer-events: none; 
        }

        /* --- é ‚éƒ¨ç•™ç™½ (Header) --- */
        .page-header {
            height: 12%;
            width: 100%;
            border-bottom: 1px solid #a4b0be;
            position: relative;
            padding: 0;
            display: flex;
            align-items: stretch;
            z-index: 5;
        }
        
        /* Header å·¦å´ (ç´…ç·šå·¦é‚Š) */
        .header-left {
            width: 30mm;
            display: flex;
            align-items: flex-end; /* æ–‡å­—é ä¸‹ */
            justify-content: flex-end; /* æ–‡å­—é å³ (è²¼è¿‘ç´…ç·š) */
            padding-right: 2mm;
            padding-bottom: 2mm;
            box-sizing: border-box;
            outline: none;
            font-size: 20px;
            color: #333;
        }

        /* Header å³å´ (ç´…ç·šå³é‚Š) */
        .header-right {
            flex: 1;
            display: flex;
            align-items: flex-end; /* æ–‡å­—é ä¸‹ */
            justify-content: flex-start; /* æ–‡å­—é å·¦ */
            padding-left: 2mm;
            padding-bottom: 2mm;
            box-sizing: border-box;
            outline: none;
            font-size: 20px;
            color: #333;
        }

        /* --- ä¸­é–“å…§å®¹å€ --- */
        .page-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            z-index: 5;
        }

        /* --- æ¯ä¸€è¡Œ (Flex å®¹å™¨) --- */
        .line-row {
            flex: 1;
            border-bottom: 1px solid #a4b0be;
            position: relative;
            display: flex; 
            align-items: stretch;
            font-size: var(--user-font-size);
            color: #333;
            line-height: 1.2;
        }
        
        /* å·¦å´è¼¸å…¥å€ */
        .line-left {
            width: 30mm; 
            display: flex;
            align-items: end;
            justify-content: flex-end;
            text-align: right;
            padding-right: 2mm; 
            box-sizing: border-box;
            outline: none;
            color: #555;
            font-size: 0.9em; 
        }

        /* å³å´è¼¸å…¥å€ */
        .line-right {
            flex: 1; 
            display: flex;
            align-items: end;
            padding-left: 2mm; 
            padding-right: 10mm;
            outline: none;
        }

        /* èšç„¦æ•ˆæœ */
        .line-left:focus, .line-right:focus, .header-left:focus, .header-right:focus {
            background-color: rgba(66, 133, 244, 0.05);
        }

        .page-footer {
            height: 10%;
            width: 100%;
            position: relative;
        }

        .footer-text {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 20px;
        }

        @media print {
            body { background: white; padding: 0; display: block; overflow: visible; }
            .controls { display: none; }
            #zoom-wrapper { transform: none !important; width: auto !important; height: auto !important; margin: 0 !important; }
            .notebook-container { gap: 0; display: block; }
            .page { 
                box-shadow: none; 
                page-break-after: always; 
                margin: 0 auto; 
                float: none;
            }
            canvas { display: block; }
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

    <div class="controls">
        <!-- æ¨¡å¼åˆ‡æ› -->
        <div class="control-group">
            <button id="btn-type" class="active" onclick="setMode('type')">âŒ¨ï¸ æ‰“å­—</button>
            <button id="btn-draw" onclick="setMode('draw')">âœï¸ æ‰‹å¯«</button>
        </div>

        <!-- ç¹ªåœ–å·¥å…· (é è¨­éš±è—) -->
        <div class="control-group" id="draw-tools" style="display: none;">
            <div class="color-dot active" style="background: black;" onclick="setPenColor('black', this)"></div>
            <div class="color-dot" style="background: #ea4335;" onclick="setPenColor('#ea4335', this)"></div>
            <div class="color-dot" style="background: #1a73e8;" onclick="setPenColor('#1a73e8', this)"></div>
            <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
            <button class="tool-btn active" id="tool-pen" onclick="setTool('pen')">ç­†åˆ·</button>
            <button class="tool-btn" id="tool-eraser" onclick="setTool('eraser')">æ©¡çš®æ“¦</button>
            
            <!-- æ–°å¢ï¼šç­†ç•«ç²—ç´°èª¿æ•´ -->
            <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
            <label style="font-size: 14px;">ç²—ç´°:</label>
            <input type="range" min="1" max="10" value="2" style="width: 60px;" oninput="updateLineWidth(this.value)" title="èª¿æ•´ç­†ç•«ç²—ç´°">

            <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
            <button class="tool-btn" onclick="clearCanvas()" style="color: #ea4335;">æ¸…ç©ºç­†è·¡</button>
        </div>
        
        <!-- å­—é«”å¤§å° (æ‰“å­—æ¨¡å¼é¡¯ç¤º) -->
        <div class="control-group" id="type-tools">
            <label style="font-size: 14px;">å­—é«”:</label>
            <input type="range" min="12" max="40" value="26" oninput="updateFontSize(this.value)">
        </div>

        <!-- ç¸®æ”¾æ§åˆ¶ -->
        <div class="control-group" style="border-left: 1px solid #ddd; padding-left: 10px;">
            <label style="font-size: 14px;">ğŸ” ç¸®æ”¾: <span id="zoom-val">100%</span></label>
            <input type="range" min="0.5" max="1.5" step="0.1" value="1" oninput="setZoom(this.value)">
        </div>

        <!-- åŠŸèƒ½æŒ‰éˆ• -->
        <div class="control-group">
            <button onclick="toggleFullScreen()" id="btn-fullscreen" style="background-color: #5f6368;">
                <svg viewBox="0 0 24 24" width="14" height="14" fill="white" style="vertical-align: middle;"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg> å…¨è¢å¹•
            </button>
            <button onclick="window.print()" style="background-color: #5f6368;">ğŸ–¨ï¸ PDF</button>
            <button onclick="clearAllText()" style="background-color: #ea4335;">ğŸ—‘ï¸</button>
        </div>
    </div>

    <div id="zoom-wrapper">
        <div class="notebook-container" id="notebook-container">
            <!-- å·¦é  -->
            <div class="page typing-mode" id="page-left">
                <canvas id="canvas-left" class="drawing-layer"></canvas>
                <div class="red-margin-line"></div>
                <div class="page-header">
                    <div class="header-left" contenteditable="true"></div>
                    <div class="header-right" contenteditable="true"></div>
                </div>
                <div class="page-content" id="lines-left"></div>
                <div class="page-footer"><div class="footer-text">- 1 -</div></div>
            </div>

            <!-- å³é  -->
            <div class="page typing-mode" id="page-right">
                <canvas id="canvas-right" class="drawing-layer"></canvas>
                <div class="red-margin-line"></div>
                <div class="page-header">
                    <div class="header-left" contenteditable="true"></div>
                    <div class="header-right" contenteditable="true"></div>
                </div>
                <div class="page-content" id="lines-right"></div>
                <div class="page-footer"><div class="footer-text">- 2 -</div></div>
            </div>
        </div>
    </div>

    <script>
        // === 1. åˆå§‹åŒ–æ ¼ç·š ===
        function generateLines(containerId) {
            const container = document.getElementById(containerId);
            for (let i = 0; i < 23; i++) {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'line-row';
                const leftInput = document.createElement('div');
                leftInput.className = 'line-left';
                leftInput.contentEditable = "true";
                const rightInput = document.createElement('div');
                rightInput.className = 'line-right';
                rightInput.contentEditable = "true";
                lineDiv.appendChild(leftInput);
                lineDiv.appendChild(rightInput);
                container.appendChild(lineDiv);
            }
        }

        // === 2. è®Šæ•¸è¨­å®š ===
        let currentMode = 'type'; 
        let currentTool = 'pen'; 
        let currentColor = 'black';
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let lineWidth = 2;
        let currentZoom = 1;

        const canvases = ['canvas-left', 'canvas-right'].map(id => document.getElementById(id));
        const pages = document.querySelectorAll('.page');

        // === 3. åˆå§‹åŒ– ===
        window.onload = function() {
            generateLines('lines-left');
            generateLines('lines-right');
            initCanvases();
            setZoom(1); 
        };
        
        function initCanvases() {
            canvases.forEach(canvas => {
                const parent = canvas.parentElement;
                const rect = parent.getBoundingClientRect();
                const scale = Math.max(window.devicePixelRatio || 2, 3); 
                
                canvas.width = rect.width * scale;
                canvas.height = rect.height * scale;
                
                const ctx = canvas.getContext('2d');
                ctx.scale(scale, scale);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                addDrawingEvents(canvas);
            });
        }

        // === 4. ç¸®æ”¾åŠŸèƒ½ ===
        function setZoom(val) {
            val = parseFloat(val);
            currentZoom = val;
            
            const zoomDisplay = document.getElementById('zoom-val');
            if (zoomDisplay) {
                zoomDisplay.innerText = Math.round(val * 100) + '%';
            }
            
            const wrapper = document.getElementById('zoom-wrapper');
            const container = document.getElementById('notebook-container');
            
            if (wrapper) wrapper.style.transform = `scale(${val})`;
            
            if (container && wrapper) {
                const originalWidth = container.offsetWidth; 
                const originalHeight = container.offsetHeight;
                
                wrapper.style.marginBottom = (originalHeight * (val - 1)) + 'px';
                wrapper.style.marginTop = (originalHeight * (val - 1) * 0.1) + 'px';
                
                const scaledWidth = originalWidth * val;
                if (scaledWidth > window.innerWidth) {
                    document.body.style.minWidth = scaledWidth + 'px';
                } else {
                    document.body.style.minWidth = 'auto';
                }
            }
        }

        // === 5. ç¹ªåœ–äº‹ä»¶ ===
        function addDrawingEvents(canvas) {
            const ctx = canvas.getContext('2d');
            
            const startDraw = (e) => {
                if (currentMode !== 'draw') return;
                isDrawing = true;
                const { x, y } = getPos(e, canvas);
                [lastX, lastY] = [x, y];
            };
            
            const draw = (e) => {
                if (!isDrawing || currentMode !== 'draw') return;
                if(e.type.includes('touch')) e.preventDefault(); 
                
                const { x, y } = getPos(e, canvas);
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(x, y);
                
                if (currentTool === 'eraser') {
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.lineWidth = 20; 
                } else {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.strokeStyle = currentColor;
                    ctx.lineWidth = lineWidth; 
                }
                ctx.stroke();
                [lastX, lastY] = [x, y];
            };
            
            const stopDraw = () => isDrawing = false;

            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseout', stopDraw);
            canvas.addEventListener('touchstart', startDraw, {passive: false});
            canvas.addEventListener('touchmove', draw, {passive: false});
            canvas.addEventListener('touchend', stopDraw);
        }

        function getPos(e, canvas) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            
            if (e.changedTouches) {
                clientX = e.changedTouches[0].clientX;
                clientY = e.changedTouches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            return { 
                x: (clientX - rect.left) / currentZoom, 
                y: (clientY - rect.top) / currentZoom 
            };
        }

        // === 6. ä»‹é¢æ§åˆ¶ ===
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btn-type').classList.toggle('active', mode === 'type');
            document.getElementById('btn-draw').classList.toggle('active', mode === 'draw');
            document.getElementById('draw-tools').style.display = mode === 'draw' ? 'flex' : 'none';
            document.getElementById('type-tools').style.display = mode === 'type' ? 'flex' : 'none';
            pages.forEach(page => {
                if (mode === 'type') {
                    page.classList.add('typing-mode');
                } else {
                    page.classList.remove('typing-mode');
                }
            });
        }

        function setPenColor(color, btn) {
            currentColor = color;
            setTool('pen'); 
            document.querySelectorAll('.color-dot').forEach(dot => dot.classList.remove('active'));
            btn.classList.add('active');
        }

        function setTool(tool) {
            currentTool = tool;
            document.getElementById('tool-pen').classList.toggle('active', tool === 'pen');
            document.getElementById('tool-eraser').classList.toggle('active', tool === 'eraser');
        }

        function clearCanvas() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ‰‹å¯«ç­†è·¡å—ï¼Ÿ")) {
                canvases.forEach(canvas => {
                    const ctx = canvas.getContext('2d');
                    ctx.save();
                    ctx.setTransform(1, 0, 0, 1, 0, 0); 
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.restore();
                });
            }
        }
        
        function clearAllText() {
            if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¼¸å…¥æ–‡å­—å—ï¼Ÿ")) {
                document.querySelectorAll('.line-left, .line-right, .header-left, .header-right').forEach(div => {
                    div.innerText = '';
                });
            }
        }

        function updateFontSize(val) {
            document.documentElement.style.setProperty('--user-font-size', val + 'px');
        }
        
        // æ–°å¢ï¼šæ›´æ–°ç­†ç•«ç²—ç´°
        function updateLineWidth(val) {
            lineWidth = parseInt(val);
        }

        // === 7. å…¨é¢éµç›¤å°èˆªé‚è¼¯ ===
        document.addEventListener('keydown', function(e) {
            const target = e.target;
            const isLineLeft = target.classList.contains('line-left');
            const isLineRight = target.classList.contains('line-right');
            const isHeaderLeft = target.classList.contains('header-left');
            const isHeaderRight = target.classList.contains('header-right');
            
            // æª¢æŸ¥æ˜¯å¦åœ¨ä»»ä½•å¯ç·¨è¼¯å€åŸŸ
            if (!isLineLeft && !isLineRight && !isHeaderLeft && !isHeaderRight) return;

            // --- Enter éµ ---
            if (e.key === 'Enter') {
                e.preventDefault(); 
                
                // 1. å¦‚æœåœ¨æ¨™é¡Œå€ï¼ŒEnter è·³åˆ°è©²é ç¬¬ä¸€è¡Œ
                if (isHeaderLeft || isHeaderRight) {
                     const page = target.closest('.page');
                     const firstLine = page.querySelector(isHeaderLeft ? '.line-left' : '.line-right');
                     if (firstLine) firstLine.focus();
                     return;
                }

                // 2. å¦‚æœåœ¨å…§å®¹å€ï¼ŒEnter è·³ä¸‹ä¸€è¡Œ (è·¨é )
                const searchClass = isLineLeft ? '.line-left' : '.line-right';
                const allInputs = document.querySelectorAll(searchClass);
                const currentIndex = Array.from(allInputs).indexOf(target);
                const nextInput = allInputs[currentIndex + 1];
                if (nextInput) {
                    nextInput.focus();
                }
                return;
            }

            // --- ä¸Šä¸‹éµ ---
            if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                // å¼·åˆ¶è·³è½‰ï¼Œé¿å…åœ¨å–®è¡Œå…§ä¸Šä¸‹ç§»å‹•æ¸¸æ¨™ (é€šå¸¸å–®è¡Œä¸éœ€è¦)
                e.preventDefault();

                // 1. æ¨™é¡Œå€çš„ä¸Šä¸‹ç§»å‹•
                if (isHeaderLeft || isHeaderRight) {
                    if (e.key === 'ArrowDown') {
                        // æ¨™é¡Œ -> è©²é ç¬¬ä¸€è¡Œ
                        const page = target.closest('.page');
                        const firstLine = page.querySelector(isHeaderLeft ? '.line-left' : '.line-right');
                        if (firstLine) firstLine.focus();
                    }
                    return;
                }

                // 2. å…§å®¹å€çš„ä¸Šä¸‹ç§»å‹•
                const searchClass = isLineLeft ? '.line-left' : '.line-right';
                
                // å…ˆæª¢æŸ¥æ˜¯å¦ç‚ºè©²é çš„ç¬¬ä¸€è¡Œ (è‹¥æ˜¯ï¼ŒæŒ‰ä¸Š -> è·³å›æ¨™é¡Œ)
                if (e.key === 'ArrowUp') {
                    const page = target.closest('.page');
                    const allInPage = Array.from(page.querySelectorAll(searchClass));
                    if (allInPage[0] === target) {
                        const header = page.querySelector(isLineLeft ? '.header-left' : '.header-right');
                        if (header) header.focus();
                        return;
                    }
                }

                // æ¨™æº–è¡Œé–“ç§»å‹•
                const allInputs = Array.from(document.querySelectorAll(searchClass));
                const currentIndex = allInputs.indexOf(target);
                let targetInput;
                if (e.key === 'ArrowUp') {
                    targetInput = allInputs[currentIndex - 1];
                } else {
                    targetInput = allInputs[currentIndex + 1];
                }
                if (targetInput) {
                    targetInput.focus();
                }
                return;
            }

            // --- å·¦å³éµ (éœ€åŒ…å«æ¨™é¡Œå€) ---
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                const selection = window.getSelection();
                if (!selection.rangeCount || selection.type !== 'Caret') return;
                const textLength = target.innerText.length;
                const isAtStart = (selection.anchorOffset === 0);
                const isAtEnd = (selection.anchorOffset === textLength); 

                // æ¨™é¡Œå€å·¦å³è·³è½‰
                if (isHeaderRight && e.key === 'ArrowLeft' && isAtStart) {
                    e.preventDefault();
                    const sibling = target.parentElement.querySelector('.header-left');
                    if (sibling) sibling.focus();
                    return;
                }
                if (isHeaderLeft && e.key === 'ArrowRight' && isAtEnd) {
                    e.preventDefault();
                    const sibling = target.parentElement.querySelector('.header-right');
                    if (sibling) sibling.focus();
                    return;
                }

                // å…§å®¹å€å·¦å³è·³è½‰ (åŸæœ¬é‚è¼¯)
                if (isLineRight && e.key === 'ArrowLeft' && isAtStart) {
                    e.preventDefault();
                    const sibling = target.parentElement.querySelector('.line-left');
                    if (sibling) sibling.focus();
                }
                if (isLineLeft && e.key === 'ArrowRight' && isAtEnd) {
                    e.preventDefault();
                    const sibling = target.parentElement.querySelector('.line-right');
                    if (sibling) sibling.focus();
                }
            }
        });

        // === 8. å…¨è¢å¹•åŠŸèƒ½ ===
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error enabling full-screen mode: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        document.addEventListener('fullscreenchange', (event) => {
            const btn = document.getElementById('btn-fullscreen');
            if (!btn) return; 

            if (document.fullscreenElement) {
                btn.innerHTML = '<svg viewBox="0 0 24 24" width="14" height="14" fill="white" style="vertical-align: middle;"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-14v3h3v2h-5V5z"/></svg> é€€å‡º';
            } else {
                btn.innerHTML = '<svg viewBox="0 0 24 24" width="14" height="14" fill="white" style="vertical-align: middle;"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg> å…¨è¢å¹•';
            }
        });

    </script>

</body>
</html>
