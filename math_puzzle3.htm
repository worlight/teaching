<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ æ¸›æ•¸ç›´å¼å¡«å……</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Confetti å™´ç™¼å‹•ç•«åº« -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- è¨­å®š Tailwind é…ç½®ï¼Œä½¿ç”¨ Inter å­—é«”å’Œè¼ƒå¤§çš„åŸºç¤å­—é«” -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                        mono: ['Inconsolata', 'Consolas', 'monospace'], // ä½¿ç”¨ç­‰å¯¬å­—é«”ç¢ºä¿ç›´å¼å°é½Š
                    },
                    fontSize: {
                        '5xl': '3.5rem', // æ”¾å¤§å­—é«”æ–¹ä¾¿å°å­¸ç”Ÿè§€çœ‹
                        '6xl': '4rem',
                    }
                }
            }
        }
    </script>
    <style>
        /* ç¢ºä¿æ¯å€‹å–®å…ƒæ ¼ï¼ˆdigit cellï¼‰çš„å¯¬åº¦å’Œé«˜åº¦ä¸€è‡´ */
        .digit-cell {
            width: 5rem;
            height: 5rem; /* ä¿æŒå–®å…ƒæ ¼ç‚ºæ–¹å½¢ */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem; /* ä½¿ç”¨ class å®šç¾©çš„ 5xl å¤§å° */
            line-height: 1;
            padding: 0;
            margin-right: 0.1rem; 
            margin-bottom: 1.5rem; 
            border-radius: 0.5rem;
        }
        
        .num2-row .digit-cell {
            margin-bottom: 0; 
        }
        
        .result-row .digit-cell {
            margin-bottom: 0; 
            margin-top: 0.3rem; 
        }

        /* æ•¸å­—è¼¸å…¥æ¡†æ¨£å¼ */
        .digit-input {
            width: 100%;
            height: 100%;
            text-align: center;
            background-color: #FEEBC8; 
            border: 4px solid #F6AD55; 
            outline: none;
            transition: all 0.2s ease-in-out;
            font-size: 3.5rem; 
            pointer-events: auto; 
        }
        
        .digit-input:focus {
            border-color: #4C51BF; 
            box-shadow: 0 0 0 3px rgba(76, 81, 191, 0.5);
        }

        .correct {
            border-color: #38A169 !important; 
            background-color: #C6F6D5 !important;
        }

        .incorrect {
            border-color: #E53E3E !important; 
            background-color: #FED7D7 !important;
        }
        
        .final-answer {
             background-color: #2D3748 !important; 
             color: #FFFFFF !important; 
             font-weight: bold;
             border-color: #4A5568 !important;
        }
        
        /* ç›´å¼è¨ˆç®—å¤–æ¡†å®¹å™¨ - é—œéµé»: è¨­ç½®ç›¸å°å®šä½ */
        .calculation-box {
            position: relative; 
            background-color: #FFFFFF;
            padding: 2rem;
            border: 2px solid #E2E8F0;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            margin-bottom: 2rem;
            display: flex; 
            justify-content: center; 
        }
        
        /* Grid å®¹å™¨è¨­ç½® */
        #calculation-grid {
            position: relative; 
            display: grid; 
            grid-template-columns: repeat(5, 1fr);
            gap: 0; 
            z-index: 10; 
        }
        
        /* ç¹ªåœ– Canvas æ¨£å¼ */
        #drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20; 
            pointer-events: none; 
            background-color: transparent;
        }
        
        /* ç¹ªåœ–æ¨¡å¼ä¸‹ï¼ŒCanvas æ¥æ”¶äº‹ä»¶ */
        .drawing-active #drawing-canvas {
            pointer-events: auto;
        }
        
        /* ç¹ªåœ–æ¨¡å¼ä¸‹ï¼Œè¼¸å…¥æ¡†ä¸æ¥æ”¶äº‹ä»¶ */
        .drawing-active .digit-input {
            pointer-events: none !important;
        }

        #horizontal-line {
            position: absolute;
            height: 4px;
            background-color: #4A5568; 
            z-index: 15; 
            left: 0rem; 
            top: 11.625rem; 
            width: calc(5rem * 5 + 0.1rem * 5); 
        }
        
        .color-selector {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .color-selector:hover {
            transform: scale(1.1);
        }
        /* ç¹ªåœ–å·¥å…·æ¬„ä¸­çš„é¡è‰²æ¿€æ´»æ¨£å¼ */
        .color-selector.tool-active {
            box-shadow: 0 0 0 3px #4C51BF, 0 0 0 5px white;
        }
        
        /* ç¹ªåœ–æ¨¡å¼ä¸‹ï¼Œç•«ç­†æ¸¸æ¨™ */
        .drawing-active .cursor-pen {
            cursor: crosshair !important; /* æ¨™æº–çš„ç•«ç­†/ç¹ªåœ–æ¸¸æ¨™ */
        }
        /* ç¹ªåœ–æ¨¡å¼ä¸‹ï¼Œæ©¡çš®æ“¦æ¸¸æ¨™ */
        .drawing-active .cursor-eraser {
            cursor: cell !important; /* è¦–è¦ºä¸Šé¡ä¼¼æ©¡çš®æ“¦ï¼Œä¾‹å¦‚ä¸€å€‹åå­—æ¡† */
        }
        
        /* ç¹ªåœ–æ¨¡å¼æŒ‰éˆ•çš„é¡è‰²å’Œæ©¡çš®æ“¦æŒ‰éˆ•çš„æ¿€æ´»æ¨£å¼ */
        .tool-button-active {
            background-color: #4C51BF !important;
            color: #FFFFFF !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        /* æ–°å¢ï¼šè‡ªè¨‚é¡Œç›®é¡å‹é¸é …çš„æ¨£å¼ */
        #settings input[type="radio"] {
            -webkit-appearance: none;
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: currentColor;
            width: 1.5em;
            height: 1.5em;
            border: 0.15em solid #A0AEC0; /* gray-500 */
            border-radius: 50%;
            /* transform: translateY(-0.075em); */ /* å‚ç›´ä½ˆå±€ä¸­ç§»é™¤æ­¤è¡Œä»¥ç¢ºä¿å®Œç¾ç½®ä¸­ */
            display: grid;
            place-content: center;
            cursor: pointer;
        }

        #settings input[type="radio"]::before {
            content: "";
            width: 0.85em;
            height: 0.85em;
            border-radius: 50%;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #4C51BF; /* indigo-700 */
        }

        #settings input[type="radio"]:checked {
            border-color: #4C51BF;
        }

        #settings input[type="radio"]:checked::before {
            transform: scale(1);
        }

        #settings label {
            cursor: pointer;
        }

    </style>
</head>
<body class="bg-indigo-50 min-h-screen flex items-center justify-center p-4 font-sans">

    <div id="math-app-container" class="bg-white shadow-2xl p-8 md:p-12 rounded-2xl w-full max-w-3xl text-center">

        <h1 class="text-4xl md:text-5xl font-extrabold text-indigo-700 mb-6 flex items-center justify-center whitespace-nowrap">
            ğŸ”¢ åŠ æ¸›æ•¸ç›´å¼å¡«å…… ğŸ§ 
        </h1>
        <p class="text-xl text-gray-600 mb-8">
            è«‹åœ¨æ–¹æ ¼å…§å¡«ä¸Šæ­£ç¢ºçš„æ•¸å­—ï¼Œä½¿ç›´å¼æˆç«‹ã€‚ï¼ˆæœ€å¤šå››ä½æ•¸ï¼‰
        </p>
        
        <!-- æ–°å¢ï¼šé¡Œç›®é¡å‹èˆ‡ä½æ•¸é¸æ“‡ -->
        <div id="settings" class="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex flex-col md:flex-row justify-between items-start md:space-x-6 space-y-4 md:space-y-0">
                <!-- å·¦åŠé‚Šï¼šé¡Œç›®é¡å‹ -->
                <fieldset class="w-full md:w-1/2 border-r-0 md:border-r md:pr-6 border-gray-200">
                    <legend class="text-lg font-semibold text-gray-700 mb-2 text-center">é¸æ“‡é¡Œç›®é¡å‹</legend>
                    <div class="flex justify-center items-center space-x-2 md:space-x-6">
                        <div class="flex flex-col items-center">
                            <input type="radio" id="type-add" name="problemType" value="addition" onchange="setProblemType(this.value)" checked>
                            <label for="type-add" class="mt-2 text-lg text-gray-800">â• åŠ æ•¸</label>
                        </div>
                        <div class="flex flex-col items-center">
                            <input type="radio" id="type-subtract" name="problemType" value="subtraction" onchange="setProblemType(this.value)">
                            <label for="type-subtract" class="mt-2 text-lg text-gray-800">â– æ¸›æ•¸</label>
                        </div>
                        <div class="flex flex-col items-center">
                            <input type="radio" id="type-random" name="problemType" value="random" onchange="setProblemType(this.value)">
                            <label for="type-random" class="mt-2 text-lg text-gray-800">ğŸ”€ éš¨æ©Ÿ</label>
                        </div>
                    </div>
                </fieldset>
                
                <!-- å³åŠé‚Šï¼šä½æ•¸é¸æ“‡ -->
                <fieldset class="w-full md:w-1/2">
                    <legend class="text-lg font-semibold text-gray-700 mb-2 text-center">é¸æ“‡ä½æ•¸</legend>
                    <div class="flex justify-center items-center space-x-2 md:space-x-4">
                        <div class="flex flex-col items-center">
                            <input type="radio" id="digits-2" name="digitLength" value="2" onchange="setDigitLength(this.value)">
                            <label for="digits-2" class="mt-2 text-lg text-gray-800">2ä½æ•¸</label>
                        </div>
                        <div class="flex flex-col items-center">
                            <input type="radio" id="digits-3" name="digitLength" value="3" onchange="setDigitLength(this.value)" checked>
                            <label for="digits-3" class="mt-2 text-lg text-gray-800">3ä½æ•¸</label>
                        </div>
                        <div class="flex flex-col items-center">
                            <input type="radio" id="digits-4" name="digitLength" value="4" onchange="setDigitLength(this.value)">
                            <label for="digits-4" class="mt-2 text-lg text-gray-800">4ä½æ•¸</label>
                        </div>
                        <div class="flex flex-col items-center">
                            <input type="radio" id="digits-random" name="digitLength" value="random" onchange="setDigitLength(this.value)">
                            <label for="digits-random" class="mt-2 text-lg text-gray-800">ğŸ”€ éš¨æ©Ÿ</label>
                        </div>
                    </div>
                </fieldset>
            </div>
        </div>

        <!-- ç¹ªåœ–å·¥å…·æ¬„ -->
        <div id="drawing-toolbar" class="flex justify-center items-center space-x-4 mb-4 p-3 bg-gray-100 rounded-lg shadow-inner">
            <button id="draw-mode-toggle" class="py-2 px-4 rounded-lg text-lg font-semibold transition duration-200 bg-gray-300 text-gray-800 hover:bg-gray-400">
                âœï¸ å•Ÿç”¨ç¹ªåœ–
            </button>
            
            <!-- é¡è‰²é¸æ“‡å™¨ -->
            <div id="color-red" class="color-selector bg-red-600 tool-active" data-color="red" onclick="setDrawColor('red')"></div>
            <div id="color-blue" class="color-selector bg-blue-600" data-color="blue" onclick="setDrawColor('blue')"></div>
            <div id="color-green" class="color-selector bg-green-600" data-color="green" onclick="setDrawColor('green')"></div>

            <!-- æ©¡çš®æ“¦æŒ‰éˆ• -->
            <button id="eraser-button" onclick="setEraser()" class="py-2 px-4 rounded-lg text-lg font-semibold transition duration-200 bg-gray-300 text-gray-800 hover:bg-gray-400">
                ğŸ§¼ æ©¡çš®æ“¦
            </button>
            
            <!-- æ¸…é™¤ç•«å¸ƒæŒ‰éˆ• -->
            <button id="clear-canvas-button" onclick="clearCanvas()" class="py-2 px-4 rounded-lg text-lg font-semibold transition duration-200 bg-red-500 text-white hover:bg-red-600">
                ğŸ—‘ï¸ æ¸…é™¤ç•«å¸ƒ
            </button>
        </div>
        
        <!-- ç›´å¼è¨ˆç®—å¤–æ¡† - ç¢ºä¿æ°´å¹³å±…ä¸­ -->
        <div class="calculation-box">
             <!-- ç¹ªåœ– Canvas çµ•å°å®šä½æ–¼æ­¤ box å…§ -->
             <canvas id="drawing-canvas"></canvas>
             
             <!-- ç›´å¼è¨ˆç®—å€åŸŸ (Grid ä½ˆå±€) - ç§»é™¤ grid-cols-5ï¼Œç”± JS å‹•æ…‹æ§åˆ¶ -->
            <div id="calculation-grid" class="justify-items-end font-mono text-5xl mx-auto max-w-sm">
                 <!-- çµ•å°å®šä½çš„æ©«ç·šå°‡åœ¨é€™è£¡å‹•æ…‹æ’å…¥æˆ–ä¿æŒéœæ…‹ -->
                 <div id="horizontal-line"></div> 
                <!-- é¡Œç›®å°‡ç”± JavaScript æ¸²æŸ“åœ¨é€™è£¡ -->
            </div>
        </div>


        <!-- æŒ‰éˆ•å’Œç‹€æ…‹è¨Šæ¯ -->
        <div class="space-y-4">
            <button id="check-button" onclick="checkAnswer()" class="w-full py-4 bg-green-500 text-white text-3xl font-bold rounded-xl shadow-lg hover:bg-green-600 transition duration-300 transform hover:scale-[1.02]">
                âœ… æª¢æŸ¥ç­”æ¡ˆ
            </button>
            <button id="new-problem-button" onclick="generateProblem()" class="w-full py-3 bg-indigo-500 text-white text-2xl font-semibold rounded-xl shadow-md hover:bg-indigo-600 transition duration-300">
                ğŸ”„ ç”Ÿæˆæ–°é¡Œç›®
            </button>

            <div id="message-box" class="mt-6 p-4 text-2xl font-bold rounded-lg transition-opacity duration-500 opacity-0 h-10">
                <!-- è¨Šæ¯é¡¯ç¤ºå€ -->
            </div>
        </div>

    </div>

    <script>
        
        let correctDigits = []; // ç”¨ä¾†å„²å­˜æ‰€æœ‰æ­£ç¢ºçš„æ•¸å­—åºåˆ—
        let selectedDigitLength = 3; // ç”¨æˆ¶é¸æ“‡çš„ä½æ•¸ (å¯ä»¥æ˜¯ 'random')
        let digitLength = 3; // ç•¶å‰é¡Œç›®çš„å¯¦éš›ä½æ•¸
        let attemptCount = 0; // å˜—è©¦æ¬¡æ•¸è¨ˆæ•¸å™¨
        const maxAttempts = 3; // æœ€å¤§å˜—è©¦æ¬¡æ•¸
        let problemType = 'addition'; // 'addition', 'subtraction', æˆ– 'random'
        
        // =========================================================
        // ç¹ªåœ–åŠŸèƒ½ç›¸é—œè®Šæ•¸
        // =========================================================
        let canvas, ctx;
        let isDrawing = false;
        let drawingMode = false; 
        let currentTool = 'pen'; 
        let currentColor = 'red';
        // ç­†è§¸å¯¬åº¦
        const initialStrokeThickness = 4; 
        let strokeThickness = initialStrokeThickness; 
        const drawingToolToggle = document.getElementById('draw-mode-toggle');
        const eraserButton = document.getElementById('eraser-button');
        const appContainer = document.getElementById('math-app-container');
        
        // åµæ¸¬è¨­å‚™çš„åƒç´ æ¯” (Device Pixel Ratio)
        const dpr = window.devicePixelRatio || 1; 

        /**
         * èª¿æ•´ Canvas çš„æ¸¸æ¨™æ¨£å¼
         */
        function updateCanvasCursor() {
            canvas.classList.remove('cursor-pen', 'cursor-eraser');
            if (drawingMode) {
                if (currentTool === 'pen') {
                    canvas.classList.add('cursor-pen');
                } else if (currentTool === 'eraser') {
                    canvas.classList.add('cursor-eraser');
                }
            }
        }

        /**
         * åˆå§‹åŒ–ç¹ªåœ–ç•«å¸ƒå’Œä¸Šä¸‹æ–‡
         */
        function initCanvas() {
            canvas = document.getElementById('drawing-canvas');
            ctx = canvas.getContext('2d');
            
            // ç¶å®šç¹ªåœ–äº‹ä»¶
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            
            // ä¿®æ­£ 1: å…¨å±€ç¶å®š mouseup å’Œ touchendï¼Œç¢ºä¿å³ä½¿æ»‘é¼ /æ‰‹æŒ‡ç§»å‡ºç•«å¸ƒä¹Ÿèƒ½åœæ­¢ç¹ªåœ–
            window.addEventListener('mouseup', stopDrawing); 
            window.addEventListener('touchend', stopDrawing);
            
            // ç¶å®šè§¸æ‘¸äº‹ä»¶ (ç”¨æ–¼ç§»å‹•è¨­å‚™)
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault(); 
                startDrawing(e); 
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault(); 
                draw(e); 
            });
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas(); 
            
            // åˆå§‹åŒ–æ™‚è¨­ç½®ç•«ç­†ç‚ºé è¨­å·¥å…·
            setDrawColor('red', false); 
            drawingMode = false;
            appContainer.classList.remove('drawing-active');
        }

        /**
         * èª¿æ•´ Canvas å¤§å°ä»¥åŒ¹é…å…¶å®¹å™¨ï¼Œä¸¦æ‡‰ç”¨ DPI ä¿®æ­£
         */
        function resizeCanvas() {
            const box = canvas.parentElement;
            
            // ç²å– Canvas çš„ CSS å°ºå¯¸ (ä»¥åƒç´ ç‚ºå–®ä½)
            const displayWidth = box.offsetWidth;
            const displayHeight = box.offsetHeight;

            // æš«å­˜åœ–åƒæ•¸æ“š
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            // ç‚ºäº†ä¿æŒæ¸…æ™°åº¦ï¼Œæˆ‘å€‘éœ€è¦è€ƒæ…® DPI æ¯”ä¾‹ä¾†ç¸®æ”¾æš«å­˜åœ–åƒ
            if (canvas.width > 0 && canvas.height > 0) {
                 // ç¸®å°ä»¥ç¬¦åˆ CSS åƒç´  (åå‘ç¸®æ”¾ç¹ªåœ–ï¼Œä¿æŒåœ–åƒçš„é‚è¼¯å¤§å°)
                tempCtx.scale(1 / dpr, 1 / dpr); 
                tempCtx.drawImage(canvas, 0, 0);
            }
            

            // è¨­ç½®æ–°çš„å…§éƒ¨è§£æåº¦ (ä¹˜ä»¥ DPR é€²è¡Œé«˜æ¸…æ¸²æŸ“)
            canvas.width = displayWidth * dpr;
            canvas.height = displayHeight * dpr;
            
            // è¨­ç½® Canvas çš„ CSS å°ºå¯¸ (é€™æ˜¯ç€è¦½å™¨çœ‹åˆ°çš„å°ºå¯¸)
            canvas.style.width = displayWidth + 'px';
            canvas.style.height = displayHeight + 'px';

            // æ‡‰ç”¨ DPI ç¸®æ”¾å› å­åˆ°ç¹ªåœ–ä¸Šä¸‹æ–‡ï¼Œé€™æ¨£æ‰€æœ‰çš„ç¹ªåœ–æŒ‡ä»¤éƒ½æœƒè‡ªå‹•ç¸®æ”¾
            // ä¿®æ­£ï¼šå¿…é ˆåœ¨è¨­ç½®å®Œ width/height ä¹‹å¾Œå†é€²è¡Œç¸®æ”¾
            ctx.scale(dpr, dpr);
            
            // æ¢å¾©ç¹ªç•«æ¨£å¼ï¼Œæ³¨æ„ï¼šç­†è§¸å¯¬åº¦å·²ç¶“ä¹˜ä»¥ DPR åœ¨ setDrawColor/setEraser ä¸­è™•ç†
            setToolStyles();

            // ç¹ªè£½å›æš«å­˜çš„åœ–åƒ
            // ç”±æ–¼å…§éƒ¨è§£æåº¦æ”¹è®Šï¼Œæˆ‘å€‘éœ€è¦é‡æ–°ç¹ªè£½ï¼Œä¸¦ä½¿ç”¨åŸå§‹çš„é‚è¼¯å¯¬åº¦/é«˜åº¦
            if (tempCanvas.width > 0 && tempCanvas.height > 0) {
                 // ç¹ªè£½å›æ™‚ï¼Œä½¿ç”¨ CSS å°ºå¯¸ä½œç‚ºç›®æ¨™å°ºå¯¸ (åœ¨å·²ç¶“ scale çš„ ctx ä¸Š)
                ctx.drawImage(tempCanvas, 0, 0, displayWidth, displayHeight); 
            }
        }
        
        /**
         * çµ±ä¸€è¨­å®šç•«ç­†å’Œæ©¡çš®æ“¦çš„æ¨£å¼
         */
        function setToolStyles() {
            // æ³¨æ„ï¼šctx.scale(dpr, dpr) å·²ç¶“åœ¨ resizeCanvas ä¸­è¨­å®š
            
            if (currentTool === 'eraser') {
                // æ©¡çš®æ“¦ï¼šä½¿ç”¨æ›´å¤§çš„é‚è¼¯å¯¬åº¦
                ctx.lineWidth = 20; // é‚è¼¯åƒç´ 
                ctx.globalCompositeOperation = 'destination-out';
                ctx.strokeStyle = 'rgba(0,0,0,1)'; 
            } else {
                // ç•«ç­†ï¼šä½¿ç”¨é è¨­çš„é‚è¼¯å¯¬åº¦
                ctx.lineWidth = strokeThickness; // é‚è¼¯åƒç´ 
                ctx.globalCompositeOperation = 'source-over'; 
                ctx.strokeStyle = currentColor;
            }
            
            ctx.lineCap = 'round';
            // æ¶ˆé™¤ç·šæ¢æ¨¡ç³Š
            // ç¹ªè£½ç·šæ¢æ™‚ï¼Œå°‡ç·šæ¢çš„èµ·é»å’Œçµ‚é»å®šä½åˆ°åŠåƒç´ ä½ç½®ï¼Œåœ¨é«˜DPIç’°å¢ƒä¸­å¯æ”¹å–„æ¸…æ™°åº¦
            ctx.translate(0.5, 0.5);
            ctx.translate(-0.5, -0.5); 
        }


        /**
         * åˆ‡æ›ç¹ªåœ–æ¨¡å¼ (é–‹/é—œ)
         */
        function toggleDrawingMode() {
            drawingMode = !drawingMode;
            
            if (drawingMode) {
                // é€²å…¥ç¹ªåœ–æ¨¡å¼
                drawingToolToggle.textContent = 'âœ… é€€å‡ºç¹ªåœ–';
                drawingToolToggle.classList.add('tool-button-active');
                appContainer.classList.add('drawing-active'); 
                
                // ç¢ºä¿ç•¶å‰å·¥å…·çš„æ¸¸æ¨™é¡¯ç¤ºæ­£ç¢º
                updateCanvasCursor();
            } else {
                // é€€å‡ºç¹ªåœ–æ¨¡å¼
                drawingToolToggle.textContent = 'âœï¸ å•Ÿç”¨ç¹ªåœ–';
                drawingToolToggle.classList.remove('tool-button-active');
                appContainer.classList.remove('drawing-active'); 
                
                // æ¸…é™¤æ¸¸æ¨™
                canvas.classList.remove('cursor-pen', 'cursor-eraser');
                
                // é€€å‡ºç¹ªåœ–å¾Œè‡ªå‹•èšç„¦åˆ°ç¬¬ä¸€å€‹æœªå¡«å¯«çš„ç©ºæ ¼
                focusFirstUnfilledBlank();
            }
        }

        /**
         * è¼”åŠ©å‡½æ•¸ï¼šå¾äº‹ä»¶å°è±¡ä¸­ç²å–æ¨™æº–åŒ–çš„ (clientX, clientY)
         */
        function getClientCoords(e) {
            if (e.touches && e.touches.length > 0) {
                return { 
                    x: e.touches[0].clientX, 
                    y: e.touches[0].clientY 
                };
            }
            // è™•ç†æ»‘é¼ äº‹ä»¶
            return { 
                x: e.clientX, 
                y: e.clientY 
            };
        }

        /**
         * é–‹å§‹ç¹ªåœ–æˆ–æ©¡çš®æ“¦
         */
        function startDrawing(e) {
            if (!drawingMode) return;
            
            // é˜»æ­¢æ»‘é¼ çš„é è¨­è¡Œç‚ºï¼Œé˜²æ­¢èˆ‡ç€è¦½å™¨çš„æ‹–æ›³é¸æ“‡è¡çª
            if (e.type === 'mousedown') {
                e.preventDefault();
            }
            
            // ä½¿ç”¨æœ€ç©©å¥çš„æ–¹æ³•ï¼šåŸºæ–¼å®¢æˆ¶ç«¯åº§æ¨™ (clientX/Y) å’Œç•«å¸ƒé‚Šç•Œè¨ˆç®—ç›¸å°ä½ç½®
            const rect = canvas.getBoundingClientRect();
            const coords = getClientCoords(e); 
            
            // 1. è¨ˆç®—ç›¸å° CSS é‚Šç•Œçš„åº§æ¨™
            let drawX = coords.x - rect.left;
            let drawY = coords.y - rect.top;

            // ç”±æ–¼æˆ‘å€‘å·²ç¶“åœ¨ ctx.scale(dpr, dpr) ä¸­æ‡‰ç”¨äº† DPI ç¸®æ”¾ï¼Œ
            // é€™è£¡åªéœ€è¦è¨ˆç®—ç›¸å°æ–¼ CSS å°ºå¯¸çš„é‚è¼¯åº§æ¨™å³å¯ã€‚
            
            ctx.beginPath();
            ctx.moveTo(drawX, drawY);
            isDrawing = true;
        }

        /**
         * åœæ­¢ç¹ªåœ–
         */
        function stopDrawing() {
            // æª¢æŸ¥ isDrawingï¼Œç¢ºä¿åªæœ‰åœ¨ç¹ªåœ–æ¨¡å¼ä¸‹æ‰åŸ·è¡Œ
            if (!isDrawing) return; 

            ctx.closePath();
            isDrawing = false;
        }

        /**
         * ç¹ªè£½ç·šæ¢
         */
        function draw(e) {
            if (!isDrawing) return;
            
            // ä½¿ç”¨æœ€ç©©å¥çš„æ–¹æ³•ï¼šåŸºæ–¼å®¢æˆ¶ç«¯åº§æ¨™ (clientX/Y) å’Œç•«å¸ƒé‚Šç•Œè¨ˆç®—ç›¸å°ä½ç½®
            const rect = canvas.getBoundingClientRect();
            const coords = getClientCoords(e); 
            
            // 1. è¨ˆç®—ç›¸å° CSS é‚Šç•Œçš„åº§æ¨™
            let drawX = coords.x - rect.left;
            let drawY = coords.y - rect.top;
            
            // ç”±æ–¼æˆ‘å€‘å·²ç¶“åœ¨ ctx.scale(dpr, dpr) ä¸­æ‡‰ç”¨äº† DPI ç¸®æ”¾ï¼Œ
            // é€™è£¡åªéœ€è¦è¨ˆç®—ç›¸å°æ–¼ CSS å°ºå¯¸çš„é‚è¼¯åº§æ¨™å³å¯ã€‚

            ctx.lineTo(drawX, drawY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(drawX, drawY);
        }

        /**
         * æ¸…é™¤æ•´å€‹ç•«å¸ƒ
         */
        function clearCanvas() {
            if (ctx) {
                // ä½¿ç”¨é‚è¼¯åƒç´ å°ºå¯¸ä¾†æ¸…é™¤ (å› ç‚º ctx å·²ç¶“ç¸®æ”¾)
                // å¿…é ˆä½¿ç”¨ canvas.width / dpr, canvas.height / dpr ä¾†ç²å–æ­£ç¢ºçš„é‚è¼¯å°ºå¯¸
                ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);
            }
        }
        
        /**
         * è¨­å®šç•«ç­†é¡è‰²
         * @param {string} color é¡è‰²åç¨±æˆ–ä»£ç¢¼
         * @param {boolean} shouldToggle æ˜¯å¦æ‡‰è©²åœ¨è¨­ç½®å¾Œè‡ªå‹•åˆ‡æ›åˆ°ç¹ªåœ–æ¨¡å¼ (é è¨­ç‚º true)
         */
        function setDrawColor(color, shouldToggle = true) {
            currentTool = 'pen';
            currentColor = color;
            strokeThickness = initialStrokeThickness; // ä½¿ç”¨æ–°çš„ç­†è§¸å¯¬åº¦
            
            setToolStyles(); // æ‡‰ç”¨æ¨£å¼
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.color-selector').forEach(btn => btn.classList.remove('tool-active'));
            document.getElementById(`color-${color}`).classList.add('tool-active');
            
            eraserButton.classList.remove('tool-button-active');
            eraserButton.classList.replace('bg-indigo-500', 'bg-gray-300');
            eraserButton.classList.replace('text-white', 'text-gray-800');

            if (shouldToggle && !drawingMode) {
                toggleDrawingMode();
            } else if (drawingMode) {
                updateCanvasCursor(); // ç¢ºä¿æ¸¸æ¨™æ›´æ–°
            }
        }
        
        /**
         * è¨­å®šç‚ºæ©¡çš®æ“¦æ¨¡å¼
         */
        function setEraser() {
            currentTool = 'eraser';
            
            setToolStyles(); // æ‡‰ç”¨æ¨£å¼
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.color-selector').forEach(btn => btn.classList.remove('tool-active'));
            
            eraserButton.classList.add('tool-button-active');
            
            if (!drawingMode) {
                toggleDrawingMode(); 
            } else {
                updateCanvasCursor(); // ç¢ºä¿æ¸¸æ¨™æ›´æ–°
            }
        }
        
        // =========================================================
        // æ•¸å­¸é‚è¼¯å’Œèšç„¦åŠŸèƒ½
        // =========================================================

        /**
         * è¨­å®šè¦ç”Ÿæˆçš„é¡Œç›®é¡å‹
         */
        function setProblemType(type) {
            problemType = type;
        }

        /**
         * æ–°å¢ï¼šè¨­å®šé¡Œç›®ä½æ•¸
         */
        function setDigitLength(length) {
            selectedDigitLength = length; // Store the user's selection
        }

        /**
         * è¼”åŠ©å‡½æ•¸ï¼šå°‡ç„¦é»ç§»å‹•åˆ°ä¸‹ä¸€å€‹æœ€é‚è¼¯çš„ç©ºæ ¼ (å³è‡³å·¦ï¼Œä¸Šè‡³ä¸‹)
         */
        function focusFirstUnfilledBlank() {
            const allInputElements = correctDigits
                .map(item => ({
                    id: item.id,
                    element: document.getElementById(item.id),
                    row: item.row,
                    col: item.col
                }))
                .filter(item => item.element && item.element.value.trim() === '' && !item.element.readOnly);
            
            // æ’åºï¼šå„ªå…ˆæœ€å¤§ Col (æœ€å³é‚Š)ï¼Œå…¶æ¬¡æœ€å° Row (æœ€ä¸Šé¢)
            allInputElements.sort((a, b) => {
                if (a.col !== b.col) {
                    return b.col - a.col; // Col Descending (4, 3, 2, 1)
                }
                return a.row - b.row; // Row Ascending (0, 1, 2)
            });

            if (allInputElements.length > 0) {
                allInputElements[0].element.focus();
            }
        }


        /**
         * æ’­æ”¾å™´ç™¼ç´™ç¢æ…¶ç¥å‹•ç•«
         */
        function runConfetti() {
            if (typeof confetti === 'undefined') return; 
            
            confetti({
                particleCount: 150,
                spread: 120,
                origin: { y: 0.6 }, 
                colors: ['#FFC107', '#38A169', '#4C51BF', '#F6AD55']
            });
        }

        /**
         * è¼”åŠ©å‡½æ•¸ï¼šç”ŸæˆæŒ‡å®šç¯„åœå…§çš„éš¨æ©Ÿæ•´æ•¸
         */
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        /**
         * è¼”åŠ©å‡½æ•¸ï¼šå°‡æ•¸å­—è½‰æ›ç‚ºå›ºå®šé•·åº¦ï¼ˆlengthä½ï¼‰çš„å­—ç¬¦ä¸²é™£åˆ—
         */
        function numberToPaddedDigits(num, length) {
            const numStr = String(num);
            const paddedDigits = Array(length).fill(''); 
            
            for (let i = 0; i < numStr.length; i++) {
                paddedDigits[length - numStr.length + i] = numStr[i];
            }
            return paddedDigits;
        }
        
        /**
         * è™•ç†è¼¸å…¥äº‹ä»¶ä¸¦è‡ªå‹•å°‡ç„¦é»ç§»åˆ°ä¸‹ä¸€å€‹æœ€é‚è¼¯çš„ç©ºæ ¼
         */
        function handleInputAndAdvance(e) {
            this.value = this.value.replace(/[^0-9]/g, '');

            if (this.value) {
                setTimeout(() => {
                    const unfilledBlanks = correctDigits
                        .map(item => ({
                            ...item,
                            inputElement: document.getElementById(item.id)
                        }))
                        .filter(item => item.inputElement && item.inputElement.value.trim() === '' && !item.inputElement.readOnly); 

                    if (unfilledBlanks.length === 0) {
                        return;
                    }

                    unfilledBlanks.sort((a, b) => {
                        if (a.col !== b.col) {
                            return b.col - a.col; 
                        }
                        return a.row - b.row;
                    });
                    
                    unfilledBlanks[0].inputElement.focus();
                }, 0); 
            }
        }

        /**
         * æ¸²æŸ“ç›´å¼è¨ˆç®—çš„ HTML çµæ§‹
         */
        function renderCalculation(operator, num1Digits, num2Digits, resultDigits, blankPositions) {
            const grid = document.getElementById('calculation-grid');
            const lineElement = document.getElementById('horizontal-line');

            // å‹•æ…‹èª¿æ•´ Grid æ¬„æ•¸å’Œæ°´å¹³ç·šå¯¬åº¦
            const numCols = digitLength + 1;
            grid.style.gridTemplateColumns = `repeat(${numCols}, 1fr)`;

            if (lineElement) {
                lineElement.remove();
            }
            
            grid.innerHTML = '';
            
            if (lineElement) {
                lineElement.style.width = '100%'; // è®“æ©«ç·šå¯¬åº¦è‡ªé©æ‡‰å®¹å™¨
                grid.appendChild(lineElement);
            } 
            
            const rows = [num1Digits, num2Digits, resultDigits];
            
            rows.slice(0, 2).forEach((digits, rowIndex) => {
                const rowClass = rowIndex === 1 ? 'num2-row' : '';

                // First column: operator or empty space
                if (rowIndex === 1) { // operator in the second row
                    const opCell = document.createElement('div');
                    opCell.className = `digit-cell text-indigo-600 font-bold ${rowClass}`;
                    opCell.textContent = operator;
                    grid.appendChild(opCell);
                } else {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'digit-cell text-transparent'; 
                    emptyCell.textContent = '';
                    grid.appendChild(emptyCell);
                }
                
                // Add digit cells for the rest of the columns
                digits.forEach((digit, colIndexOffset) => {
                    const colIndex = colIndexOffset + 1; 
                    const isBlank = blankPositions.some(pos => pos[0] === rowIndex && pos[1] === colIndex);
                    
                    const cell = document.createElement('div');
                    cell.className = `digit-cell text-gray-800 ${rowClass}`;

                    if (isBlank) {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.maxLength = 1; 
                        input.pattern = '[0-9]'; 
                        input.id = `input-${rowIndex}-${colIndex}`;
                        input.className = 'digit-input font-mono';
                        input.placeholder = ' '; 
                        input.dataset.row = rowIndex;
                        input.dataset.col = colIndex;
                        input.oninput = handleInputAndAdvance; 
                        cell.appendChild(input);
                    } else if (digit !== '') {
                        cell.textContent = digit;
                        cell.classList.add('font-bold', 'text-gray-800');
                    } else {
                        cell.textContent = '';
                        cell.classList.add('text-transparent'); 
                    }
                    
                    grid.appendChild(cell);
                });
            });
            
            const children = Array.from(grid.children).filter(child => child.id !== 'horizontal-line');
            children.forEach(child => grid.appendChild(child));
            grid.appendChild(lineElement); 

            rows.slice(2, 3).forEach((digits, rowIndexOffset) => {
                const rowIndex = 2; 
                
                const emptyCell = document.createElement('div');
                emptyCell.className = 'digit-cell text-transparent result-row'; 
                emptyCell.textContent = '';
                grid.appendChild(emptyCell);
                
                digits.forEach((digit, colIndexOffset) => {
                    const colIndex = colIndexOffset + 1; 
                    const isBlank = blankPositions.some(pos => pos[0] === rowIndex && pos[1] === colIndex);
                    
                    const cell = document.createElement('div');
                    cell.className = 'digit-cell text-gray-800 result-row'; 
                    
                    if (isBlank) {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.maxLength = 1; 
                        input.pattern = '[0-9]';
                        input.id = `input-${rowIndex}-${colIndex}`;
                        input.className = 'digit-input font-mono';
                        input.placeholder = ' '; 
                        input.dataset.row = rowIndex;
                        input.dataset.col = colIndex;
                        input.oninput = handleInputAndAdvance; 
                        cell.appendChild(input);
                    } else if (digit !== '') {
                        cell.textContent = digit;
                        cell.classList.add('font-bold', 'text-indigo-800');
                    } else {
                        cell.textContent = '';
                        cell.classList.add('text-transparent');
                    }
                    
                    grid.appendChild(cell);
                });
            });
        }
        
        /**
         * éš¨æ©Ÿç”Ÿæˆä¸€é“åŠ æ•¸æˆ–æ¸›æ•¸é¡Œç›®ä¸¦æ¸²æŸ“
         */
        function generateProblem() {
            attemptCount = 0; 

            // æ–°å¢ï¼šæ ¹æ“šç”¨æˆ¶é¸æ“‡æ±ºå®šç•¶å‰é¡Œç›®çš„å¯¦éš›ä½æ•¸
            if (selectedDigitLength === 'random') {
                digitLength = getRandomInt(2, 4);
            } else {
                digitLength = parseInt(selectedDigitLength, 10);
            }

            let num1, num2, result, operator;
            let num1Digits, num2Digits, resultDigits;
            let blanksToHide;
            let isAddition; // å®£å‘Šè®Šæ•¸

            
            // ä¿®æ­£: ç¢ºä¿ç”Ÿæˆæ–°é¡Œç›®æ™‚ï¼Œé€€å‡ºç¹ªåœ–æ¨¡å¼
            if (drawingMode) {
                toggleDrawingMode();
            }
            
            // é‡ç½®ç•«ç­†ç‹€æ…‹åˆ°é è¨­ç´…è‰²ï¼Œä½†ä¸è‡ªå‹•é–‹å•Ÿç¹ªåœ–æ¨¡å¼
            setDrawColor('red', false);

            while (true) {
                // æ ¹æ“šç”¨æˆ¶é¸æ“‡æ±ºå®šé¡Œç›®é¡å‹
                if (problemType === 'addition') {
                    isAddition = true;
                } else if (problemType === 'subtraction') {
                    isAddition = false;
                } else { // 'random'
                    isAddition = Math.random() < 0.5;
                }

                // æ ¹æ“šé¸æ“‡çš„ä½æ•¸å‹•æ…‹è¨­å®šæ•¸å­—ç¯„åœ
                const minRange = Math.pow(10, digitLength - 1);
                const maxRange = Math.pow(10, digitLength) - 1;
                
                if (isAddition) {
                    operator = '+';
                    // ç¢ºä¿è‡³å°‘ä¸€å€‹æ•¸å­—æ˜¯æ‰€é¸çš„æœ€å¤§ä½æ•¸
                    num1 = getRandomInt(minRange, maxRange);
                    // å¦ä¸€å€‹æ•¸å­—å¯ä»¥æ˜¯ 1 åˆ°æœ€å¤§ä½æ•¸ä¹‹é–“çš„ä»»ä½•æ•¸
                    num2 = getRandomInt(1, maxRange);
                    result = num1 + num2;

                    if (result > maxRange) { // ç¢ºä¿çµæœä¸è¶…éæ‰€é¸ä½æ•¸
                         continue; 
                    }
                } else {
                    operator = 'âˆ’'; 
                    // ç¢ºä¿è¢«æ¸›æ•¸æ˜¯æœ€å¤§ä½æ•¸
                    num1 = getRandomInt(minRange, maxRange); 
                    // æ¸›æ•¸å¯ä»¥æ˜¯ 1 åˆ°è¢«æ¸›æ•¸ä¹‹é–“çš„ä»»ä½•æ•¸
                    num2 = getRandomInt(1, num1);
                    result = num1 - num2;
                }

                num1Digits = numberToPaddedDigits(num1, digitLength);
                num2Digits = numberToPaddedDigits(num2, digitLength);
                resultDigits = numberToPaddedDigits(result, digitLength);
                
                const rowsData = [
                    { index: 0, digits: num1Digits },
                    { index: 1, digits: num2Digits },
                    { index: 2, digits: resultDigits } 
                ];
                
                const allPositions = [];
                rowsData.forEach(row => {
                     row.digits.forEach((digit, colIndexOffset) => {
                        const col = colIndexOffset + 1;
                        if (digit !== '') allPositions.push({ row: row.index, col: col, digit: digit });
                    });
                });

                // å‹•æ…‹è¨­å®šå¡«ç©ºæ•¸é‡ï¼Œä»¥é¿å…åœ¨ä½æ•¸è¼ƒå°‘æ™‚é™·å…¥ç„¡é™å¾ªç’°
                let minBlanks, maxBlanks;
                if (digitLength === 2) {
                    minBlanks = 2;
                    maxBlanks = 3; // èª¿æ•´æ•¸é‡ä»¥ç¬¦åˆæ¬„ä½é™åˆ¶
                } else if (digitLength === 3) {
                    minBlanks = 3;
                    maxBlanks = 4; // èª¿æ•´æ•¸é‡
                } else { // 4 digits
                    minBlanks = 4;
                    maxBlanks = 5; // èª¿æ•´æ•¸é‡
                }
                const numBlanks = getRandomInt(minBlanks, maxBlanks); 

                blanksToHide = [];
                // é‡æ–°å¼•å…¥ occupiedCols é™åˆ¶ï¼Œç¢ºä¿æ¯æ¬„æœ€å¤šä¸€å€‹å¡«ç©º
                const occupiedCols = new Set(); 
                
                // å°‡æ‰€æœ‰å¯èƒ½çš„ä½ç½®éš¨æ©Ÿæ’åºï¼Œä»¥å¢åŠ éš¨æ©Ÿæ€§
                let positionsPool = [...allPositions].sort(() => Math.random() - 0.5);
                let attempts = 0; // å®‰å…¨è¨ˆæ•¸å™¨ï¼Œé˜²æ­¢æ„å¤–çš„ç„¡é™å¾ªç’°

                // ç•¶å¡«ç©ºæ•¸ä¸è¶³ï¼Œä¸”é‚„æœ‰å€™é¸ä½ç½®æ™‚ï¼Œç¹¼çºŒé¸å–
                while (blanksToHide.length < numBlanks && positionsPool.length > 0 && attempts < allPositions.length * 2) {
                    const pos = positionsPool.pop(); // å¾éš¨æ©Ÿæ’åºçš„é™£åˆ—ä¸­å–å‡ºä¸€å€‹
                    
                    // æª¢æŸ¥é€™ä¸€æ¬„æ˜¯å¦å·²ç¶“æœ‰å¡«ç©ºäº†
                    if (pos && !occupiedCols.has(pos.col)) {
                        blanksToHide.push(pos);
                        occupiedCols.add(pos.col); // æ¨™è¨˜é€™ä¸€æ¬„å·²è¢«ä½”ç”¨
                    }
                    attempts++;
                }
                
                // å¦‚æœæœ€çµ‚ç”Ÿæˆçš„å¡«ç©ºæ•¸å°‘æ–¼ä¸‹é™ï¼Œå‰‡é‡æ–°ç”Ÿæˆæ•´é“é¡Œç›®
                if (blanksToHide.length < minBlanks) {
                     continue; 
                }

                break;
            }
            
            correctDigits = blanksToHide.map(pos => ({ 
                row: pos.row, 
                col: pos.col, 
                answer: pos.digit,
                id: `input-${pos.row}-${pos.col}`
            }));
            
            const blankPositions = blanksToHide.map(pos => [pos.row, pos.col]);

            renderCalculation(operator, num1Digits, num2Digits, resultDigits, blankPositions);

            // ä¿®æ­£ 2: å»¶é²èª¿æ•´ Canvas å°ºå¯¸å’Œæ¸…é™¤ï¼Œç¢ºä¿å®ƒæ˜¯åœ¨ DOM çµæ§‹ç¢ºå®šå¾ŒåŸ·è¡Œï¼Œä»¥è¦†è“‹æ•´å€‹å€åŸŸ
            setTimeout(() => {
                if (ctx) {
                    resizeCanvas(); 
                    clearCanvas(); 
                }
            }, 0); 
            
            focusFirstUnfilledBlank();

            const messageBox = document.getElementById('message-box');
            messageBox.textContent = '';
            messageBox.className = 'mt-6 p-4 text-2xl font-bold rounded-lg transition-opacity duration-500 opacity-0 h-10';
            
            document.getElementById('check-button').disabled = false;
        }
        
        /**
         * é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆä¸¦é–å®šè¼¸å…¥æ¡†
         */
        function showAnswer() {
            if (drawingMode) {
                toggleDrawingMode();
            }

            correctDigits.forEach(item => {
                const inputElement = document.getElementById(item.id);
                if (!inputElement) return;

                inputElement.value = item.answer;
                inputElement.readOnly = true; 
                inputElement.classList.remove('incorrect', 'correct');
                inputElement.classList.add('final-answer');
            });
            
            document.getElementById('check-button').disabled = true;

            const messageBox = document.getElementById('message-box');
            messageBox.classList.remove('opacity-0', 'bg-red-100', 'text-red-700');
            messageBox.textContent = 'ğŸ’¡ é€™æ˜¯æ­£ç¢ºç­”æ¡ˆï¼Œè«‹å˜—è©¦ç†è§£è¨ˆç®—æ­¥é©Ÿã€‚';
            messageBox.classList.add('bg-gray-200', 'text-gray-800');
        }

        /**
         * æª¢æŸ¥æ‰€æœ‰å¡«ç©ºæ–¹æ ¼çš„ç­”æ¡ˆæ˜¯å¦æ­£ç¢º
         */
        function checkAnswer() {
            if (drawingMode) {
                toggleDrawingMode();
            }

            let allCorrect = true;
            const messageBox = document.getElementById('message-box');
            let firstIncorrectInput = null;

            correctDigits.forEach(item => {
                const inputElement = document.getElementById(item.id);
                if (!inputElement || inputElement.readOnly) return; 
                
                const userInput = inputElement.value.trim();
                const isCorrect = userInput === item.answer;

                inputElement.classList.remove('correct', 'incorrect');
                
                if (isCorrect) {
                    inputElement.classList.add('correct');
                } else {
                    inputElement.classList.add('incorrect');
                    allCorrect = false;
                    if (!firstIncorrectInput) {
                        firstIncorrectInput = inputElement; 
                    }
                }
            });

            messageBox.classList.remove('opacity-0', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-gray-200', 'text-gray-800');
            messageBox.classList.add('opacity-100');

            if (allCorrect) {
                messageBox.textContent = 'å¤ªæ£’äº†ï¼æ‰€æœ‰ç­”æ¡ˆéƒ½æ­£ç¢ºï¼ğŸ‰ğŸ’¯';
                messageBox.classList.add('bg-green-100', 'text-green-700');
                document.getElementById('check-button').disabled = true; 
                runConfetti(); 
            } else {
                attemptCount++; 
                
                if (attemptCount >= maxAttempts) {
                    showAnswer();
                } else {
                    messageBox.textContent = `è«‹å†æª¢æŸ¥ä¸€ä¸‹ï¼Œæœ‰äº›æ•¸å­—ä¸å°å–”ã€‚ğŸ¤” (ç¬¬ ${attemptCount} æ¬¡å˜—è©¦ / å…± ${maxAttempts} æ¬¡)`;
                    messageBox.classList.add('bg-red-100', 'text-red-700');
                    
                    if (firstIncorrectInput) {
                        firstIncorrectInput.focus();
                    }
                }
            }
        }
        
        // é é¢è¼‰å…¥å¾Œç«‹å³åˆå§‹åŒ–å’Œç”Ÿæˆç¬¬ä¸€é“é¡Œç›®
        window.onload = function() {
            initCanvas(); 
            generateProblem(); 
            
            document.getElementById('draw-mode-toggle').onclick = toggleDrawingMode;
        };
        
        // è¨­å®šå…¨åŸŸéµç›¤äº‹ä»¶ç›£è½ï¼Œç”¨æ–¼ Enter éµæª¢æŸ¥å’Œ Space éµç”Ÿæˆæ–°é¡Œ
        document.addEventListener('keydown', function(event) {
            const isInputFocused = event.target.tagName === 'INPUT' && event.target.classList.contains('digit-input');

            if (event.key === 'Enter') {
                if (document.getElementById('check-button').disabled) {
                    generateProblem();
                } else {
                    checkAnswer();
                }
                event.preventDefault(); 
            } 
            
            if (event.key === ' ' && !isInputFocused && !drawingMode) { 
                generateProblem();
                event.preventDefault(); 
            }
            
            // æŒ‰ä¸‹ ESC éµé€€å‡ºç¹ªåœ–æ¨¡å¼
            if (event.key === 'Escape' && drawingMode) {
                 toggleDrawingMode();
            }
        });


    </script>
</body>
</html>


