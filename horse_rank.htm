<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ°´å¢¨å¥”é¨°è¿éŒ¦æ³°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+TC:wght@400;700&display=swap');

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f0f0f0;
            font-family: 'Noto Serif TC', serif;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #fdfbf7;
            background-image: radial-gradient(#e6e6e6 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(253, 251, 247, 0.95);
            z-index: 10;
            text-align: center;
            transition: opacity 0.3s;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        .ink-title {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 5rem; 
            color: #2c2c2c;
            margin: 0 0 20px 0;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .ink-title { font-size: 5.5rem; }
        }

        .ink-char {
            display: inline-block;
            opacity: 0;
            transform-origin: center bottom;
            animation: brush-stroke 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes brush-stroke {
            0% { opacity: 0; transform: scale(1.5) translateY(-10px) rotate(-5deg); filter: blur(8px); }
            60% { opacity: 1; filter: blur(2px); }
            100% { opacity: 1; transform: scale(1) translateY(0) rotate(0deg); filter: blur(0); }
        }

        .ink-char:nth-child(1) { animation-delay: 0.1s; }
        .ink-char:nth-child(2) { animation-delay: 0.25s; }
        .ink-char:nth-child(3) { animation-delay: 0.40s; }
        .ink-char:nth-child(4) { animation-delay: 0.55s; }
        .ink-char:nth-child(5) { animation-delay: 0.70s; }
        .ink-char:nth-child(6) { animation-delay: 0.85s; }
        .ink-char:nth-child(7) { animation-delay: 1.00s; }

        h2 {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 3rem;
            color: #8b0000;
            margin: 10px 0;
        }

        p {
            font-size: 1.2rem;
            color: #4a4a4a;
            margin: 5px 0;
            max-width: 90%;
        }

        .input-group {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 80%;
            max-width: 300px;
            animation: fade-in 0.8s ease-out 1.2s forwards;
            opacity: 0;
        }

        select {
            padding: 10px 15px;
            font-size: 1.2rem;
            font-family: 'Noto Serif TC', serif;
            border: 2px solid #555;
            border-radius: 8px;
            background-color: #fff;
            color: #333;
            outline: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
        }

        select:disabled {
            background-color: #e0e0e0;
            color: #999;
            border-color: #ccc;
        }

        .btn-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            margin-top: 30px;
            opacity: 0;
            animation: fade-in 0.8s ease-out 1.4s forwards;
        }

        .btn {
            padding: 15px 50px;
            font-size: 2rem;
            font-family: 'Ma Shan Zheng', cursive;
            background-color: #8b0000;
            color: #fff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: transform 0.1s;
            min-width: 200px;
        }

        .btn-secondary {
            padding: 10px 30px;
            font-size: 1.5rem;
            font-family: 'Ma Shan Zheng', cursive;
            background-color: #555;
            color: #fff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn:active, .btn-secondary:active {
            transform: scale(0.95);
        }

        .idiom-box {
            background: #fff;
            border: 2px solid #2c2c2c;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 5px 5px 0px #2c2c2c;
        }

        #score-display {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 3.5rem;
            font-family: 'Ma Shan Zheng', cursive;
            color: #2c2c2c;
            z-index: 5;
            pointer-events: none;
            text-shadow: 2px 2px 0px rgba(255, 255, 255, 0.6);
        }

        #player-name-display {
            position: absolute;
            bottom: 30px;
            left: 0;
            width: 100%;
            text-align: center;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 3.5rem; 
            color: #1a1a1a; 
            opacity: 0.85;
            pointer-events: none;
            z-index: 1; 
            text-shadow: 
                2px 2px 0px rgba(220, 220, 220, 0.8), 
                0 0 4px rgba(0,0,0,0.1),
                0 0 10px rgba(0,0,0,0.05);
            animation: breathe 5s ease-in-out infinite;
        }

        @keyframes breathe {
            0% { transform: scale(1); opacity: 0.85; filter: blur(0.5px); }
            50% { transform: scale(1.03); opacity: 1; filter: blur(0px); }
            100% { transform: scale(1); opacity: 0.85; filter: blur(0.5px); }
        }

        .seal {
            position: absolute;
            top: 20px;
            left: 30px;
            width: 80px;
            height: 80px;
            border: 3px solid #8b0000;
            color: #8b0000;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.2rem;
            border-radius: 4px;
            writing-mode: vertical-rl;
            z-index: 5;
            opacity: 0.8;
            pointer-events: none;
            user-select: none;
        }

        #img-status {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 1rem;
            color: #888;
            pointer-events: none;
            text-align: right;
        }

        #leaderboard-layer {
            background: rgba(253, 251, 247, 0.98);
        }

        .leaderboard-container {
            width: 90%;
            max-width: 500px;
            height: 60vh;
            background: #fff;
            border: 3px solid #2c2c2c;
            border-radius: 10px;
            padding: 10px;
            box-shadow: 8px 8px 0px rgba(0,0,0,0.1);
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 2px solid #2c2c2c;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 1.5rem;
            color: #555;
            background: #f0f0f0;
        }

        .leaderboard-item {
            font-family: 'Noto Serif TC', serif;
            font-size: 1.2rem;
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .leaderboard-item:nth-child(even) {
            background-color: #f9f9f9;
        }

        .rank-1 .rank-num { color: #f1c40f; font-size: 1.5rem; text-shadow: 1px 1px 0px #b8860b; }
        .rank-2 .rank-num { color: #95a5a6; font-size: 1.4rem; text-shadow: 1px 1px 0px #7f8c8d; }
        .rank-3 .rank-num { color: #cd7f32; font-size: 1.3rem; text-shadow: 1px 1px 0px #a0522d; }

        .rank-num { font-weight: bold; width: 40px; text-align: center; font-family: 'Ma Shan Zheng', cursive; }
        .rank-name { flex-grow: 1; padding-left: 10px; }
        .rank-score { font-weight: bold; color: #d62828; }

        .clear-btn { background: none; border: none; color: #999; font-size: 0.8rem; margin-top: 5px; cursor: pointer; text-decoration: underline; }

        @media (max-width: 768px) {
            .ink-title { font-size: 2.8rem; }
            h2 { font-size: 2rem; }
            p { font-size: 1rem; }
            .btn { font-size: 1.5rem; padding: 10px 30px; }
            #score-display { font-size: 2.5rem; }
            #player-name-display { font-size: 2rem; bottom: 70px; }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="seal">ä¸­è¯<br>æ–‡åŒ–</div>
        <div id="score-display">è·é›¢: 0 ç±³</div>
        <div id="player-name-display"></div>
        <div id="img-status">åœ–ç‰‡ç‹€æ…‹: æª¢æŸ¥ä¸­...</div>
        <canvas id="gameCanvas"></canvas>

        <div id="start-screen" class="ui-layer">
            <h1 class="ink-title">
                <span class="ink-char">æ°´</span>
                <span class="ink-char">å¢¨</span>
                <span class="ink-char">å¥”</span>
                <span class="ink-char">é¨°</span>
                <span class="ink-char">è¿</span>
                <span class="ink-char">éŒ¦</span>
                <span class="ink-char">æ³°</span>
            </h1>
            
            <div class="input-group">
                <select id="class-select"><option value="" disabled selected>è«‹é¸æ“‡ç­åˆ¥</option></select>
                <select id="student-select" disabled><option value="" disabled selected>è«‹é¸æ“‡å§“å</option></select>
                <select id="bg-select">
                    <option value="" selected>éš¨æ©ŸèƒŒæ™¯ (é è¨­)</option>
                    <option value="sunny">æ™´ç©ºè¬é‡Œ</option>
                    <option value="rain">ç…™é›¨æ¿›æ¿›</option>
                    <option value="snow">å†¬æ—¥é£„é›ª</option>
                    <option value="night">æœˆå¤œæµè¢</option>
                    <option value="autumn">ç§‹é¢¨è½è‘‰</option>
                </select>
            </div>

            <p style="margin-top: 20px;">é»æ“Šç•«é¢æˆ–æŒ‰ç©ºç™½éµè·³èºï¼Œé¿é–‹éšœç¤™ï¼</p>
            <p style="font-size: 1.2rem; color: #d62828; font-weight: bold; margin-top:5px;">ğŸ”¥ æœ€å¾Œ50ç±³æ¥µé™è€ƒé©—</p>
            
            <div class="btn-container">
                <button class="btn" onclick="startGame()">é–‹å§‹å¥”é¦³</button>
                <button class="btn-secondary" onclick="showLeaderboard()">ğŸ† æŸ¥çœ‹æ’è¡Œæ¦œ</button>
            </div>
        </div>

        <div id="end-screen" class="ui-layer hidden">
            <h2 id="end-title">é¦¬åˆ°åŠŸæˆ</h2>
            <p id="end-score">å¥”è·‘è·é›¢ï¼šè¨ˆç®—ä¸­...</p> 
            <div class="idiom-box">
                <strong id="idiom-text" style="font-size: 1.8rem; display:block; margin-bottom:10px;">é¾é¦¬ç²¾ç¥</strong>
                <span id="idiom-desc" style="font-size: 1rem;">å½¢å®¹ç²¾ç¥å¥æ—ºã€å……æ²›ã€‚</span>
            </div>
            <div class="btn-container">
                <button class="btn" onclick="resetGame()">å†ç©ä¸€æ¬¡</button>
                <button class="btn-secondary" onclick="showLeaderboard()">ğŸ† æŸ¥çœ‹æ’è¡Œæ¦œ</button>
            </div>
        </div>

        <div id="leaderboard-layer" class="ui-layer hidden">
            <h2>ğŸ† æ’è¡Œæ¦œ</h2>
            <p style="margin-bottom: 10px;">èª°æ˜¯çœŸæ­£çš„åƒé‡Œé¦¬ï¼Ÿ</p>
            <div class="leaderboard-container">
                <div class="leaderboard-header">
                    <span>æ’å</span>
                    <span>å§“å</span>
                    <span>è·é›¢</span>
                </div>
                <div id="leaderboard-list"><div style='text-align:center; padding:20px; color:#888;'>è¼‰å…¥ä¸­...</div></div>
            </div>
            <button class="btn" onclick="closeLeaderboard()">è¿”å›</button>
            <button class="clear-btn" onclick="clearLeaderboard()">æ¸…é™¤è¨˜éŒ„ (æ•™å¸«ç”¨)</button>
        </div>
    </div>

    <!-- ä¸»è¦éŠæˆ²é‚è¼¯ (æ¨™æº– Scriptï¼Œç¢ºä¿é›¢ç·šå¯ç”¨) -->
    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        let canvasWidth, canvasHeight;
        let groundHeight;
        let isPlaying = false;
        let gameFrame = 0;
        let score = 0;
        let speed = 11; 
        const targetScore = 500;
        let speedMultiplier = 1;
        let rushStage = 0; 
        let finishLine = null; 
        let currentPlayerName = ""; 
        let horse;
        let obstacles = [];
        let particles = [];
        let confettiParticles = [];
        let background;
        let weatherSystem;
        let animationId;
        let spawnTimer = 0;
        let lastTime = 0;

        // é è¨­çš„æœ¬åœ°å„²å­˜ä»‹é¢ (æœƒè¢«é›²ç«¯æ¨¡çµ„è¦†è“‹)
        window.useCloud = false; // æ¨™è¨˜æ˜¯å¦ä½¿ç”¨é›²ç«¯
        window.saveRecordFunc = function(name, distance) {
            let records = JSON.parse(localStorage.getItem('horseGame_leaders') || '[]');
            records.push({ name: name, score: distance, timestamp: new Date().toISOString() });
            records.sort((a, b) => b.score - a.score);
            if(records.length > 50) records = records.slice(0, 50);
            localStorage.setItem('horseGame_leaders', JSON.stringify(records));
        };
        
        window.renderLeaderboard = function(records) {
            const listContainer = document.getElementById('leaderboard-list');
            records.sort((a, b) => b.score - a.score);
            records = records.slice(0, 50);
            let html = "";
            if (records.length === 0) {
                html = "<div style='text-align:center; padding:20px; color:#888;'>æš«ç„¡è¨˜éŒ„</div>";
            } else {
                records.forEach((rec, index) => {
                    let rankClass = "";
                    if (index === 0) rankClass = "rank-1"; if (index === 1) rankClass = "rank-2"; if (index === 2) rankClass = "rank-3";
                    html += `<div class="leaderboard-item ${rankClass}"><span class="rank-num">${index + 1}</span><span class="rank-name">${rec.name || "ç„¡åæ°"}</span><span class="rank-score">${rec.score} ç±³</span></div>`;
                });
            }
            listContainer.innerHTML = html;
        };

        window.showLeaderboardFunc = function() {
            const records = JSON.parse(localStorage.getItem('horseGame_leaders') || '[]');
            window.renderLeaderboard(records);
        };
        
        window.clearLeaderboardFunc = function() {
            localStorage.removeItem('horseGame_leaders');
            alert("å·²æ¸…é™¤æœ¬æ©Ÿè¨˜éŒ„");
            window.renderLeaderboard([]);
        };

        // å­¸ç”Ÿè³‡æ–™
        const studentDB = {
            "1A": ["1 é™³ç†¹é›‹","2 é™³æ„è¡¡","3 é™³å½¥å›","4 é™³æ¥šçš“","5 é™³å½¥ç¾²","6 ä¾¯æ—è²","7 è¨±çš“ç³","8 é»ƒç…œè»’","9 é—œæ—¨è‡","10 åŠ‰å“ç€…","11 åŠ‰ä»²å®‡","12 ç¾…å“ç†™","13 æèŠ¯æ‚¦","14 å‘‚ä¿Šéœ–","15 å‘‚ä»²è»’","16 å³è«¾å…’","17 å½­æ¢“æ‚¦","18 æ–½éˆæº","19 å­«å­è±ª","20 æ›¾ä»¥ä»","21 æ›¹æ­£","22 ç‹å¤©å®‡","23 ç‹æŸè«¾","24 èƒ¡æ‚¦ç¿¹"],
            "1B": ["1 é™³æ›‰ç‘©","2 é™³æ¢“éŸœ","3 é™³æ°¸æ˜‡","4 é™³æ‚…å¿ƒ","5 å¼µå³»çƒ½","6 è”¡å®é‘«","7 æœ±çå–†","8 ä½•å…æ’","9 éŸ“æ¬£ç©","10 å¶å®‡æ’","11 æ±Ÿæ³³ç³","12 é—œæ˜è²","13 é„ºé›ªæ™´","14 åŠ‰èŠŠæ±","15 ç¾…å¾©å¸Œ","16 æä¿Šéœ†","17 æé§","18 æ¢å‡±æ·‡","19 å·«æ’é€¸","20 æŸ¯èŠ·æ™´","21 è˜‡æ™ºæ³“","22 æ›¾é‹­å½¬","23 å°¹æ¢“è¨€","24 èƒ¡æ¢“æ¦£","25 ä¸˜æ–‡åš","26 æœ±é‘ ç©"],
            "1C": ["1 æ­é™½å­æœ—","2 å‘¨æŸæ©‹","3 é„­æµšæ±","4 å¼µæ´›é ¤","5 å¼µå…è¬™","6 æœ±å–„é‹","7 æ´ªæ°¸çƒ","8 è‘‰æ„·æ™´","9 æ±Ÿæ¾¤æ¥·","10 æ±Ÿæ³³å©·","11 éƒ­æ›‰éœ","12 æ—èŠŠç¥","13 åŠ‰å­å„€","14 æå“è«¾","15 ææŸç¿±","16 æ¢å¿ƒå·§","17 æ¢é€¸ç†¹","18 å±é€¸è¾°","19 æ½˜æ‰¿éˆ","20 è•­é›¨å½¤","21 è­šæ„·ç‘¤","22 è­šä¸ç«£","23 ç”°æ™æ½¼","24 ç‹æ¨‚æ¾„","25 é»ƒå­è»’","26 ç‹æ¢“ç„¶","27 è‘‰èŠ·æ™´"],
            "1D": ["1 é™³æŒ¯è»’","2 é™³æ™","3 é™³æŸç†¹","4 é™³å®ä¿¡","5 å¼µçç«¥","6 å‘¨ç¾²å’Œ","7 å¾æœ—ç","8 æ–¹ä¿Šç†¹","9 æ–¹æ¢“å–¬","10 æ±Ÿå¾½","11 éƒ­åˆå˜‰","12 åŠ‰æ·³æµ ","13 æ¢é–å ¯","14 æç¥‰è«¾","15 æ—è©©ç©","16 å»–å¿ƒç‘œ","17 ç›§æ›‰æ€¡","18 é¡å­å–„","19 é„§å…ˆå–»","20 é„§èŠ·çº","21 è¬æ³“æ³°","22 ç«¥è¡å˜‰","23 é»ƒç…¦æ˜¡","24 å³å˜‰é‹­","25 æ¥Šå–„é›¯","26 å§šèŠŠèª"],
            "1E": ["1 é™³å¸Œéœ–","2 é™³æ™ç‘œ","3 é™³å›æ¥­","4 é™³æº°ç³","5 é™³æ˜Ÿå®‡","6 é„­å­æ¦†","7 é¦®æ™ç«¥","8 ä½•é‰¦éœ†","9 è¨±æ­£ç¿¹","10 éƒ­æŸå¸Œ","11 éƒ­æŸå–¬","12 æ—å˜‰æ…§","13 ç¾…æ•èŠ«","14 æ¢å¤©è±ª","15 é€£å°‰ğ§§½","16 ç›§å¿ƒæ€¡","17 å‹ä»¥æ›ˆ","18 è«å½¥åš","19 æ½˜æŸçš“","20 é„§é›¨æ™´","21 è”¡ç«£è»’","22 é»ƒæ™‰è¬™","23 é»ƒè©©æ·‡","24 èƒ¡å‡±è—","25 é¡å˜‰å¸Œ","26 æ¥Šæ¨‚è»’"],
            "2A": ["1 é™³ä¿¡å¸Œ","2 é™³å®¥éŠ˜","3 é„’å˜‰æŸ”","4 é„­é›…ä¹‹","5 å¼µäºˆå¯§","6 é¦®æœ—è¯","7 ä½•æ—»è”š","8 ä½•æ¢“å«£","9 è¨±è‹¥æ¥ ","10 æ—æ·ç„¶","11 æ—é™½æ›¦","12 æå“æ–","13 æ¢æ˜Š","14 æ¢å‡±åªƒ","15 å»–å‡±æ¼©","16 å‹å›å©·","17 é¦¬é‰¦åš","18 ä¼çç„¶","19 è•­ç¥å‘ˆ","20 æ›¾æ©é™¶","21 ç‹ç¥è¾°","22 é»ƒç³å˜‰","23 é»ƒå½¥ç†¹","24 æ¥Šæ—»å½§","25 è‘‰èŠ·è—´"],
            "2B": ["1 é™³é›‹ç¦®","2 é™³æŸéœ–","3 é™³ç‘‹æ¥ ","4 é™³ç©æ¾„","5 é„­çš“æ–‡","6 å¼µå³»åƒ‘","7 éŒ¢çŸè¬™","8 é¾æŒ¯è€€","9 ä½•ç±½é½Š","10 ä½•èŠ·å¥·","11 æ—å…å…’","12 åŠ‰æ˜Ÿå®‡","13 ææ™é›’","14 æèŠ¯æ½","15 æ¢é›…å…’","16 æ¢å¿ƒæ€¡","17 ç›§é–æ–¹","18 éº¥é›…æ·‡","19 å³å®¶è³¢","20 å­«é§éœ–","21 æ›¾å¤¢æ­¡","22 é»ƒæ¢“æœ—","23 è¬æ¨‚æ‡¿","24 åš´æ•ç‘œ","25 ä½™èŠŠæ½¼"],
            "2C": ["1 é™³å®¶åš","2 é™³ä½°åƒ‘","3 é™³æ¥šä¼Š","4 é„­æ‡¿ç¿","5 å¼µèŠ·åƒ‘","6 å¼µæ—¥æ›¦","7 è”¡å­è¨€","8 æœ±æ™‰è³¢","9 æœ±è© çŠ","10 é¾ç¦®è³¢","11 ä¾¯ä½©å…’","12 ç®¡è«¾è³¢","13 éƒ­æ˜Šæ´‹","14 é»å­è¬™","15 åŠ‰æ˜Šå‡","16 åŠ‰æµšé‹","17 æè«¾é ¤","18 æ¢ç‹é›¯","19 æ—æ–°çŠ","20 åŠ‰æ¢“æ½¼","21 å³ç¶½ç€…","22 è­šç´«å¯§","23 ç‹ç¾¨å¦¤","24 é»ƒåº­è¬™","25 é¾æµ©éˆ±"],
            "2D": ["1 å€æ™‰æ¨‘","2 é™³ç€å¸Œ","3 é™³å‡±æ·³","4 é™³é§è³¢","5 å¼µéˆç³","6 é¦®å‡±ç³","7 æ—é›…é›¯","8 æ—è”£æ²‚","9 åŠ‰ç¥æ¾„","10 ç¾…æµ©è¨€","11 ææºµå–¬","12 æ¢æ¾¤ä»","13 æé–é ¤","14 æ—çƒ±çƒ½","15 å‘‚ç¶½ç‘¤","16 æ¯›ç¾¿å·½","17 å³æ†²å³°","18 çŸ³èŠ®éœ–","19 æ›¾ç¦®è³¢","20 ç‹å„’æ‚¦","21 èƒ¡éŒ¦å¤©","22 ç‹æšŸç³","23 èƒ¡æ¢“ç­ ","24 ä¼å½¥æ½®","25 ä½™æ€ç©"],
            "2E": ["1 æ­å¸Œå½¤","2 é™³æ¢“æ˜Š","3 é™³èŠ·ç³","4 å¼µå¸å®‡","5 å¼µç…’å‚‘","6 å¼µæ©åƒ‘","7 è¶™æµ©è»’","8 æˆ´å˜‰ç‘©","9 åš´å´‡ç","10 è‘‰æ–‡æ™","11 é»çˆ¾æ¾„","12 é»çˆ¾è¬™","13 æ¢æ ¢ç¿","14 æä¾å¨œ","15 é€£çã©","16 å·«å€¬é‹’","17 æˆ´æ™ç„¶","18 è­šç«£è»’","19 é„§åº·ç‘¤","20 é»ƒåƒç¿","21 é»ƒå¯¶å„€","22 é»ƒæ¢“è¬™","23 å³å¦¤è«³","24 è‘‰ç¾ç³","25 æœ±æ™¨æ›¦"],
            "3A": ["1 é™³å®¶æ·³","2 å¼µè–¾æ™¨","3 å¼µæ™¯è»’","4 ä½•æ²›éˆ","5 ä½•éŸ»ç€…","6 é—œç¾¨éŒ¤","7 æ—å–„ç‘©","8 ææœ—æ£‹","9 æåº­æ¬£","10 æ¢å¯æ¦†","11 æ—é›…å©·","12 å³æ™ºç›","13 å³æ„·æ©","14 å³è‘‰æ†","15 æ­èˆªç‘‹","16 è˜‡é€¸æœ—","17 æ–½å–„æ–‡","18 å”å©‰å®œ","19 æ›¾å“è¬™","20 é»ƒé Œè¬™","21 ç‹ç…¦éœ–","22 é»ƒè´Šæ®·","23 é»ƒä¸€é™½","24 èƒ¡è“ç¿¹","25 ä½™æ²›å‡"],
            "3B": ["1 é™³æµ å©·","2 é™³çæ–Œ","3 å¼µæ¨¾","4 è”¡æµ·æ¾„","5 å‘¨æœ›èˆ’","6 é„§æ¸²ç©","7 ç†Šæ¢“å–¬","8 é—œè© ç³","9 é»ç†™æ¡","10 æ—æŸå®‡","11 åŠ‰ç€°","12 åŠ‰æŸå¸Œ","13 æ¢èªè»’","14 é¦¬ç†™é›¯","15 å³æ€è¨€","16 å½­æ˜ é›ª","17 æ½˜æœ—æ¥·","18 é»ƒè¦“é¢»","19 é»ƒå°æ´¹","20 é»ƒå¤©ä¿¡","21 ç‹æ¢“è¬™","22 ç‹æ¢“ç©","23 èƒ¡å‡±æ¾„","24 é‚±å½¥æ¥Ÿ","25 è‘‰æ ¢å»·"],
            "3C": ["1 é™³é€¸æœ—","2 å¼µå…åµ","3 èŠé§æº¢","4 é¦®å“è³¢","5 éƒ­ç¿æ·","6 ç°¡èŠ·æ¡","7 æ—å–„æ™´","8 æ—ç´«å ¯","9 åŠ‰ç¿è»’","10 æç¥‰èª¼","11 é€£ä¿¡è¨€","12 å»–æœ›æ­£","13 ç¾…å•Ÿæ™‰","14 è•­æ¢“æ·‡","15 å­«è‹¡æ¾„","16 æ–½éœåµ","17 é„§å…ç„¶","18 æ›¾å¤©ä½‘","19 ç‹ç…¦éœ†","20 é»ƒå®¶ç†™","21 èƒ¡å–„ä¹‹","22 æ¥Šæ¨‚æ˜•","23 è‘‰æ„·æ™´","24 è‘‰è˜Šç‘¤","25 åº¾å‡±èˆ’"],
            "3D": ["1 é™³æ™‰ç‡Š","2 é™³æ€éœ–","3 é¾ä¿Šè³¢","4 æˆ´æ²›éŠ˜","5 ä½•éŸ»å¦","6 é»å…çš“","7 é»æ˜•æ½¼","8 æ—å¿ƒè³¢","9 æç´«ç›ˆ","10 æ¢æ¾¤æ ©","11 æ¢è©©è«¾","12 æ¢åœ“åœ“","13 é€£å®¶æ™´","14 æ—æ™´åµ","15 é™¸ç©ç³","16 é¾å…æ¾„","17 é¡æ²›æ€¡","18 æ½˜æ™¯åº·","19 æ½˜ç¿æ™","20 æ–½æ¾¤ä»","21 æˆ´ç„¯è¨€","22 æœåœ‹ç¶­","23 é»ƒå­ä¿Š","24 æ¥Šé–æ³“","25 æ¥Šå¿ƒè•Š"],
            "3E": ["1 æŸ¥å¥•æ£®","2 é™³è© èŠ¯","3 é™³æ®·éœ†","4 é™³é›¨æ™´","5 å‘¨ç©ç†™","6 é„­èŠ·ç€…","7 å¼µé–”ç¨‹","8 éœæŸå½¥","9 è‘‰äº¦ç¿”","10 é»æ˜•æ¾„","11 åˆ©å“ç¾½","12 æèŠŠæ¾„","13 æ¢å“è¬™","14 æä¿Šè³¢","15 æå‡±æ¾„","16 ç¾…å¾·è”š","17 å³æ³³å§¸","18 æ½˜æ‰¿è€€","19 è­šæ²›æ—","20 é»ƒé Œç„¶","21 èƒ¡æ—»æ…§","22 èƒ¡å˜‰æ¿ ","23 æ¥Šé–","24 é„­é›…äºˆ"],
            "4A": ["1 é™³å“ç‘©","2 é™³ä¿¡ä½‘","3 é™³é–æ¬£","4 é„­å¤šå®","5 å¼µç¶½ç¥","6 æœ±æ²›ç¿¹","7 æ–¹æ¢“æ™´","8 åº·æŸç†™","9 è¨±ç®ç­ ","10 è¨±ç´«æ¡","11 æ´ªé®å ¯","12 ç°¡å¸Œè€Œ","13 æ—æ³³æ¡","14 ææ·½ç¥","15 æå»·ç†™","16 æ¢å®¶æµ ","17 é™¸æ€æ…§","18 æ¢æ¾¤ç›","19 éº¥æ¢“ç³","20 å³å­ç¿","21 æŸ¯æºè²½","22 æ½˜å¥•åŒ¡","23 æ½˜å¥•éœ–","24 æ¹¯æ¢“å³°","25 é»ƒçŸ¥æ©","26 é»ƒæµšéŠ˜","27 å³å©§è¨€","28 å³å©§ç…Š","29 å³æ€åš","30 ä½™å­è³¢","31 è¢æµšç†™"],
            "4B": ["1 é™³å¥•å»·","2 é„­æœ—è»’","3 å¼µæ¸¼å²","4 å¼µå­æµ©","5 è³€è‡´å ¯","6 ä½•æ—»è’‘","7 è¨±çš“æ³“","8 æ—å¥•ä»²","9 æ—ç¥ç‘©","10 åŠ‰æ˜ æ±","11 ç¾…ç‘‹éœ–","12 æç‘‹æ¾„","13 æ¢æ™¯ç†¹","14 æ¢è© æ¬£","15 æ¢æ¼ªæ¡“","16 ææ¨‚æ‡¿","17 æ¢æ©æµ ","18 ç¾…é§æ™´","19 å‘‚æ¸…å¦","20 é¦¬æ˜Šç‡Š","21 æ¹¯é®éŠ˜","22 ç”°æ™æ¨‚","23 å”å˜‰ç¦§","24 å°¹æ¨‚æ©","25 ç‹æ¢“çª","26 ç‹ç†™é›¯","27 ç‹æ±¶åƒ–","28 å³å­æœ—","29 é‚±å®¶æ¨‚","30 é‚±å½¥ç«£","31 æ¥Šå­æ¸˜"],
            "4C": ["1 é™³è¦‹ä¹‹","2 é™³æ¨‚ç†™","3 éŒ¢å·§éœ–","4 è”¡æ¸…å¦","5 è”¡ç„Œè»’","6 å‘¨å½¥å½¤","7 é—œå®—ç","8 å¥šæ¢“éºŸ","9 é„§è«¾æ–‡","10 éƒ­ä¿å½¤","11 è³´è‡³èª ","12 é»ç¥‰æ¨‚","13 æ—åœ‹è¨€","14 ææ˜•ç†¹","15 æ¢æ™å¦","16 æ¢å®‡éœ†","17 å³å“è¨€","18 å³æ²›çŠ","19 è­šå®‰å–¬","20 æ›¾å®‡å“²","21 é»ƒå¯¶è¬™","22 æ¥Šå¿ƒå¦¤","23 æ¥Šç©èŠ¯","24 æ¥Šç¥å®‰"],
            "4D": ["1 é™³ä¿Šå‡±","2 é™³å½¥å½¤","3 é„­ä¸è¶…","4 é„­ç©æ†","5 å¼µæ¦†æ¾„","6 æœ±ä¿Šæœ—","7 æ´ªåŠ›è”­","8 æ—æ³³å½¤","9 åŠ‰èŠ·ç‘¤","10 ææ´‹æ„·","11 æ¢èŠ·æ‚ ","12 è˜‡ä¿Šçš“","13 æ–½æ˜é›…","14 æˆ´ç„¯è«¾","15 è­šæ¥šæ¡","16 æ¹¯è© è³¢","17 æ›¹å­ç¥","18 é»ƒç¸èˆœ","19 é»ƒå¤©åµ","20 é»ƒé€¸ç¿¹","21 æ¥Šæ™Ÿè»’","22 æ¥Šæ™¯åŒ¡","23 é‚¢ç¶­ä¸","24 ç¿å¥•ç³"],
            "4E": ["1 å€ç«£ç","2 é™³å‡±ç®","3 é™³è©©ç©","4 é™³å½¥å¸Œ","5 é„’å®¶è¬™","6 é„­å­è«¾","7 å¼µæµšæ­","8 ä½•æ•å˜‰","9 ç¾…å“è¬™","10 ç›§ä½³çª","11 ä¼å‰åº­","12 æŸ¯éˆè«¾","13 æ½˜è‹±è²´","14 è˜‡å‡±æ½¼","15 è¬å¿ƒå¼¦","16 é»ƒå˜‰æ¬£","17 é»ƒæŸé™¶","18 é»ƒæ¢“æ™´","19 é»ƒå­èª ","20 å³æ€æ©‹"],
            "5A": ["1 é™³é ŒéŒ¡","2 é™³æ·æš","3 é™³æ»¶éŠ˜","4 é™³æ€ç¾½","5 é„­å©¥å¦¤","6 è¶™æ©å½¤","7 æ›¹å­éŒ€","8 è”¡å­ç‘©","9 ä½•æ€é½Š","10 éƒ­éœç‘©","11 éƒ­å¹¸å…’","12 éƒ­å›ç¿","13 æ—è¿ªæ–‡","14 æ¢å“ç„¶","15 æé¡¯æš","16 ææ˜Ÿæ…§","17 ç¾…æ³³é›…","18 ç›§å¦å­œ","19 å‘‚æ´›æ’","20 é¦¬æ›‰æ™´","21 é¦¬æ¢“å´´","22 æ­æ©è²","23 é‚±èŠŠç¾½","24 è­šçŸ¥è¡Œ","25 é„§å¸é‰‰","26 æ›¾é–åµ","27 æ›¾æŸè»’","28 å³é‡‘éºŸ","29 èƒ¡å®šé§±","30 æ¥Šç¥ç‘©","31 ç¿æµšçš“","32 å¼µéŠ˜æ›‰"],
            "5B": ["1 é™³å­æ‚ ","2 å‘¨é›‹å¸Œ","3 é„­å„²é‚¦","4 èŠæµ ç‘©","5 å¤å­å¼˜","6 è³€å­å®¸","7 è¨±å³»ç","8 æ—æµ©è»’","9 æ—å˜‰æ•","10 æå“çˆ","11 æä¿Šé€¸","12 ææœ—é”","13 æå®‡è¬™","14 æåŠ æ•","15 æå…æ·","16 å»–å¹¸å…’","17 åŠ‰å¯å…’","18 å³æœ—ç‘œ","19 ä¼æ…§çŠ","20 å²‘å¯ç¿¹","21 å­«éŠ˜æµ ","22 è­šæ£¨ç‡Š","23 è­šæ‡‰è»’","24 æ›¾æ…¶æ´›","25 é»ƒå“å¦¤","26 é»ƒæ‰¿æ™","27 é»ƒæ¢“æ¬£","28 é»ƒè© å¿ƒ","29 è¢å´‡æ›¦","30 å‘¨æ¢“ç‘œ"],
            "5C": ["1 é™³ç†¹å§¸","2 é™³ç‘‹ç","3 é™³æ˜±éœ–","4 é„­å“²","5 å¼µå˜‰å¦¤","6 é„’å“å–¬","7 é„ºå¯å–¬","8 é»å‡±ç”„","9 é»å­é—","10 æ—æ€å½¤","11 åŠ‰ä½©ç¥º","12 åŠ‰èŠ·è±","13 ææ€ç‘¤","14 ç›§é´»å®‡","15 ç›§æ€ç¾½","16 æ›¾ç€šè³¢","17 å¾ç¾¨å–¬","18 é»ƒç¸å ¯","19 é»ƒèŠ¯è«¾","20 é»ƒç¶­åš","21 é»ƒé›¨æ¡","22 èƒ¡å•“æ¹¸","23 èƒ¡å€©ç‘‹","24 æ¥Šèˆœä¹‹"],
            "5D": ["1 é™³å‡±æ©","2 é™³ç«‹å–¬","3 é™³æ•è»’","4 é™³èŒ‚å‡±","5 é„­å¥•é£›","6 éŒ¢å‡±æ™´","7 è”¡ä¿Šæ·»","8 å‘¨é’é™½","9 å‘¨ç‘è•","10 é¾ç¦®è¬™","11 æˆ´å˜‰ç¦§","12 ä½•é–å–¬","13 ä½•èŠ·æº","14 éƒ­è‡¨","15 æ—å®¶è€Œ","16 æ—å¥éŠ˜","17 æå“ç©","18 æå‡±å®‡","19 é¦¬ç¶½å¬£","20 é¦¬çå‚‘","21 é¦¬æ©æ‚¦","22 è«æ¢“å¦¤","23 å³èŠ·ç›ˆ","24 ä¼æ€å¦","25 è‘‰æ€æœ—","26 æ¥Šè‹¥è±"],
            "5E": ["1 é™³é§¿è±ª","2 é™³èŠæ•","3 å¼µæ€¡ç¦","4 å¼µæ€¡è±","5 è”¡å“ç¿¹","6 æ–¹æ ¢å®‡","7 ç¬¦ç¢©è»’","8 ä½•å®¶ç‘©","9 é»ƒå¥å½¬","10 è¨±æ‚…","11 æ—æ€è¾°","12 æ—ç¦¹è»’","13 ç¾…å©‰ç‘©","14 æç¿Šè¡Œ","15 æ¢å¿ƒç›ˆ","16 æå§µè³¢","17 éº¥ä¿Šä»","18 è­šæš˜éœ–","19 é»ƒæ™‰ç†¹","20 ç‹æ™§æ©","21 é‚±ç‚«æ™º","22 æ¥Šæµ©ç¨‹"],
            "6A": ["1 é™³æ³“ä¿Š","2 é™³æ€æˆ","3 å¼µç¶½è»’","4 å¼µç­±æ”¸","5 ç¨‹é Œå…’","6 å‘¨èŠ·è±","7 å‘¨å­ç¥","8 é¦®æ™ºè­½","9 è¨±æ¨‚åª›","10 è¨±å¿ƒæ·‡","11 æ´ªå·§æ©","12 é¾”å‡æ›ˆ","13 é»é˜æ¾¤","14 è³´å®¶æ•","15 é»å­èŠŠ","16 é»å­è±","17 åŠ‰å¤©æºµ","18 æ¢æ™¨","19 æ¢è© åµ","20 æä¿Šç¦§","21 ææ¨‚æ€¡","22 æ—ç…‡çš“","23 å»–æœ›å“²","24 å³æ‰¿ç†¹","25 æ½˜èŒµå½¤","26 è•­æ¢“è«¾","27 è•­ä»²è¨€","28 æ–½ç€›éˆ","29 é„§æ—¨å³»","30 é»ƒå“æ–‡","31 é»ƒè‹¡å–¬","32 å³å­å›","33 é„­åŠ›ä¸­"],
            "6B": ["1 å€æ°¸æš","2 é™³å®ç‘‹","3 å¼µæµšä¸€","4 å¼µé§¿æœ—","5 å¼µå‡±æ™´","6 å¼µå‡±å–¬","7 å¼µæ¢“æ·³","8 å¼µèŠ·ç†’","9 è”¡å“ä¾–","10 é¾å¸Œå…’","11 æ–¹å¿ƒé ¤","12 ä½•æ²›é™","13 è‘‰æ™¯è»’","14 éƒ­åƒç¬","15 éƒ­å€šå½¤","16 æ—æ¨‚æ©","17 åŠ‰åº·ä½‘","18 ææ›‰ç³","19 æç€šæ³“","20 æ—å¥•æ¾","21 ç¾…ç¸åµ","22 é¾æ´›èœ‚","23 æ›¾æ¢“å‚‘","24 è”¡æ°¸åŒ¡","25 å°¹ä½Ÿæ©","26 é»ƒå¸Œç³","27 é»ƒå¯é ¤","28 é»ƒè´Šè‡£","29 é»ƒå‰ç¿","30 å³ç’Ÿæ‚ "],
            "6C": ["1 é™³é§å»·","2 é™³æ¬£å½¤","3 å‘¨å•Ÿè±ª","4 é„­å‡±æ²‚","5 å¼µæ¢“çƒ½","6 è¶™æ¢“å¸Œ","7 è¶™æ…§å–¬","8 è¨±é¡˜","9 æ—æ±¶é€²","10 ç¾…å˜‰æ‚ ","11 ææ™ºåº­","12 æ¢é›²å§¿","13 æèŠŠæ…§","14 ç¾…æ›¦å©·","15 ä¼å›æ˜Š","16 é„§éˆæœ—","17 é»ƒé§¿ä½‘","18 é»ƒæ€æ¾„","19 å³æ”¿é‹­","20 è¢å‡±éœ–","21 ç¿å¥•ç†™"],
            "6D": ["1 é™³èŠ·ç‘œ","2 å¼µæµ©æš","3 å¼µæ™¨æ›¦","4 å¼µæ˜ æ¾„","5 é„’æœ¬é¨«","6 é¾å³»ç†™","7 æŸ¯ç¹¼ç„¶","8 æ±Ÿä¿Šæ›¦","9 éƒ­ç”¯","10 æ—æ˜±ä¸","11 ææ¹šé ¤","12 æ¢æ–‡æ™","13 ææ‚…æ›¦","14 å‘‚æŸè»’","15 æ²™å©‰å¦‚","16 è­šç´«æ‚¦","17 é„§å®‡æ”¿","18 ä¸å¥æ‚ ","19 è‘£ç©å¤©","20 é»ƒå¥æœ—","21 èƒ¡æµšé´»"],
            "6E": ["1 é™³å€šç›ˆ","2 é™³å®‡è»’","3 é„­ç‘è±","4 å¼µæ™ç‘œ","5 å¼µæ¢“å¸Œ","6 æ—æ›‰å©·","7 æ—æ¢“æ…§","8 ææ‰¿ç¦§","9 æå®¶èˆˆ","10 æ—æ–°æ°","11 é›·æ¢“å¸Œ","12 å³ç¶½é§","13 ç‹é³³è³¢","14 ç‹åœ‹å—","15 é»ƒè‡´è‚‡","16 é»ƒé®ç†™","17 é»ƒæŒ¯åº­","18 æ¥Šå¸Œæ˜•","19 è‘‰å­é€¸"]
        };

        const idioms = [
            { text: "é¦¬åˆ°åŠŸæˆ", desc: "å½¢å®¹äº‹æƒ…é †åˆ©ï¼Œä¸€é–‹å§‹å°±å–å¾—æˆåŠŸã€‚" },
            { text: "é¾é¦¬ç²¾ç¥", desc: "å½¢å®¹ç²¾ç¥å¥æ—ºã€å……æ²›ã€‚" },
            { text: "è€é¦¬è­˜é€”", desc: "æ¯”å–»é–±æ­·å¤šçš„äººå¯Œæœ‰ç¶“é©—ï¼Œç†Ÿæ‚‰æƒ…æ³ï¼Œèƒ½èµ·å¼•å°ä½œç”¨ã€‚" },
            { text: "ä¸€é¦¬ç•¶å…ˆ", desc: "ä½œæˆ°æ™‚ç­–é¦¬è¡é‹’åœ¨å‰ã€‚å½¢å®¹é ˜å…ˆï¼Œå¸¶é ­ã€‚" },
            { text: "è¬é¦¬å¥”é¨°", desc: "è²å‹¢æµ©å¤§æˆ–å ´é¢ç†±çƒˆã€‚" },
            { text: "åƒé‡Œé¦¬", desc: "åŸæŒ‡å–„è·‘çš„é§¿é¦¬ï¼Œå¾Œæ¯”å–»æœ‰æ‰å¹¹çš„äººã€‚" }
        ];

        const classSelect = document.getElementById('class-select');
        const studentSelect = document.getElementById('student-select');
        Object.keys(studentDB).forEach(cls => { const option = document.createElement('option'); option.value = cls; option.innerText = cls; classSelect.appendChild(option); });
        classSelect.addEventListener('change', function() {
            const selectedClass = this.value; studentSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡å§“å</option>';
            if (selectedClass) { studentSelect.disabled = false; studentDB[selectedClass].forEach(stu => { const option = document.createElement('option'); const parts = stu.split(' '); const name = parts.length > 1 ? parts[1] : parts[0]; option.value = name; option.innerText = stu; studentSelect.appendChild(option); }); } else { studentSelect.disabled = true; }
        });

        function resize() { canvasWidth = canvas.width = window.innerWidth; canvasHeight = canvas.height = window.innerHeight; groundHeight = canvasHeight * 0.75; }
        window.addEventListener('resize', resize);
        resize();

        // --- é¡åˆ¥å®šç¾© ---
        class FinishLine {
            constructor() { this.x = canvasWidth; this.y = 0; this.width = 100; this.crossed = false; }
            update() { this.x -= speed * speedMultiplier; }
            draw() { ctx.save(); ctx.beginPath(); ctx.moveTo(this.x, 0); ctx.lineTo(this.x, groundHeight - 150); ctx.lineWidth = 3; ctx.strokeStyle = '#555'; ctx.stroke(); ctx.fillStyle = '#d62828'; ctx.fillRect(this.x - 20, 50, 40, 200); ctx.beginPath(); ctx.moveTo(this.x - 20, 250); ctx.lineTo(this.x, 220); ctx.lineTo(this.x + 20, 250); ctx.lineTo(this.x + 20, 50); ctx.lineTo(this.x - 20, 50); ctx.fill(); ctx.strokeStyle = '#f1c40f'; ctx.lineWidth = 2; ctx.stroke(); ctx.fillStyle = '#fff'; ctx.font = "bold 24px 'Ma Shan Zheng'"; ctx.textAlign = "center"; ctx.fillText("çµ‚", this.x, 100); ctx.fillText("é»", this.x, 140); ctx.beginPath(); ctx.moveTo(this.x, 220); ctx.lineTo(this.x, 280); ctx.lineWidth = 2; ctx.strokeStyle = '#d62828'; ctx.stroke(); ctx.restore(); }
        }
        class Confetti {
            constructor(x, y) { this.x = x; this.y = y; this.size = Math.random() * 10 + 5; this.speedX = Math.random() * 6 - 3; this.speedY = Math.random() * -10 - 5; this.color = `hsl(${Math.random() * 360}, 100%, 50%)`; this.rotation = Math.random() * 360; this.rotationSpeed = Math.random() * 10 - 5; this.gravity = 0.4; }
            update() { this.x += this.speedX; this.speedY += this.gravity; this.y += this.speedY; this.rotation += this.rotationSpeed; }
            draw() { ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.rotation * Math.PI / 180); ctx.fillStyle = this.color; ctx.fillRect(-this.size/2, -this.size/2, this.size, this.size); ctx.restore(); }
        }
        class Particle {
            constructor(x, y) { this.x = x; this.y = y; this.size = Math.random() * 5 + 2; this.speedX = Math.random() * 2 - 1; this.speedY = Math.random() * -1 - 0.5; this.color = `rgba(30, 30, 30, ${Math.random() * 0.4 + 0.1})`; this.markedForDeletion = false; }
            update() { this.x -= speed * speedMultiplier * 0.8; this.x += this.speedX; this.y += this.speedY; this.size *= 0.95; if (this.size < 0.5) this.markedForDeletion = true; }
            draw() { ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); }
        }
        class WeatherParticle {
            constructor(type) {
                this.type = type; this.x = Math.random() * (canvasWidth + 200); this.y = Math.random() * canvasHeight;
                if (type === 'rain') { this.vy = Math.random() * 15 + 15; this.vx = -4; this.length = Math.random() * 20 + 20; } else if (type === 'snow') { this.vy = Math.random() * 3 + 2; this.vx = Math.random() * 2 - 1; this.size = Math.random() * 4 + 2; this.swing = Math.random() * Math.PI * 2; } else if (type === 'autumn') { this.vy = Math.random() * 2 + 1; this.vx = Math.random() * -3 - 2; this.size = Math.random() * 6 + 4; this.rotation = Math.random() * 360; this.rotationSpeed = Math.random() * 4 - 2; const colors = ['rgba(160, 82, 45, 0.8)', 'rgba(205, 92, 92, 0.8)', 'rgba(218, 165, 32, 0.8)']; this.color = colors[Math.floor(Math.random() * colors.length)]; } else if (type === 'night') { this.vx = Math.random() * 2 - 1; this.vy = Math.random() * 2 - 1; this.size = Math.random() * 3 + 1; this.alpha = Math.random(); this.alphaSpeed = 0.02; }
            }
            update() {
                if (this.type === 'night') { this.x += this.vx - (speed * 0.2); this.y += this.vy; this.alpha += this.alphaSpeed; if (this.alpha > 1 || this.alpha < 0.2) this.alphaSpeed *= -1; if (this.x < -50) this.x = canvasWidth + 50; if (this.y < 0) this.y = canvasHeight; if (this.y > canvasHeight) this.y = 0; }
                else { this.y += this.vy; if (this.type === 'snow') { this.swing += 0.05; this.x += Math.sin(this.swing) * 1 + this.vx; this.x -= speed * 0.2; } else if (this.type === 'autumn') { this.x += this.vx; this.rotation += this.rotationSpeed; this.x -= speed * 0.2; } else { this.x += this.vx; this.x -= speed * 0.5; } if (this.y > canvasHeight || this.x < -100) { this.y = -20; this.x = Math.random() * (canvasWidth + 200); } }
            }
            draw() {
                if (this.type === 'rain') { ctx.strokeStyle = 'rgba(120, 130, 140, 0.5)'; ctx.lineWidth = 1.5; ctx.beginPath(); ctx.moveTo(this.x, this.y); ctx.lineTo(this.x + this.vx * 2, this.y + this.length); ctx.stroke(); } else if (this.type === 'snow') { ctx.fillStyle = 'rgba(255, 255, 255, 0.85)'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); } else if (this.type === 'autumn') { ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.rotation * Math.PI / 180); ctx.fillStyle = this.color; ctx.beginPath(); ctx.ellipse(0, 0, this.size, this.size/2, 0, 0, Math.PI*2); ctx.fill(); ctx.restore(); } else if (this.type === 'night') { ctx.fillStyle = `rgba(200, 255, 100, ${this.alpha})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); ctx.fillStyle = `rgba(200, 255, 100, ${this.alpha * 0.3})`; ctx.beginPath(); ctx.arc(this.x, this.y, this.size * 3, 0, Math.PI * 2); ctx.fill(); }
            }
        }
        class WeatherSystem {
            constructor(type) { this.type = type; this.particles = []; if (this.type !== 'sunny') { let count = 50; if (this.type === 'rain') count = 80; if (this.type === 'night') count = 30; if (this.type === 'autumn') count = 40; for(let i=0; i<count; i++) { this.particles.push(new WeatherParticle(this.type)); } } }
            update() { if (this.type === 'sunny') return; this.particles.forEach(p => p.update()); }
            draw() { if (this.type === 'sunny') return; this.particles.forEach(p => p.draw()); }
        }
        class Cloud {
            constructor() { this.x = Math.random() * canvasWidth; this.y = Math.random() * (canvasHeight * 0.4); this.width = Math.random() * 100 + 80; this.speedFactor = Math.random() * 0.2 + 0.1; this.opacity = Math.random() * 0.4 + 0.2; }
            update() { this.x -= speed * speedMultiplier * this.speedFactor; if (this.x + this.width < 0) { this.x = canvasWidth + 50; this.y = Math.random() * (canvasHeight * 0.4); } }
            draw() { ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`; ctx.beginPath(); ctx.arc(this.x, this.y, 30, 0, Math.PI * 2); ctx.arc(this.x + 40, this.y - 10, 40, 0, Math.PI * 2); ctx.arc(this.x + 80, this.y, 30, 0, Math.PI * 2); ctx.fill(); }
        }
        class Bamboo {
            constructor() { this.reset(); }
            reset() { this.x = canvasWidth + Math.random() * 300; this.y = groundHeight + 20; this.height = Math.random() * 200 + 150; this.width = Math.random() * 6 + 4; this.depth = Math.random(); this.speedFactor = 0.5 - (this.depth * 0.2); this.opacity = 0.8 - (this.depth * 0.5); this.leaves = []; let segHeight = 30 + Math.random() * 20; for(let h=50; h<this.height; h+=segHeight) { if(Math.random() > 0.3) { let leafCount = Math.floor(Math.random() * 3) + 2; for(let i=0; i<leafCount; i++) { this.leaves.push({ h: h, angle: (Math.random() * 0.8 - 0.4), length: Math.random() * 25 + 15 }); } } } }
            update() { this.x -= speed * speedMultiplier * this.speedFactor; if (this.x < -50) { this.reset(); } }
            draw() { ctx.save(); ctx.translate(this.x, this.y); ctx.fillStyle = `rgba(45, 60, 45, ${this.opacity})`; ctx.strokeStyle = `rgba(45, 60, 45, ${this.opacity})`; let segHeight = 35; for(let h=0; h<this.height; h+=segHeight) { let localW = this.width - (h/this.height)*2; ctx.fillRect(-localW/2, -h - segHeight, localW, segHeight - 2); ctx.beginPath(); ctx.moveTo(-localW/2 - 2, -h); ctx.lineTo(localW/2 + 2, -h); ctx.lineWidth = 2; ctx.stroke(); } this.leaves.forEach(leaf => { ctx.save(); ctx.translate(0, -leaf.h); ctx.rotate(leaf.angle); ctx.beginPath(); ctx.moveTo(0, 0); ctx.quadraticCurveTo(leaf.length/2, 5, leaf.length, 0); ctx.quadraticCurveTo(leaf.length/2, -5, 0, 0); ctx.fill(); ctx.restore(); }); ctx.restore(); }
        }
        class Bird {
            constructor() { this.reset(); }
            reset() { this.x = canvasWidth + Math.random() * 1000; this.y = Math.random() * (canvasHeight * 0.3) + 20; this.speedX = Math.random() * 2 + 2; this.size = Math.random() * 10 + 10; this.wingSpeed = 0.2; this.angle = 0; }
            update() { this.x -= (speed * 0.5 + this.speedX); this.angle += this.wingSpeed; if(this.x < -50) this.reset(); }
            draw() { ctx.save(); ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.translate(this.x, this.y); ctx.beginPath(); let wingY = Math.sin(this.angle) * 5; ctx.moveTo(-this.size/2, -wingY); ctx.quadraticCurveTo(0, 5, this.size/2, -wingY); ctx.stroke(); ctx.restore(); }
        }
        class Background {
            constructor() { this.mountains = []; let currentX = 0; while (currentX < canvasWidth + 500) { this.addMountain(currentX); let lastM = this.mountains[this.mountains.length - 1]; currentX = lastM.x + lastM.width - 100; } this.clouds = []; for(let i=0; i<5; i++) this.clouds.push(new Cloud()); this.bamboos = []; for(let i=0; i<12; i++) this.bamboos.push(new Bamboo()); this.birds = []; for(let i=0; i<3; i++) this.birds.push(new Bird()); }
            addMountain(xOffset) { this.mountains.push({ x: xOffset, y: groundHeight, width: Math.random() * 300 + 200, height: Math.random() * 150 + 80, opacity: Math.random() * 0.2 + 0.05 }); }
            update() { this.clouds.forEach(c => c.update()); this.mountains.forEach(m => { m.x -= speed * speedMultiplier * 0.2; }); if (this.mountains.length > 0 && this.mountains[0].x + this.mountains[0].width < -100) { this.mountains.shift(); } let lastM = this.mountains[this.mountains.length - 1]; if (lastM.x + lastM.width < canvasWidth + 500) { this.addMountain(lastM.x + lastM.width - 100); } this.bamboos.sort((a, b) => a.depth - b.depth); this.bamboos.forEach(b => b.update()); this.birds.forEach(b => b.update()); }
            draw() {
                if (weatherSystem.type === 'rain') ctx.fillStyle = '#cfd3d6'; else if (weatherSystem.type === 'snow') ctx.fillStyle = '#dbe4eb'; else if (weatherSystem.type === 'night') ctx.fillStyle = '#7f8fa6'; else if (weatherSystem.type === 'autumn') ctx.fillStyle = '#fdf5e6'; else ctx.fillStyle = '#fdfbf7';
                ctx.fillRect(0, 0, canvasWidth, groundHeight);
                if (weatherSystem.type === 'night') { ctx.fillStyle = '#fdfbf7'; ctx.beginPath(); ctx.arc(canvasWidth * 0.8, canvasHeight * 0.2, 30, 0, Math.PI*2); ctx.fill(); ctx.fillStyle = 'rgba(255, 255, 255, 0.1)'; ctx.beginPath(); ctx.arc(canvasWidth * 0.8, canvasHeight * 0.2, 45, 0, Math.PI*2); ctx.fill(); } else if (weatherSystem.type !== 'rain') { if (weatherSystem.type === 'autumn') ctx.fillStyle = '#e17055'; else ctx.fillStyle = '#b33939'; ctx.beginPath(); ctx.arc(canvasWidth * 0.8, canvasHeight * 0.2, 40, 0, Math.PI*2); ctx.fill(); }
                this.clouds.forEach(c => c.draw()); this.mountains.forEach(m => { if (weatherSystem.type === 'night') ctx.fillStyle = `rgba(20, 30, 40, ${m.opacity + 0.2})`; else ctx.fillStyle = `rgba(100, 100, 100, ${m.opacity})`; ctx.beginPath(); ctx.moveTo(m.x, m.y); ctx.bezierCurveTo(m.x + m.width/3, m.y - m.height, m.x + m.width*0.6, m.y - m.height/2, m.x + m.width, m.y); ctx.fill(); });
                this.bamboos.forEach(b => b.draw()); this.birds.forEach(b => b.draw());
                ctx.beginPath(); ctx.rect(0, groundHeight, canvasWidth, canvasHeight - groundHeight); if (weatherSystem.type === 'night') ctx.fillStyle = '#95a5a6'; else ctx.fillStyle = '#e8e6e1'; ctx.fill();
                ctx.beginPath(); ctx.moveTo(0, groundHeight); ctx.lineTo(canvasWidth, groundHeight); ctx.strokeStyle = '#555'; ctx.lineWidth = 2; ctx.stroke();
            }
        }
        class Horse {
            constructor() {
                this.scale = 0.6; this.width = 120 * this.scale; this.height = 100 * this.scale; this.x = canvasWidth * 0.15; this.y = groundHeight - this.height; this.vy = 0; this.weight = 2.5; this.jumpStrength = -28; this.isJumping = false; this.frame = 0;
                this.useImage = false; this.runImg1 = new Image(); this.runImg2 = new Image(); this.jumpImg = new Image(); this.runImg1.src = 'horse_run1.png'; this.runImg2.src = 'horse_run2.png'; this.jumpImg.src = 'horse_jump.png';
                const checkLoad = () => this.checkImages(); const handleError = () => { this.useImage = false; let statusDiv = document.getElementById('img-status'); if(statusDiv) statusDiv.innerText = "åœ–ç‰‡ç¼ºå¤±æˆ–éŒ¯èª¤ï¼Œä½¿ç”¨æ‰‹ç¹ªæ¨¡å¼"; };
                this.runImg1.onload = checkLoad; this.runImg2.onload = checkLoad; this.jumpImg.onload = checkLoad; this.runImg1.onerror = handleError; this.runImg2.onerror = handleError; this.jumpImg.onerror = handleError;
            }
            checkImages() { if (this.runImg1.complete && this.runImg1.naturalWidth > 0 && this.runImg2.complete && this.runImg2.naturalWidth > 0 && this.jumpImg.complete && this.jumpImg.naturalWidth > 0) { this.useImage = true; let statusDiv = document.getElementById('img-status'); if(statusDiv) statusDiv.innerText = "åœ–ç‰‡åŠ è¼‰æˆåŠŸï¼(å‹•ç•«æ¨¡å¼)"; } }
            update() { this.vy += this.weight; this.y += this.vy; if (this.y > groundHeight - this.height) { this.y = groundHeight - this.height; this.vy = 0; this.isJumping = false; } this.frame++; }
            draw() {
                if (this.useImage) { try { ctx.save(); let currentImg; if (this.isJumping) { currentImg = this.jumpImg; } else { currentImg = (Math.floor(this.frame / 6) % 2 === 0) ? this.runImg1 : this.runImg2; } if (currentImg && currentImg.width > 0) { let drawW = 150; let drawH = 150 * (currentImg.height / currentImg.width); if (!isFinite(drawH)) drawH = 100; let drawY = this.y - 30; let bounce = this.isJumping ? 0 : Math.sin(this.frame * 0.8) * 3; ctx.drawImage(currentImg, this.x, drawY + bounce, drawW, drawH); } else { this.drawVectorHorse(); } ctx.restore(); } catch (e) { this.useImage = false; this.drawVectorHorse(); } } else { this.drawVectorHorse(); }
            }
            drawVectorHorse() {
                ctx.save(); ctx.translate(this.x, this.y); ctx.scale(this.scale, this.scale); ctx.fillStyle = '#050505'; ctx.strokeStyle = '#050505'; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                const t = this.frame * 0.5; let swing = Math.sin(t); let swing2 = Math.sin(t + Math.PI); if (this.isJumping) { swing = -1; swing2 = -0.5; }
                ctx.beginPath(); ctx.moveTo(130, 30); ctx.quadraticCurveTo(110, 50, 90, 60); ctx.quadraticCurveTo(70, 90, 50, 80); ctx.lineTo(20, 75); ctx.quadraticCurveTo(0, 75, 5, 50); ctx.quadraticCurveTo(10, 30, 40, 35); ctx.quadraticCurveTo(60, 40, 80, 25); ctx.quadraticCurveTo(100, 0, 120, 10); ctx.lineTo(130, 15); ctx.closePath(); ctx.fill(); ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(90, 15); ctx.quadraticCurveTo(100, 5, 110, -5); ctx.moveTo(85, 20); ctx.quadraticCurveTo(90, 0, 95, -10); ctx.moveTo(80, 25); ctx.quadraticCurveTo(75, 10, 70, 0); ctx.stroke(); ctx.lineWidth = 6; ctx.beginPath(); ctx.moveTo(10, 40); let tailY = this.isJumping ? -20 : Math.sin(t) * 10; ctx.bezierCurveTo(-20, 30 + tailY, -30, 60 + tailY, -40, 50 + tailY); ctx.stroke(); this.drawBrushLeg(10, 70, swing2, true); this.drawBrushLeg(80, 75, swing, true); ctx.fillStyle = '#050505'; ctx.beginPath(); ctx.ellipse(50, 60, 40, 25, 0, 0, Math.PI*2); ctx.fill(); this.drawBrushLeg(15, 75, swing, false); this.drawBrushLeg(85, 80, swing2, false); ctx.restore();
            }
            drawBrushLeg(x, y, swing, isFar) { ctx.lineWidth = isFar ? 6 : 8; ctx.strokeStyle = isFar ? '#2a2a2a' : '#000'; ctx.beginPath(); ctx.moveTo(x, y); let kneeX = x + swing * 20; let kneeY = y + 30; if (this.isJumping) { kneeY = y + 20; if(x > 50) { kneeX = x + 30; } else { kneeX = x - 10; } } let footX = kneeX + (swing * 15); let footY = kneeY + 30; ctx.quadraticCurveTo(x - 5, y + 15, kneeX, kneeY); ctx.stroke(); ctx.lineWidth = isFar ? 4 : 5; ctx.beginPath(); ctx.moveTo(kneeX, kneeY); ctx.lineTo(footX, footY); ctx.stroke(); }
            jump() {
                if (!this.isJumping) { this.vy = this.jumpStrength; this.isJumping = true; try { playTone(400, 'triangle'); } catch(e) {} for(let i=0; i<8; i++) { particles.push(new Particle(this.x + 50, this.y + this.height)); } }
            }
        }
        class Obstacle {
            constructor() {
                this.width = Math.random() * 30 + 30; let currentDist = Math.floor(score/5);
                if (currentDist >= 450) { this.height = Math.random() * 30 + 50; this.width = Math.random() * 40 + 50; } else { this.height = Math.random() * 25 + 25; }
                this.x = canvasWidth; this.y = groundHeight - this.height; this.markedForDeletion = false; this.type = Math.random() > 0.6 ? 'rock' : 'bush';
            }
            update() { this.x -= speed * speedMultiplier; if (this.x < -this.width) this.markedForDeletion = true; }
            draw() {
                ctx.fillStyle = '#2d2d2d';
                if (this.type === 'rock') { ctx.beginPath(); ctx.moveTo(this.x, this.y + this.height); ctx.lineTo(this.x + 10, this.y + 10); ctx.lineTo(this.x + this.width / 2, this.y); ctx.lineTo(this.x + this.width - 5, this.y + 15); ctx.lineTo(this.x + this.width, this.y + this.height); ctx.fill(); ctx.strokeStyle = '#000'; ctx.lineWidth = 1; ctx.beginPath(); ctx.moveTo(this.x + 10, this.y + this.height); ctx.lineTo(this.x + 20, this.y + 20); ctx.stroke(); } else { ctx.beginPath(); ctx.arc(this.x + this.width/2, this.y + this.height, this.width/2, Math.PI, 0); ctx.fill(); ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(this.x + 10, this.y + this.height - 10, 5, 0, Math.PI*2); ctx.arc(this.x + this.width - 10, this.y + this.height - 5, 4, 0, Math.PI*2); ctx.fill(); }
            }
        }

        function playTone(freq, type) { try { if (audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); } catch (e) { console.warn("Audio error", e); } }
        function playWinSound() { setTimeout(() => playTone(400, 'sine'), 0); setTimeout(() => playTone(500, 'sine'), 200); setTimeout(() => playTone(800, 'sine'), 400); }
        function playFailSound() { setTimeout(() => playTone(200, 'sawtooth'), 0); setTimeout(() => playTone(150, 'sawtooth'), 300); }

        function initGame(forceType) {
            horse = new Horse(); obstacles = []; particles = []; confettiParticles = []; score = 0; speedMultiplier = 1; gameFrame = 0; spawnTimer = 0; rushStage = 0; finishLine = null;
            let statusDiv = document.getElementById('img-status'); if(statusDiv) { statusDiv.innerText = "åœ–ç‰‡ç‹€æ…‹: æª¢æŸ¥ä¸­..."; statusDiv.style.color = "#888"; statusDiv.style.fontWeight = "normal"; statusDiv.style.textShadow = "none"; }
            let type = forceType; if (!type || type === 'random') { const weathers = ['sunny', 'rain', 'snow', 'night', 'autumn']; type = weathers[Math.floor(Math.random() * weathers.length)]; }
            weatherSystem = new WeatherSystem(type); background = new Background(); if(horse.checkImages) horse.checkImages();
        }
        window.initGame = initGame;

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const classSelect = document.getElementById('class-select'); const studentSelect = document.getElementById('student-select'); const bgSelect = document.getElementById('bg-select');
            const selectedClass = classSelect.value; const selectedName = studentSelect.value; const selectedBg = bgSelect.value;
            if (selectedClass && selectedName) { currentPlayerName = selectedClass + " " + selectedName; } else { currentPlayerName = ""; }
            document.getElementById('player-name-display').innerText = currentPlayerName;
            classSelect.blur(); studentSelect.blur(); bgSelect.blur(); if (document.activeElement instanceof HTMLElement) document.activeElement.blur();
            document.getElementById('start-screen').classList.add('hidden'); document.getElementById('end-screen').classList.add('hidden');
            initGame(selectedBg); isPlaying = true; lastTime = 0; animate(0);
        }
        window.startGame = startGame;

        function resetGame() { if (document.activeElement instanceof HTMLElement) document.activeElement.blur(); document.getElementById('end-screen').classList.add('hidden'); document.getElementById('player-name-display').innerText = ""; document.getElementById('start-screen').classList.remove('hidden'); }
        window.resetGame = resetGame;

        function animate(timeStamp) {
            try {
                const deltaTime = timeStamp - lastTime; lastTime = timeStamp; if (!isPlaying) return;
                let currentDist = Math.floor(score/5); let shakeX = 0; let shakeY = 0; if (currentDist >= 450) { shakeX = Math.random() * 3 - 1.5; shakeY = Math.random() * 3 - 1.5; }
                ctx.clearRect(0, 0, canvasWidth, canvasHeight); ctx.save(); ctx.translate(shakeX, shakeY);
                background.update(); background.draw();
                if (currentDist >= targetScore && !finishLine) { finishLine = new FinishLine(); }
                if (finishLine) {
                    finishLine.update(); finishLine.draw();
                    if (!finishLine.crossed && horse.x > finishLine.x) { finishLine.crossed = true; for(let i=0; i<50; i++) { confettiParticles.push(new Confetti(horse.x + 50, horse.y)); } setTimeout(() => gameOver(true), 500); }
                } else {
                    spawnTimer--; if (spawnTimer <= 0) {
                        obstacles.push(new Obstacle()); let minGap, variance;
                        if (currentDist >= 450) { if (rushStage < 2) { rushStage = 2; let statusDiv = document.getElementById('img-status'); if(statusDiv) { statusDiv.innerText = "âš¡ï¸ æœ€å¾Œ50ç±³ï¼æ¥µé™åæ‡‰ï¼"; statusDiv.style.color = "#9b59b6"; statusDiv.style.fontWeight = "bold"; statusDiv.style.fontSize = "2rem"; statusDiv.style.textShadow = "0px 0px 10px #fff"; } } minGap = 22; variance = 30; } 
                        else if (currentDist >= 400) { if (rushStage < 1) { rushStage = 1; let statusDiv = document.getElementById('img-status'); if(statusDiv) { statusDiv.innerText = "ğŸ”¥ æœ€å¾Œè¡åˆºï¼å°å¿ƒéšœç¤™ï¼"; statusDiv.style.color = "#d62828"; statusDiv.style.fontWeight = "bold"; statusDiv.style.fontSize = "2rem"; } } minGap = 28; variance = 10; } 
                        else { let difficultyReduce = Math.min(score * 0.01, 15); minGap = Math.max(30, 40 - difficultyReduce); variance = Math.max(15, 30 - difficultyReduce); }
                        spawnTimer = Math.random() * variance + minGap;
                    }
                }
                for (let i = 0; i < obstacles.length; i++) {
                    let obs = obstacles[i]; obs.update(); obs.draw();
                    let hitX = horse.x + 30; let hitY = horse.y + 20; let hitW = Math.max(10, horse.width - 60); let hitH = Math.max(10, horse.height - 35);
                    if (hitX < obs.x + obs.width && hitX + hitW > obs.x && hitY < obs.y + obs.height && hitY + hitH > obs.y) { gameOver(false); return; }
                }
                obstacles = obstacles.filter(obs => !obs.markedForDeletion);
                confettiParticles.forEach(p => { p.update(); p.draw(); });
                if (!finishLine || !finishLine.crossed) { if (!horse.isJumping && gameFrame % 6 === 0) { particles.push(new Particle(horse.x + 40, horse.y + horse.height)); } }
                particles.forEach(p => { p.update(); p.draw(); }); particles = particles.filter(p => !p.markedForDeletion);
                horse.update(); horse.draw(); weatherSystem.update(); weatherSystem.draw(); ctx.restore();
                if (isPlaying) { score++; }
                currentDist = Math.floor(score/5); let displayDist = Math.min(currentDist, targetScore); document.getElementById('score-display').innerText = `è·é›¢: ${displayDist} ç±³`;
                speedMultiplier = 1 + (score * 0.001); if (currentDist >= 450) { let turbulence = 1.3 + Math.sin(gameFrame * 0.15) * 0.15; speedMultiplier *= turbulence; }
                gameFrame++; animationId = requestAnimationFrame(animate);
            } catch (e) { console.error("Game loop crash:", e); isPlaying = false; }
        }

        function gameOver(isWin) {
            isPlaying = false; cancelAnimationFrame(animationId);
            const endScreen = document.getElementById('end-screen'); const title = document.getElementById('end-title'); const scoreText = document.getElementById('end-score'); const idiomText = document.getElementById('idiom-text'); const idiomDesc = document.getElementById('idiom-desc');
            endScreen.classList.remove('hidden');
            let finalScore = Math.floor(score/5);
            if (isWin) {
                title.innerText = "é¦¬åˆ°åŠŸæˆï¼"; title.style.color = "#d62828";
                if (currentPlayerName) { scoreText.innerText = `æ­å–œ ${currentPlayerName} åˆ°é”äº† ${targetScore} ç±³çµ‚é»ï¼`; if(window.saveRecord) window.saveRecord(currentPlayerName, targetScore); } else { scoreText.innerText = `æ­å–œä½ åˆ°é”äº† ${targetScore} ç±³çµ‚é»ï¼`; }
                playWinSound();
            } else {
                title.innerText = "å†æ¥å†å²"; title.style.color = "#555";
                let displayScore = Math.min(finalScore, targetScore);
                if(currentPlayerName && finalScore > 0) { if(window.saveRecord) window.saveRecord(currentPlayerName, finalScore); }
                if (currentPlayerName) { scoreText.innerText = `${currentPlayerName} æœ¬æ¬¡å¥”è·‘è·é›¢ï¼š${displayScore} ç±³`; } else { scoreText.innerText = `æœ¬æ¬¡å¥”è·‘è·é›¢ï¼š${displayScore} ç±³`; }
                playFailSound();
            }
            try { const randomIdiom = idioms[Math.floor(Math.random() * idioms.length)]; idiomText.innerText = randomIdiom.text; idiomDesc.innerText = randomIdiom.desc; } catch(e) {}
        }

        function handleInput(e) {
            if (e.code === 'Space' || e.key === ' ') e.preventDefault();
            if (e.type === 'touchstart' && isPlaying) e.preventDefault();
            if (e.code === 'Space' || e.key === ' ' || e.type === 'touchstart' || e.type === 'mousedown') {
                if (isPlaying) { horse.jump(); } else { if (!document.getElementById('end-screen').classList.contains('hidden') && (e.code === 'Space' || e.key === ' ')) { resetGame(); } }
            }
        }
        window.addEventListener('keydown', handleInput); window.addEventListener('touchstart', handleInput, {passive: false}); window.addEventListener('mousedown', handleInput);

        // é è¨­æœ¬åœ°å„²å­˜
        window.saveRecord = function(name, distance) {
            let records = JSON.parse(localStorage.getItem('horseGame_leaders') || '[]');
            records.push({ name: name, score: distance, timestamp: new Date().toISOString() });
            records.sort((a, b) => b.score - a.score); if(records.length > 50) records = records.slice(0, 50);
            localStorage.setItem('horseGame_leaders', JSON.stringify(records));
        };
        window.renderLeaderboard = function(records) {
            const listContainer = document.getElementById('leaderboard-list'); records.sort((a, b) => b.score - a.score); records = records.slice(0, 50);
            let html = ""; if (records.length === 0) html = "<div style='text-align:center; padding:20px; color:#888;'>æš«ç„¡è¨˜éŒ„</div>";
            else { records.forEach((rec, index) => { let rankClass = ""; if (index === 0) rankClass = "rank-1"; if (index === 1) rankClass = "rank-2"; if (index === 2) rankClass = "rank-3"; html += `<div class="leaderboard-item ${rankClass}"><span class="rank-num">${index + 1}</span><span class="rank-name">${rec.name || "ç„¡åæ°"}</span><span class="rank-score">${rec.score} ç±³</span></div>`; }); }
            listContainer.innerHTML = html;
        };
        window.showLeaderboard = function() { const records = JSON.parse(localStorage.getItem('horseGame_leaders') || '[]'); window.renderLeaderboard(records); document.getElementById('leaderboard-layer').classList.remove('hidden'); };
        window.closeLeaderboard = function() { document.getElementById('leaderboard-layer').classList.add('hidden'); };
        window.clearLeaderboard = function() { if(confirm("ç¢ºå®šè¦æ¸…é™¤æœ¬æ©Ÿè¨˜éŒ„å—ï¼Ÿ")) { localStorage.removeItem('horseGame_leaders'); alert("å·²æ¸…é™¤"); window.renderLeaderboard([]); } };

    </script>

    <!-- é›²ç«¯æ¨¡çµ„ (æ¼¸é€²å¢å¼·) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const userFirebaseConfig = { apiKey: "AIzaSyCdXs8koAE6yHcFlpn_AUwd-CVIra_JHeI", authDomain: "horse-953b3.firebaseapp.com", projectId: "horse-953b3", storageBucket: "horse-953b3.firebasestorage.app", messagingSenderId: "544698080960", appId: "1:544698080960:web:6da549f79dadcc4ca8d725", measurementId: "G-THQY7C7JKF" };

        try {
            let config = userFirebaseConfig;
            if (typeof __firebase_config !== 'undefined') config = JSON.parse(__firebase_config);
            const app = initializeApp(config);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            let currentUser = null;
            let unsubscribeLeaderboard = null;

            (async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                    else await signInAnonymously(auth);
                } catch(e) { console.warn("Auth error", e); }
            })();

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    console.log("Cloud Mode Activated");
                    
                    // è¦†å¯«ç‚ºé›²ç«¯ç‰ˆæœ¬
                    window.saveRecord = async function(name, distance) {
                        try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), { name: name, score: distance, timestamp: new Date().toISOString() }); }
                        catch (e) { console.error("Cloud save failed", e); }
                    };
                    
                    window.showLeaderboard = function() {
                        document.getElementById('leaderboard-layer').classList.remove('hidden');
                        document.getElementById('leaderboard-list').innerHTML = "<div style='text-align:center; padding:20px; color:#888;'>è¼‰å…¥ä¸­...</div>";
                        if (unsubscribeLeaderboard) unsubscribeLeaderboard();
                        unsubscribeLeaderboard = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'), (snapshot) => {
                            let records = []; snapshot.forEach(doc => records.push(doc.data())); window.renderLeaderboard(records);
                        }, (error) => {
                            console.error("Cloud load failed", error);
                            // Fallback to local
                            const records = JSON.parse(localStorage.getItem('horseGame_leaders') || '[]'); window.renderLeaderboard(records);
                        });
                    };

                    window.closeLeaderboard = function() {
                        document.getElementById('leaderboard-layer').classList.add('hidden');
                        if (unsubscribeLeaderboard) { unsubscribeLeaderboard(); unsubscribeLeaderboard = null; }
                    };

                    window.clearLeaderboard = async function() {
                        if(confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰é›²ç«¯è¨˜éŒ„å—ï¼Ÿ")) {
                            try {
                                const snapshot = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard'));
                                const promises = snapshot.docs.map(docSnap => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', docSnap.id)));
                                await Promise.all(promises); alert("é›²ç«¯è¨˜éŒ„å·²æ¸…é™¤");
                            } catch(e) { alert("æ¸…é™¤å¤±æ•—"); }
                        }
                    };
                }
            });
        } catch (e) { console.warn("Cloud init failed, staying local."); }
    </script>
</body>
</html>